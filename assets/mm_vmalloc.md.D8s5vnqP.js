import{_ as a,c as i,o as n,al as l}from"./chunks/framework.CdzZEkix.js";const o=JSON.parse('{"title":"vmalloc: 不连续物理内存分配与 vmap","description":"vmalloc 和 vmap 代码分析，演进历史","frontmatter":{"description":"vmalloc 和 vmap 代码分析，演进历史","head":[["meta",{"name":"keywords","content":"vmalloc, vmap, kernel, 内存分配"}],["meta",{"property":"og:title","content":"vmalloc: 不连续物理内存分配与 vmap | Blog"}]]},"headers":[],"relativePath":"mm/vmalloc.md","filePath":"mm/vmalloc.md","lastUpdated":1763912647000}'),p={name:"mm/vmalloc.md"};function e(t,s,h,r,k,d){return n(),i("div",null,[...s[0]||(s[0]=[l(`<h1 id="vmalloc-不连续物理内存分配与-vmap" tabindex="-1">vmalloc: 不连续物理内存分配与 vmap <a class="header-anchor" href="#vmalloc-不连续物理内存分配与-vmap" aria-label="Permalink to “vmalloc: 不连续物理内存分配与 vmap”">​</a></h1><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to “参考”">​</a></h2><ul><li><a href="https://www.cnblogs.com/LoyenWang/p/11965787.html" target="_blank" rel="noreferrer">【原创】（十二）Linux 内存管理之 vmap 与 vmalloc - LoyenWang - 博客园</a></li><li><a href="https://www.cnblogs.com/arnoldlu/p/8251333.html" target="_blank" rel="noreferrer">Linux 内存管理 (6)vmalloc - ArnoldLu - 博客园</a></li></ul><h2 id="概览" tabindex="-1">概览 <a class="header-anchor" href="#概览" aria-label="Permalink to “概览”">​</a></h2><p>vmalloc 的核心是在 vmalloc 区域中找到合适的 hole，hole 是虚拟地址连续的；然后逐页分配内存来从物理上填充 hole。</p><p>vmalloc 的 gfp_maks 和逐页分配就决定了它的属性：</p><ul><li>可能睡眠：不能从中断上下文中调用，或其他不允许阻塞情况下调用。</li><li>虚拟地址连续：要建立页表，开销比 kmalloc 大</li><li>物理地址不连续：要多次分配页面，开销比 kmalloc 大</li><li>size 对齐到页：不适合小内存分配</li></ul><p>分配得到的虚拟地址在<a href="./layout">虚拟地址空间布局</a>中的“vmalloc/ioremap space”区域，<code>[ffffc90000000000, ffffe8ffffffffff]</code> 32 TB。</p><p><strong>关键流程</strong></p><ol><li>在 vmalloc/ioremap space 区域分配一个连续虚拟地址空间</li><li>从 Buddy System 多次分配 order 为 0 的页面，这些页面不连续。</li><li>通过 vmap 机制，连续的虚拟地址映射到不连续的物理页面。</li></ol><h2 id="vmap" tabindex="-1">vmap <a class="header-anchor" href="#vmap" aria-label="Permalink to “vmap”">​</a></h2><p>vmalloc 基于 vmap，先来介绍 vmap。</p><p>在内核的的 vmalloc 区域中，选取一段连续的虚拟地址区域，映射到 page 数组代表的不连续物理页面，返回虚拟地址。</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> page</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> **</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pgprot_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> prot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="vmap-应用场景" tabindex="-1">vmap 应用场景 <a class="header-anchor" href="#vmap-应用场景" aria-label="Permalink to “vmap 应用场景”">​</a></h3><ol><li><p>per_cpu 的 hardirq stack</p><p>代码路径：<code>start_kernel-&gt;init_IRQ-&gt;irq_init_percpu_irqstack-&gt;map_irq_stack</code></p></li><li><p>dma-buf。</p><p>详见 <a href="./dma_buf">dma-buf</a></p></li></ol><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bpftrace</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;kfunc:vmlinux:__vmalloc_node_range_noprof  { @[kstack] = count(); }&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@[</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bpf_prog_6deef7357e7b4530_sd_fw_ingress+6685</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bpf_prog_6deef7357e7b4530_sd_fw_ingress+6685</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bpf_trampoline_6442530470+111</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    __vmalloc_node_range_noprof+9</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # dup_task_struct alloc_thread_stack_node</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    copy_process+3049</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    kernel_clone+189</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    __do_sys_clone3+228</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    do_syscall_64+130</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    entry_SYSCALL_64_after_hwframe+118</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]: 35</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="数据结构" tabindex="-1">数据结构 <a class="header-anchor" href="#数据结构" aria-label="Permalink to “数据结构”">​</a></h3><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LIST_HEAD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(free_vmap_area_list);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 空闲的未被使用的 vmalloc 区域 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rb_root</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> free_vmap_area_root </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RB_ROOT;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 用于描述一段虚拟地址的区域 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vmap_area</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> va_start;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> va_end;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* 属于以下 3 个红黑树之一：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   - free_vmap_area_root。表明未被使用的区域。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   - vmap_node 的 busy。表明已被分配，正在被使用</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   - vmap_node 的 lazy。表明该区域未被使用，处于正在 lazy 释放的阶段。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rb_node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rb_node;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* 同 rb_node，属于 3 个链表之一，free_vmap_area_list、busy、lazy */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> list_head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	union</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> subtree_max_size;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vm_struct</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vm;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* 指向一个 vm_struct 单向链表 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	};</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* mark type of vm_map_ram area */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 管理虚拟地址和物理页之间的关系 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vm_struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vm_struct</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">next;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		/* XXX 串成一个单向链表，干啥的？ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">addr;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		size;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		flags;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> page</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pages;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#ifdef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CONFIG_HAVE_ARCH_HUGE_VMALLOC</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		page_order;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#endif</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		nr_pages;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	phys_addr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		phys_addr;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">caller;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 该结构体用于大锁化小锁，降低锁争用，后文会分析 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vmap_node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* Simple size segregated storage. */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vmap_pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool[MAX_VA_SIZE_PAGES];</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	spinlock_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool_lock;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> skip_populate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* 已经被分配，正在被使用的 vmap_area */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rb_list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> busy;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* vunmap 的 vmap_area 会先挂在这颗红黑树上，等待被释放 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rb_list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lazy;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 * Ready-to-free areas.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> list_head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> purge_list;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> work_struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> purge_work;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nr_purged;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="vmap-代码分析" tabindex="-1">vmap 代码分析 <a class="header-anchor" href="#vmap-代码分析" aria-label="Permalink to “vmap 代码分析”">​</a></h3><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vm_struct</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">area </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_vm_area_caller</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__get_vm_area_node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    BUG_ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">in_interrupt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 不能在中断上下文使用 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vm_struct</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">area </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kzalloc_node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 分配一个 vmap_area */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vmap_area</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">va </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> alloc_vmap_area</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(..., area)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* 优先从 vmap_pool 分配 vmap_area */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      va </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node_alloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* 否则从 slab 分配 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">va) va </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kmem_cache_alloc_node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(vmap_area_cachep);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* 如果不是从 vmap_pool 分配的，还需要这一步分配一个虚拟地址出来  */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      __alloc_vmap_area</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        find_vmap_lowest_match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 深度遍历红黑树，得到合适的 va（并没有从红黑树中取下） */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        va_alloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">va_clip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 修改红黑树中的那个 va，剪掉我们要使用的那一段区域 */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* 将 vmap_area 放进 vmap_node 的 busy 红黑树和链表 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vmap_node</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addr_to_node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(va-&gt;va_start);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  vmap_pages_range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(area-&gt;addr, .., pages)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> area-&gt;addr;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>接下来分析 vmap 演进历史中几个比较重要的 patch。</p><h4 id="patch-mm-rewrite-vmap-layer-nick-piggin" tabindex="-1"><a href="https://lore.kernel.org/linux-mm/20080818133224.GA5258@wotan.suse.de/" target="_blank" rel="noreferrer">[patch] mm: rewrite vmap layer - Nick Piggin</a> <a class="header-anchor" href="#patch-mm-rewrite-vmap-layer-nick-piggin" aria-label="Permalink to “[patch] mm: rewrite vmap layer - Nick Piggin”">​</a></h4><p>db64fe02258f1507e13fe5212a989922323685ce mm: rewrite vmap layer</p><p>存在的问题：</p><ol><li>vmap 最大的问题是 vunmap。目前需要一个 global kernel TLB flush，在大多数架构上，是一个广播给所有 CPU 的用于 flush cache 的 IPI，而且需要用一个全局锁。随着 CPU 数量增加，有伸缩性问题。</li><li>另一个问题是，整个 vmap 用了一个读写锁，而这个读写锁很少读并行，大多数时候是在 fast path 进行写。</li></ol><p>解决方式：</p><ol><li>lazy TLB unmapping。在 vunmap 后，不会立即 flush TLB。而是在某次 TLB flush 时，同时 flush 多个 vunmap 的地址。XEN 和 PAT 不会这样做，原因我懒得看。</li><li>虚拟地址的额外信息保存在红黑树里，提升算法可伸缩性。</li><li>对于小的 vmap，使用 per-cpu 的分配器，避免全局锁。</li></ol><h4 id="patch-v3-00-11-mitigate-a-vmap-lock-contention-v3-uladzislau-rezki-sony" tabindex="-1"><a href="https://lore.kernel.org/all/20240102184633.748113-1-urezki@gmail.com/" target="_blank" rel="noreferrer">[PATCH v3 00/11] Mitigate a vmap lock contention v3 - Uladzislau Rezki (Sony)</a> <a class="header-anchor" href="#patch-v3-00-11-mitigate-a-vmap-lock-contention-v3-uladzislau-rezki-sony" aria-label="Permalink to “[PATCH v3 00/11] Mitigate a vmap lock contention v3 - Uladzislau Rezki (Sony)”">​</a></h4><p>挑几个比较重要的进行分析。</p><ol><li><p>d093602919ad mm: vmalloc: remove global vmap_area_root rb-tree</p><p>大锁化小锁，减少锁争用。</p><p>引入 <code>struct vmap_node</code>，对于不同范围内的虚拟地址，通过 <code>addr_to_node(va)</code> 函数，使用不同的 <code>struct vmap_node</code>，从而减少锁争用。 将原先全局的 <code>vmap_area_root</code> 红黑树（用于记录已被使用的 vmap_area），改为 per-vmap_node 的 <code>busy</code> 红黑树。 将原先全局的 <code>vmap_area_lock</code> 锁，改为 per-vmap_node 的锁。</p></li><li><p>282631cb2447 mm: vmalloc: remove global purge_vmap_area_root rb-tree</p><p>大锁化小锁，减少锁争用。</p><p>将原先全局的 <code>purge_vmap_area_root</code> 红黑树（用于记录。。。），改为 per-vmap_node 的 <code>lazy</code> 红黑树。 将原先全局的 <code>purge_vmap_area_lock</code> 锁，改为了 per-vmap_node 的锁。减少了锁争用。</p></li><li><p>72210662c5a2 mm: vmalloc: offload free_vmap_area_lock lock</p><p>减少对 <code>free_vmap_area_lock</code> 锁的争用。</p><p>在每个 <code>struct vmap_node</code> 内新增 <code>struct vmap_pool</code> 数组，将不同大小的空闲的 <code>struct vmap_area</code> 放在不同的池子里进行缓存。</p><p>在 <code>alloc_vmap_area()</code> 时，只有对应的 vmap_pool 空了时，才会通过 <code>kmem_cache_alloc_node()</code> 从 SLUB 中分配 <code>struct vmap_area</code>。如果成功从 vmap_pool 中分配了，虽说分配时需要占用 per-vmap_node 的 pool_lock，但后面不需要 <code>__alloc_vmap_area()</code>，因此省去了对 <code>free_vmap_area_lock</code> 这个大锁的争用。</p><p>用于 lazy TLB vunmap 的 <code>__purge_vmap_area_lazy()</code> 函数，会从 lazy 链表中的 va 移动到 purge_list，如果需要移除的 va 较多，则使用 work queue 处理，否则直接就地 <code>purge_vmap_node()</code> 将 va 放回 vmap_pool，如果 vmap_pool 满了，则放回全局的 free_vmap_area_root 红黑树和 free_vmap_area_list 链表。</p></li><li><p>53becf32aec1 mm: vmalloc: support multiple nodes in vread_iter</p></li><li><p>8e1d743f2c26 mm: vmalloc: support multiple nodes in vmallocinfo</p></li><li><p>8f33a2ff3072 mm: vmalloc: set nr_nodes based on CPUs in a system</p><p>此时才会真正地用上多个 vmap_node</p></li><li><p>7679ba6b36db mm: vmalloc: add a shrinker to drain vmap pools</p><p>注册了一个 shrinker，用于在必要时缩小 vmap pool</p></li></ol><p>这是一个很典型的内存管理中锁的典型优化案例，其他案例：</p><ul><li><a href="https://blog.csdn.net/feelabclihu/article/details/141087096" target="_blank" rel="noreferrer">Linux 内存管理中锁使用分析及典型优化案例总结</a></li><li><a href="https://www.bluepuni.com/archives/linux-blk-mq/" target="_blank" rel="noreferrer">Linux 内核的 blk-mq（Block IO 层多队列）机制 | Caturra&#39;s Blog</a></li></ul><h2 id="vmalloc" tabindex="-1">vmalloc <a class="header-anchor" href="#vmalloc" aria-label="Permalink to “vmalloc”">​</a></h2><p>接口在 <code>include/linux/vmalloc.h</code></p><p><code>vmalloc()</code> 默认使用 <code>GFP_KERNEL</code> 如果想指定 gfp_mask，应使用 <code>__vmalloc()</code><code>vmalloc_huge()</code> 如果可以，会分配大页。</p><p>最终都会调用到核心函数 <code>__vmalloc_node_range_noprof()</code></p><p>关于 <code>_noprof</code> 见<a href="./buddy">buddy system</a>。</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">__vmalloc_node_range_noprof</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vm_struct</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">area </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> __get_vm_area_node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* 分配页面并 vmap */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  __vmalloc_area_node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    vm_area_alloc_pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">alloc_pages_bulk_array_mempolicy_noprof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      alloc_pages_bulk_noprof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 分配 0 阶页面 */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    vmap_pages_range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">..</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vmap_small_pages_range_noflush</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到，与 vmap 的流程相比，vmalloc 只多出了一个 <code>alloc_pages_bulk_noprof()</code> 分配内存的动作，该函数详见 <a href="./buddy">buddy system</a>。</p><h2 id="想水-patch-了" tabindex="-1">想水 patch 了 <a class="header-anchor" href="#想水-patch-了" aria-label="Permalink to “想水 patch 了”">​</a></h2><ol><li><code>struct vmap_area</code> 的注释里的 <code>vmap_area_root</code> 现在已经无了</li></ol>`,42)])])}const g=a(p,[["render",e]]);export{o as __pageData,g as default};
