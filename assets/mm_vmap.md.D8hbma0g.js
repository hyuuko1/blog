import{_ as a,c as i,o as p,aj as n}from"./chunks/framework.CcbH9oJh.js";const E=JSON.parse('{"title":"vmap","description":"","frontmatter":{"head":[["meta",{"property":"og:title","content":"vmap | Blog"}]]},"headers":[],"relativePath":"mm/vmap.md","filePath":"mm/vmap.md","lastUpdated":1761828946000}'),e={name:"mm/vmap.md"};function l(h,s,t,r,k,d){return p(),i("div",null,s[0]||(s[0]=[n(`<h1 id="vmap" tabindex="-1">vmap <a class="header-anchor" href="#vmap" aria-label="Permalink to “vmap”">​</a></h1><p>TODO: 把 <a href="./vmalloc">vmalloc.md</a> 中的 vmap 搬到这里。</p><p>vmap 的使用者可以分为两类。</p><ol><li><code>__vmap_pages_range_noflush()</code> 映射多个不连续的 page <ol><li><code>__pcpu_map_pages()</code></li><li><code>vmap_pages_range()</code><ol><li><code>__vmalloc_area_node()</code></li><li><code>vmap()</code></li><li>...</li></ol></li></ol></li><li><code>vmap_page_range()</code> 映射连续的页面。多为 ioremap 场景。</li></ol><p>ioremap 传入的物理地址，不能 <code>__va()</code> 直接转为虚拟地址？？</p><p>ioremap 的必须通过 iounmap 释放。</p><p>注意，iounmap 并不会释放 pte page，</p><h2 id="" tabindex="-1"><a class="header-anchor" href="#" aria-label="Permalink to “”">​</a></h2><p>每个类型都表示一个页表项， pgd pud pmd pte</p><p>如果是指针类型，则要么表示指向一个页表，要么表示指向页表中的一个页表项。</p><h2 id="huge-vmap" tabindex="-1">huge vmap <a class="header-anchor" href="#huge-vmap" aria-label="Permalink to “huge vmap”">​</a></h2><p>x86 arm64 riscv 都默认有 <code>CONFIG_HAVE_ARCH_HUGE_VMAP</code></p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vmap_range_noflush</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  pgd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pgd_offset_k</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(addr);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  vmap_p4d_range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    p4d </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> p4d_alloc_track</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">init_mm, pgd, addr, mask);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    vmap_pud_range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      pud </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pud_alloc_track</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">init_mm, p4d, addr, mask);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      vmap_try_huge_pud</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      vmap_pmd_range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        pmd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pmd_alloc_track</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">init_mm, pud, addr, mask);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	vmap_try_huge_pmd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	  pmd_free_pte_page</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	  pmd_set_huge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pmd, phys_addr, prot);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	vmap_pte_range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          set_pte_at</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pmd_free_pte_page</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>怀疑 pmd_free_pte_page() 可能有 bug。 可能这个 pmd range 的 2MB 之前就是 huge 映射的， 不存在 pte page， 需要新增逻辑：如果 <code>_PAGE_PSE</code>，则不 free_page。</p>`,14)]))}const c=a(e,[["render",l]]);export{E as __pageData,c as default};
