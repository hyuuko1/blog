import{_ as a,c as i,o as n,aj as e}from"./chunks/framework.CcbH9oJh.js";const c=JSON.parse('{"title":"AArch64 虚拟内存系统架构","description":"","frontmatter":{"head":[["meta",{"property":"og:title","content":"AArch64 虚拟内存系统架构 | Blog"}]]},"headers":[],"relativePath":"arch/arm/virtual_memory.md","filePath":"arch/arm/virtual_memory.md","lastUpdated":1761828946000}'),t={name:"arch/arm/virtual_memory.md"};function l(p,s,r,h,k,d){return n(),i("div",null,s[0]||(s[0]=[e(`<h1 id="aarch64-虚拟内存系统架构" tabindex="-1">AArch64 虚拟内存系统架构 <a class="header-anchor" href="#aarch64-虚拟内存系统架构" aria-label="Permalink to “AArch64 虚拟内存系统架构”">​</a></h1><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to “参考”">​</a></h2><ul><li><a href="https://cs140e.sergio.bz/docs/ARMv8-A-Programmer-Guide.pdf" target="_blank" rel="noreferrer">ARM Cortex-A Series Programmer&#39;s Guide for ARMv8-A</a> Chapter 12 The Memory Management Unit</li><li><a href="https://developer.arm.com/documentation/ddi0487/latest" target="_blank" rel="noreferrer">Arm Architecture Reference Manual for A-profile architecture</a> Chapter D8 The AArch64 Virtual Memory System Architecture</li></ul><h2 id="d8-1-address-translation" tabindex="-1">D8.1 Address translation <a class="header-anchor" href="#d8-1-address-translation" aria-label="Permalink to “D8.1 Address translation”">​</a></h2><p>ARMv8-A 架构的虚拟化扩展引入了第 2 个转换阶段。</p><ol><li>stage 1 是 VA-&gt;IPA</li><li>stage 2 是 IPA-&gt;PA</li></ol><p><strong>本文不涉及虚拟化内容，默认 stage 1</strong></p><h2 id="d8-3-translation-table-descriptor-formats" tabindex="-1">D8.3 Translation table descriptor formats <a class="header-anchor" href="#d8-3-translation-table-descriptor-formats" aria-label="Permalink to “D8.3 Translation table descriptor formats”">​</a></h2><p>Table D8-48 定义了描述符类型</p><ul><li>Table descriptor 描述了一个 table</li><li>Page descriptor 描述了一个页面，比如 4KB 这种。</li><li>Block descriptor 描述了一个大页面，比如 2MB 这种。</li></ul><h2 id="d8-4-memory-access-control" tabindex="-1">D8.4 Memory access control <a class="header-anchor" href="#d8-4-memory-access-control" aria-label="Permalink to “D8.4 Memory access control”">​</a></h2><ul><li>Direct permissions 模式，使用描述符里定义的 access permissions。</li><li>Indirect permissions 模式，使用描述符里定义的 Permission Indirection Index。 <br>Permission Indirection Extension (PIE) 是在 Armv8.9-A/Armv9.4-A 引入的。 <br>在 2023.6 合入的 patchset 让 Linux 支持了 <a href="https://lore.kernel.org/all/20230606145859.697944-1-joey.gouly@arm.com/" target="_blank" rel="noreferrer">https://lore.kernel.org/all/20230606145859.697944-1-joey.gouly@arm.com/</a> <a href="https://www.phoronix.com/news/Linux-6.5-ARM64" target="_blank" rel="noreferrer">Linux 6.5 On AArch64 Sees New Extensions, KPTI Cleanup - Phoronix</a> <a href="https://aijishu.com/a/1060000000360623" target="_blank" rel="noreferrer">Arm A-Profile 构架 2022 扩展</a><br>如果 cpu 不支持此特性，会 <code>cbz x1, .Lskip_indirection</code> 跳过启用 PIE。</li></ul><p><strong>懒得研究这玩意，本文默认 Direct permissions</strong></p><h2 id="d8-5-hardware-updates-to-the-translation-tables" tabindex="-1">D8.5 Hardware updates to the translation tables <a class="header-anchor" href="#d8-5-hardware-updates-to-the-translation-tables" aria-label="Permalink to “D8.5 Hardware updates to the translation tables”">​</a></h2><blockquote><p>来自：ARMv8-A-Programmer-Guide.pdf 12.8 Operating system use of translation table descriptors</p><p>Operating systems use an access flag bit to keep track of which pages are being used. Software manages the flag. When the page is first created, its entry has AF set to 0. The first time the page is accessed by code, if it has AF at 0, this triggers an MMU fault. The Page fault handler records that this page is now being used and manually sets the AF bit in the table entry. For example, the Linux kernel uses the [AF] bit for <code>PTE_AF</code> on ARM64 (the Linux kernel name for AArch64), which is used to check whether a page has ever been accessed. This influences some of the kernel memory management choices. For example, when a page must be swapped out of memory, it is less likely to swap out pages that are being actively used.</p><p>Bits [58:55] of the descriptor are marked as <em>Reserved for Software Use</em> and can be used to record OS-specific information in the translation tables. For example, the Linux kernel uses one of these bits to mark an entry as clean or dirty. The dirty status records whether the page has been written to. If the page is later swapped out of memory, a clean page can simply be discarded, but a dirty page must have its contents saved first.</p></blockquote><h3 id="d8-5-1-the-access-flag" tabindex="-1">D8.5.1 The Access flag <a class="header-anchor" href="#d8-5-1-the-access-flag" aria-label="Permalink to “D8.5.1 The Access flag”">​</a></h3><p>If the AF is not managed by hardware, software management of the AF is required.</p><p>For an implementation that does not manage the AF in hardware, when an attempt is made to translate an address using a descriptor with an AF of 0, an Access flag fault is generated. For an implementation that does not manage the AF in hardware, when an Access flag fault is generated, software is expected to set the AF to 1 in the descriptor that generated the fault. Setting the AF to 1 prevents the Access flag fault from being generated the next time an attempt is made to translate an address using that descriptor. When software sets the AF to 1, there is no requirement to perform TLB invalidation after setting the flag because entries with an AF set to 0 are never held in a TLB.</p><p>在 Linux 中，<code>handle_pte_fault()</code> 会 <code>pte_mkyoung()</code> 置上 Access flag，详见 <a href="./../../mm/pagefault">pagefault</a>。</p><h3 id="d8-5-2-the-dirty-state" tabindex="-1">D8.5.2 The dirty state <a class="header-anchor" href="#d8-5-2-the-dirty-state" aria-label="Permalink to “D8.5.2 The dirty state”">​</a></h3><p>dirty state 用于表示内存页面已经被修改。</p><p>一个 Block/Page 描述符，有下列几种状态之一：</p><ul><li>Non-writable</li><li>Writable-clean</li><li>Writable-dirty</li></ul><p>如果一个翻译阶段使用 Direct permission，那么只允许硬件管理 dirty state； 如果一个翻译阶段使用 Indirect permission，那么允许软件或硬件管理 dirty state。 如果描述符的 dirty state 被软件管理（即，禁用了硬件管理），那么对于 writable-clean 描述符翻译的 write accesses，会由于 dirty state 而生成 Permission fault。 XXX 难道：如果用 Direct permission，因为只允许硬件管理不允许软件管理，所以不会因为 dirty state 生成 Permission fault？这不对吧？？是我的理解有问题？</p><h4 id="d8-5-2-1-hardware-management-of-the-dirty-state" tabindex="-1">D8.5.2.1 Hardware management of the dirty state <a class="header-anchor" href="#d8-5-2-1-hardware-management-of-the-dirty-state" aria-label="Permalink to “D8.5.2.1 Hardware management of the dirty state”">​</a></h4><p><code>FEAT_HAFDBS</code> 特性支持硬件更新 Access flag 和 dirty state.</p><p>将 <code>TCR_ELx.HD</code> 置 1 启用了硬件管理 dirty state。</p><p>对于使用 Direct permission 的翻译，当 Block/Page 描述符的 DBM field 为 0 时：</p><ul><li>Permission faults 的生成不会被 <code>FEAT_HAFDBS</code> 所影响。</li><li>硬件不会更新该页面的 dirty state。</li></ul><p>对于使用 Direct permission 的每个翻译阶段，如果下列条件成立，那么该 Block/Page 描述符是 writable-clean 的：</p><ul><li>启用了硬件更新 dirty state</li><li>描述符的 DBM field 是 1</li><li>对于 stage 1，描述符的 AP[2] 是 1（表示只读）。注意：如果禁用了硬件管理 dirty state，那么 write access 发生 Permission fault 的原因只有一个：AP[2] 是 1。</li></ul><p>对于使用 Direct permission 的每个翻译阶段，如果下列条件成立，那么该 Block/Page 描述符是 writable-dirty 的：</p><ul><li>启用了硬件更新 dirty state</li><li>描述符的 DBM field 是 1</li><li>对于 stage 1，描述符的 AP[2] 是 0（表示可读写）</li></ul><p>只有当描述符是 writable-clean 的时，硬件才能更新 dirty state。</p><p>对于被一个 writable-clean 翻译的 write access：</p><ul><li>如果描述符的 dirty state 被硬件管理，那么不会生成 Permission fault，并且硬件会使用 atomic read-modify-write 更新描述符为 writable-dirty（也就是把 AP[2] 置 0）。如果满足更新 Access flag 的条件，也会顺便置 1。</li><li>由该 write access 而产生 Permission fault 的唯一原因是：dirty state 硬件管理被禁用。</li></ul><h4 id="在-linux-内核中的体现" tabindex="-1">在 Linux 内核中的体现 <a class="header-anchor" href="#在-linux-内核中的体现" aria-label="Permalink to “在 Linux 内核中的体现”">​</a></h4><p><a href="https://stackoverflow.com/questions/32943129/how-does-arm-linux-emulate-the-dirty-accessed-and-file-bits-of-a-pte" target="_blank" rel="noreferrer">How does ARM Linux emulate the dirty, accessed, and file bits of a PTE? - Stack Overflow</a></p><p>对于一个可写的页面，Linux 会将描述符的 DBM field 置 1，将 RDONLY field 也置 1，表示该描述符是 writable-clean 的。</p><ul><li>当启用硬件管理 Access flag 和 dirty state 时。发生 write access，硬件会将 Access flag 置 1（如果是第一次访问），并且将 RDONLY field 置清 0，使得描述符从 writable-clean 变为 writable-dirty。</li><li>当禁用硬件管理 Access flag 和 dirty state 时。发生 write access，由于是 writable-clean 的（DBM 是 1，RDONLY 是 1），因此会发生 Permission fault，Linux 会在 <code>handle_pte_fault()</code> 函数中，先 <code>pte_mkdirty()</code> 将软件定义的 DIRTY field 置 1，并将 RDONLY field 清 0，使得描述符从 writable-clean 变为 writable-dirty。然后 <code>pte_mkyoung()</code> 将 Access flag 置 1（如果是第一次访问）。</li></ul><p><code>handle_pte_fault()</code> 函数详见 <a href="./../../mm/pagefault">pagefault</a>。</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* arch/arm64/include/asm/pgtable-prot.h */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 软件定义的 WRITE field，实际上就是 DBM field */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PTE_WRITE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">PTE_DBM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 软件定义的脏位。使用的是一个 IGNORED field  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PTE_DIRTY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_AT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pteval_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 55</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* DBM field 为 1，表示 writable */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pte_write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)		(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pte_val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PTE_WRITE))</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* RDONLY field 为 1，表示 read-only */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pte_rdonly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)		(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pte_val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PTE_RDONLY))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* DBM 是 1，AP[2] 是 0，表示 writable-dirty */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pte_hw_dirty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)	(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pte_write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pte_rdonly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte))</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 软件定义的脏位为 1 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pte_sw_dirty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)	(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pte_val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PTE_DIRTY))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pte_dirty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)		(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pte_sw_dirty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pte_hw_dirty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> inline</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pte_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pte_mkdirty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pte_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> pte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* 软件定义的 DIRTY field 置 1 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	pte </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> set_pte_bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__pgprot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PTE_DIRTY));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* 将 RDONLY field 清 0 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pte_write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		pte </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> clear_pte_bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__pgprot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PTE_RDONLY));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pte;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> inline</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pte_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pte_mkyoung</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pte_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> pte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* 将 Access flag 置 1 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> set_pte_bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pte, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__pgprot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PTE_AF));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p><strong><code>FEAT_HAFDBS</code> 特性的启用</strong></p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* arch/arm64/Kconfig */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config ARM64_HW_AFDBM</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	bool</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Support for hardware updates of the Access and Dirty page flags&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	default y</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	help</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  The ARMv8.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> architecture extensions introduce support </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  hardware updates of the access and dirty information in page</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  table entries. When enabled in </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TCR_EL1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (HA and HD </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) on</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  capable processors, accesses to pages with PTE_AF cleared will</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  set this bit instead of raising an access flag fault.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  Similarly, writes to read</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">only pages with the DBM bit set will</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  clear the read</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">only </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">AP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) instead of raising a</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  permission fault.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  Kernels built with this configuration option enabled </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">continue</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  to work on pre</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ARMv8.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hardware and the performance impact is</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	  minimal. If unsure, say Y.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* arch/arm64/include/asm/pgtable-hwdef.h */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TCR_HA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">UL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 39</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TCR_HD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">UL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 40</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 在 bootting 阶段，cpu_enable 钩子会被调用  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arm64_cpu_capabilities arm64_features</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#ifdef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CONFIG_ARM64_HW_AFDBM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		.desc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Hardware dirty bit management&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARM64_CPUCAP_WEAK_LOCAL_CPU_FEATURE,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		.capability </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARM64_HW_DBM,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		.matches </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> has_hw_dbm,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		.cpu_enable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cpu_enable_hw_dbm,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		.cpus </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dbm_cpus,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		ARM64_CPUID_FIELDS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ID_AA64MMFR1_EL1, HAFDBS, DBM)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	},</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#endif</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cpu_enable_hw_dbm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cpu_can_use_dbm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cap))</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    __cpu_enable_hw_dbm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* 给 TCR_EL1 寄存器的 TCR_HD bit 置位 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      u64 tcr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> read_sysreg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tcr_el1) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TCR_HD;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      write_sysreg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tcr, tcr_el1);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* __cpu_setup 函数 */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SYM_FUNC_START</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__cpu_setup)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#ifdef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CONFIG_ARM64_HW_AFDBM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* 给 TCR_EL1 寄存器的 TCR_HA bit 置位 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	orr	tcr, tcr, #TCR_HA</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h4 id="d8-5-2-3-hardware-dirty-state-tracking-structure" tabindex="-1">D8.5.2.3 Hardware dirty state tracking structure <a class="header-anchor" href="#d8-5-2-3-hardware-dirty-state-tracking-structure" aria-label="Permalink to “D8.5.2.3 Hardware dirty state tracking structure”">​</a></h4><p>持续记录 dirtied stage 2 的 Block/Page 描述符，使得 EL2 的 Hypervisor 无需扫描页表。</p><h2 id="d8-15-memory-aborts" tabindex="-1">D8.15 Memory aborts <a class="header-anchor" href="#d8-15-memory-aborts" aria-label="Permalink to “D8.15 Memory aborts”">​</a></h2><h3 id="d8-15-1-mmu-fault-types" tabindex="-1">D8.15.1 MMU fault types <a class="header-anchor" href="#d8-15-1-mmu-fault-types" aria-label="Permalink to “D8.15.1 MMU fault types”">​</a></h3><h4 id="d8-15-1-4-access-flag-fault" tabindex="-1">D8.15.1.4 Access flag fault <a class="header-anchor" href="#d8-15-1-4-access-flag-fault" aria-label="Permalink to “D8.15.1.4 Access flag fault”">​</a></h4><h3 id="d8-15-5-mmu-fault-prioritization-from-a-single-address-translation-stage" tabindex="-1">D8.15.5 MMU fault prioritization from a single address translation stage <a class="header-anchor" href="#d8-15-5-mmu-fault-prioritization-from-a-single-address-translation-stage" aria-label="Permalink to “D8.15.5 MMU fault prioritization from a single address translation stage”">​</a></h3>`,50)]))}const g=a(t,[["render",l]]);export{c as __pageData,g as default};
