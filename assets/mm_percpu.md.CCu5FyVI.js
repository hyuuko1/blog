import{_ as i,c as a,o as n,al as p}from"./chunks/framework.CdzZEkix.js";const E=JSON.parse('{"title":"per-cpu å˜é‡çš„é™æ€å’ŒåŠ¨æ€åˆ†é…","description":"","frontmatter":{"head":[["meta",{"property":"og:title","content":"per-cpu å˜é‡çš„é™æ€å’ŒåŠ¨æ€åˆ†é… | Blog"}]]},"headers":[],"relativePath":"mm/percpu.md","filePath":"mm/percpu.md","lastUpdated":1763912647000}'),l={name:"mm/percpu.md"};function e(t,s,h,k,r,d){return n(),a("div",null,[...s[0]||(s[0]=[p(`<h1 id="per-cpu-å˜é‡çš„é™æ€å’ŒåŠ¨æ€åˆ†é…" tabindex="-1">per-cpu å˜é‡çš„é™æ€å’ŒåŠ¨æ€åˆ†é… <a class="header-anchor" href="#per-cpu-å˜é‡çš„é™æ€å’ŒåŠ¨æ€åˆ†é…" aria-label="Permalink to â€œper-cpu å˜é‡çš„é™æ€å’ŒåŠ¨æ€åˆ†é…â€">â€‹</a></h1><h2 id="å‚è€ƒ" tabindex="-1">å‚è€ƒ <a class="header-anchor" href="#å‚è€ƒ" aria-label="Permalink to â€œå‚è€ƒâ€">â€‹</a></h2><ul><li>ğŸŒŸ ã€ŠLinux å†…æ ¸æ·±åº¦è§£æã€‹3.10 æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨</li><li>ğŸŒŸ ã€ŠLinux å†…æ ¸åˆ†æåŠåº”ç”¨ã€‹2.3.7 per-cpu å˜é‡</li><li>ğŸŒŸ <a href="https://blog.csdn.net/weixin_45030965/article/details/126289230" target="_blank" rel="noreferrer">Linux per-cpu_linux percpu-CSDN åšå®¢</a></li><li><a href="http://www.wowotech.net/kernel_synchronization/per-cpu.html" target="_blank" rel="noreferrer">Linux å†…æ ¸åŒæ­¥æœºåˆ¶ä¹‹ï¼ˆäºŒï¼‰ï¼šPer-CPU å˜é‡</a></li><li><a href="https://docs.hust.openatom.club/linux-insides-zh/concepts/linux-cpu-1" target="_blank" rel="noreferrer">æ¯ä¸ª CPU çš„å˜é‡ | linux-insides-zh</a></li></ul><h2 id="æ¦‚è§ˆ" tabindex="-1">æ¦‚è§ˆ <a class="header-anchor" href="#æ¦‚è§ˆ" aria-label="Permalink to â€œæ¦‚è§ˆâ€">â€‹</a></h2><p>ä½¿ç”¨å½“å‰ cpu å˜é‡æ—¶ï¼Œåº” <code>preempt_disable();</code> ç¦æ­¢æŠ¢å ï¼Œæ”¾ç½®åœ¨ task ä¸Šä¸‹æ–‡æ—¶å‘ç”ŸæŠ¢å ï¼Œå¯¼è‡´å½“å‰ task åœ¨ä½¿ç”¨ cpu å˜é‡æ—¶ï¼Œè¢«æŠ¢å åï¼Œè¢«åˆ‡æ¢åˆ°å…¶ä»– cpu ä¸Šè¿è¡Œã€‚</p><p>é™æ€ per-cpu å˜é‡åŸç†ï¼š</p><ol><li>é™æ€ per-cpu åŸå§‹å˜é‡ <code>var</code> å­˜æ”¾åœ¨ <code>.data..percpu</code> section é‡Œã€‚å®é™…ä¸Šï¼Œä¼šåœ¨å¦å¤–ä¸€å—å†…å­˜åŒºåŸŸä¸ºè¯¥ section åˆ›å»º N ä¸ªå‰¯æœ¬ï¼Œè¿™ä¸ª section åœ¨å†…æ ¸åˆå§‹åŒ–å®Œåä¼šè¢«å›æ”¶ã€‚</li><li><code>__per_cpu_offset[NR_CPUS]</code> æ•°ç»„ï¼Œä¿å­˜äº†åç§»é‡ï¼ˆx86 æ¶æ„ä¼šä½¿ç”¨ <code>this_cpu_off</code> è¿™ä¸ª per-cpu çš„å˜é‡ï¼Œå«ä¹‰å’Œå‰è€…ä¸€æ ·ï¼Œä½†æ›´ä¸ºé«˜æ•ˆï¼‰ã€‚ä¸‹æ–‡çš„ä»£ç åˆ†æé‡Œä¼šæåˆ°è¿™ä¸ªæ•°ç»„æ˜¯å¦‚ä½•è¢«åˆå§‹åŒ–çš„ã€‚</li><li>å¯¹äº per-cpu å˜é‡ï¼Œæ­¤å¤„å°†åŸå§‹ per-cpu å˜é‡ç§°ä¸º <code>var</code>ï¼Œå°†å±äº cpu N çš„å‰¯æœ¬å˜é‡ç§°ä¸º <code>varN</code>ã€‚<code>varN</code> çš„åœ°å€å°±æ˜¯ <code>&amp;var + __per_cpu_offset[N]</code>ã€‚</li></ol><h3 id="å®šä¹‰é™æ€-per-cpu-å˜é‡" tabindex="-1">å®šä¹‰é™æ€ per-cpu å˜é‡ <a class="header-anchor" href="#å®šä¹‰é™æ€-per-cpu-å˜é‡" aria-label="Permalink to â€œå®šä¹‰é™æ€ per-cpu å˜é‡â€">â€‹</a></h3><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PER_CPU_BASE_SECTION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;.data..percpu&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> __PCPU_ATTRS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	__percpu</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> __attribute__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">section</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PER_CPU_BASE_SECTION sec)))	</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	PER_CPU_ATTRIBUTES</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DEFINE_PER_CPU_SECTION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)				</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	__PCPU_ATTRS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sec) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__typeof__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type) name</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DEFINE_PER_CPU</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)					</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	DEFINE_PER_CPU_SECTION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type, name, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>å°†å˜é‡æ”¾åœ¨ <code>.data..percpu</code> section é‡Œã€‚</p><h3 id="åŠ¨æ€åˆ†é…-per-cpu-å˜é‡" tabindex="-1">åŠ¨æ€åˆ†é… per-cpu å˜é‡ <a class="header-anchor" href="#åŠ¨æ€åˆ†é…-per-cpu-å˜é‡" aria-label="Permalink to â€œåŠ¨æ€åˆ†é… per-cpu å˜é‡â€">â€‹</a></h3><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> alloc_percpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type) __percpu </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__alloc_percpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type),		</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">						__alignof__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> free_percpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> __percpu</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">__pdata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="è®¿é—®-per-cpu-å˜é‡" tabindex="-1">è®¿é—® per-cpu å˜é‡ <a class="header-anchor" href="#è®¿é—®-per-cpu-å˜é‡" aria-label="Permalink to â€œè®¿é—® per-cpu å˜é‡â€">â€‹</a></h3><p>å½¢å¦‚ <code>*_ptr()</code> çš„ API è¡¨æ˜ä¼ å…¥çš„æ˜¯æŒ‡é’ˆã€‚</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> per_cpu_offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (__per_cpu_offset[x])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> per_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({									</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	__verify_pcpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr);						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	SHIFT_PERCPU_PTR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((ptr), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">per_cpu_offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((cpu)));			</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* è·å–æŒ‡å®š cpu ä¸Šçš„ per-cpu å˜é‡ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> per_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)	(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">per_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(var), cpu))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* arch/x86/include/asm/percpu.h */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> arch_raw_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({									</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tcp_ptr__ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> raw_cpu_read_long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(this_cpu_off);	</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">									\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	tcp_ptr__ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (__force </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(_ptr);			</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_ptr)) __kernel __force </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)tcp_ptr__;			</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> raw_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({									</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	__verify_pcpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr);						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	arch_raw_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr);						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> this_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">raw_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* ä¼ å…¥ä¸€ä¸ª lvalueï¼Œè¯¥ lvalue çš„åœ°å€ + per-cpu çš„ this_cpu_off å°±æ˜¯æˆ‘ä»¬æƒ³è¦å–å¾—çš„å˜é‡çš„åœ°å€ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_cpu_var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({									</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	preempt_disable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	this_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">var);						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> put_cpu_var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {									</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(var);							</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	preempt_enable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* ä¼ å…¥ä¸€ä¸ªæŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæœ¬èº«çš„å€¼ä½œä¸ºä¸€ä¸ªåç§»é‡ä½¿ç”¨ï¼ŒåŠ ä¸Š per-cpu çš„ this_cpu_off å°±æ˜¯æˆ‘ä»¬æƒ³è¦å–å¾—çš„å˜é‡çš„åœ°å€  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({									</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	preempt_disable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	this_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(var);						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> put_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {									</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(var);							</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	preempt_enable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();						</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>ç”±äºåŠ¨æ€åˆ†é…å¾—åˆ°çš„æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥åªèƒ½ç”¨ <code>per_cpu_ptr()</code>, <code>get_cpu_ptr()</code> å’Œ <code>get_cpu_ptr()</code> ç­‰ç­‰ã€‚</p><h3 id="ä¾‹å­" tabindex="-1">ä¾‹å­ <a class="header-anchor" href="#ä¾‹å­" aria-label="Permalink to â€œä¾‹å­â€">â€‹</a></h3><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DEFINE_PER_CPU</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, process_counts) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> nr_processes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cpu;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	for_each_possible_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cpu)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> per_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(process_counts, cpu);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>æˆ‘ä¹Ÿå†™äº†ä¸ªä¾‹å­æ”¾åœ¨äº†ä»£ç ä»“çš„ <code>/src/mm/test_percpu.c</code></p><h2 id="ä»£ç åˆ†æ" tabindex="-1">ä»£ç åˆ†æ <a class="header-anchor" href="#ä»£ç åˆ†æ" aria-label="Permalink to â€œä»£ç åˆ†æâ€">â€‹</a></h2><h3 id="ç»“æ„ä½“" tabindex="-1">ç»“æ„ä½“ <a class="header-anchor" href="#ç»“æ„ä½“" aria-label="Permalink to â€œç»“æ„ä½“â€">â€‹</a></h3><ul class="contains-task-list"><li class="task-list-item"><input class="task-list-item-checkbox" disabled="" type="checkbox"> å¾…è¡¥å……</li></ul><p>populate çš„å«ä¹‰æ˜¯å¡«å……ã€‚populated ä½å›¾è®°å½•äº†é‚£äº›å·²ç»æ˜ å°„åˆ°å®é™…ç‰©ç†å†…å­˜çš„åŒºåŸŸã€‚</p><h3 id="åˆå§‹åŒ–" tabindex="-1">åˆå§‹åŒ– <a class="header-anchor" href="#åˆå§‹åŒ–" aria-label="Permalink to â€œåˆå§‹åŒ–â€">â€‹</a></h3><ol><li>å‡è®¾æœ‰ N ä¸ª cpuï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ª chunkï¼Œå…¶ä¸­æœ‰ N ä¸ª unitï¼ˆ<strong>ä¸ N ä¸ª cpu ä¸€ä¸€å¯¹åº”</strong>ï¼‰ã€‚éƒ½ä¼šåˆ†é…å¥½å†…å­˜ï¼Œç„¶åè¿›è¡Œ vmapã€‚</li><li><code>.data..percpu</code> sectionï¼Œä¹Ÿå°±æ˜¯ <code>[__per_cpu_start, __per_cpu_end]</code> åŒºåŸŸå†…çš„ per-cpu å˜é‡ä¼šè¢« memcpy åˆ° N ä¸ª unit ä¸­ï¼ˆ<code>pcpu_base_addr</code> å¼€å§‹çš„åŒºåŸŸï¼‰ã€‚</li><li>ç”± <code>arch/x86/kernel/vmlinux.lds.S</code> å¯çŸ¥ï¼Œ<code>.data..percpu</code> section å†…çš„å˜é‡ä½äº <code>[__init_begin, __init_end]</code> èŒƒå›´å†…ã€‚å› æ­¤è¯¥ section å†…çš„å˜é‡ä¹Ÿä¼šè¢« <code>kernel_init()-&gt;free_initmem()</code> é‡Šæ”¾ã€‚</li><li>percpu æœºåˆ¶å®Œæˆåˆå§‹åŒ–åã€‚<code>.data..percpu</code> section å®é™…ä¸Šä¸å†èµ·å®é™…ä½œç”¨äº†ã€‚ static percpu å˜é‡â€œçœŸæ­£â€çš„èµ·å§‹åœ°å€å˜æˆäº† <code>pcpu_base_addr</code> è€Œé <code>__per_cpu_start</code>ã€‚</li></ol><p><code>struct pcpu_chunk</code> åªéœ€è®°å½•è¯¥ chunk çš„ unit0 çš„åœ°å€èŒƒå›´ï¼Œä¹Ÿå°±æ˜¯ <code>chunk-&gt;base_addr</code>ï¼Œå…¶ä»–çš„ unit åŒºåŸŸèŒƒå›´å¯ä»¥æ®æ­¤åŠ ä¸Šåç§»é‡è®¡ç®—å¾—å‡ºã€‚<strong>åœ¨ chunk å†…åˆ†é… percpu å˜é‡çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯åœ¨è¯¥ chunk çš„ unit0 çš„åœ°å€èŒƒå›´å†…å¯»æ‰¾å¯ç”¨åŒºåŸŸçš„è¿‡ç¨‹ã€‚</strong></p><h4 id="åˆå§‹åŒ–æ—¶-åˆ›å»ºäº†å“ªäº›-chunk" tabindex="-1">åˆå§‹åŒ–æ—¶ï¼Œåˆ›å»ºäº†å“ªäº› chunkï¼Ÿ <a class="header-anchor" href="#åˆå§‹åŒ–æ—¶-åˆ›å»ºäº†å“ªäº›-chunk" aria-label="Permalink to â€œåˆå§‹åŒ–æ—¶ï¼Œåˆ›å»ºäº†å“ªäº› chunkï¼Ÿâ€">â€‹</a></h4><p>æ ¹æ® <code>pcpu_setup_first_chunk()</code> é‡Œçš„æ³¨é‡Šï¼Œåœ¨åˆå§‹åŒ–æ—¶ï¼Œå¹¶ä¸æ˜¯åªåˆ›å»ºäº† 1 ä¸ª chunkï¼Œè€Œæ˜¯ 2 ä¸ªã€‚å°†æ¯ä¸ª unit_size å¤§å°çš„åŒºåŸŸéƒ½æ‹†åˆ†æˆäº† 3 ä»½ unitï¼š<code>| static | [reserved] | dynamic |</code></p><ol><li><p><code>[pcpu_base_addr, pcpu_base_addr + static_size]</code></p><p>cpu0 çš„é™æ€ per-cpu å˜é‡åŒºåŸŸã€‚å› ä¸ºå¹¶ä¸ä¼šé‡Šæ”¾è¿™äº›å˜é‡ï¼Œä¸éœ€è¦è¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥å®é™…ä¸Šå¹¶æœªä¸ºè¯¥åŒºåŸŸåˆ›å»º chunkã€‚</p><p><code>.data..percpu</code> section åœ¨ <code>pcpu_embed_first_chunk()</code> å‡½æ•°é‡Œè¢«æ‹·è´åˆ°äº†è¿™ä¸ªåŒºåŸŸã€‚</p></li><li><p><code>[pcpu_base_addr + static_size, pcpu_base_addr + static_size + reserved_size]</code></p><p>cpu0 çš„ per-cpu ä¿ç•™åŒºåŸŸã€‚ä½œä¸º <code>pcpu_reserved_chunk</code> çš„ unit0ï¼Œè¿™ä¸ª chunk ä½œç”¨è¯¦è§ <code>pcpu_setup_first_chunk()</code> çš„æ³¨é‡Šã€‚</p></li><li><p>å‰©ä¸‹çš„ <code>dyn_size</code> å¤§å°çš„åŒºåŸŸã€‚</p><p>cpu0 çš„åŠ¨æ€ per-cpu å˜é‡åŒºåŸŸã€‚ä½œä¸º <code>pcpu_first_chunk</code> çš„ unit0ï¼Œè¢«ç”¨äºåŠ¨æ€åˆ†é… percpu å˜é‡ã€‚</p></li></ol><p>æ¥çœ‹ä»£ç </p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* åˆå§‹åŒ– percpu ç›¸å…³ã€‚åœ¨æ­¤å‡½æ•°ä¹‹å‰ï¼Œä¸å¯ä»¥ä½¿ç”¨é™æ€ percpu å˜é‡ï¼Ÿ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start_kernel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setup_per_cpu_areas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* åˆå§‹åŒ–ç¬¬ä¸€ä¸ª chunk</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     å¯é€šè¿‡ percpu_alloc=page cmdline æ”¹ç”¨ pcpu_page_first_chunk() */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  pcpu_embed_first_chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* upa å°±æ˜¯ cpu æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       ai-&gt;unit_size æ˜¯ chunk å†…æ¯ä¸ª unit çš„å¤§å°ï¼Œæˆ‘è¿™é‡Œæ˜¯ 0x80000 ä¹Ÿå°±æ˜¯ 512KB</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       nr_groups å°±æ˜¯ NUMA node æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       gi-&gt;nr_units å°±æ˜¯ cpu æ•°é‡ï¼Œgi-&gt;base_offset æ˜¯ 0 */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    pcpu_build_alloc_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* å•ä¸ª unit å®é™…ä¸Šç”¨åˆ°çš„å¤§å°ï¼ŒåŒ…å«å‰æ–‡æåˆ°çš„ 3 ä¸ªåŒºåŸŸï¼Œè¿™ä¸ªä¼šæ¯” ai-&gt;unit_size å° */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    size_sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ai-&gt;static_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ai-&gt;reserved_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ai-&gt;dyn_size;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* åˆ†é…è¯¥ chunk ä½¿ç”¨çš„å†…å­˜ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pcpu_fc_alloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gi-&gt;nr_units </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ai-&gt;unit_size)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr, base);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* å°† .data..percpu section æ‹·è´åˆ°è¯¥ chunk çš„æ¯ä¸€ä¸ª unit å†… */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gi-&gt;nr_units; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ai-&gt;unit_size)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      memcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr, __per_cpu_load, ai-&gt;static_size);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* æ¯ä¸ª unit å†…ä¸ä¼šè¢«ç”¨åˆ°çš„åŒºåŸŸé‡Šæ”¾æ‰ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      pcpu_fc_free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size_sum, ai-&gt;unit_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size_sum);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    pcpu_setup_first_chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ai, base);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* pcpu_unit_offsets æ˜¯å„ unit åˆ° unit0 çš„åç§» */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      pcpu_unit_offsets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unit_off;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* pcpu_reserved_chunk ç”¨äºåç»­çš„ä¿ç•™ per-cpu åˆ†é… */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      tmp_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> static_size;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      pcpu_reserved_chunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pcpu_alloc_first_chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tmp_addr, ai-&gt;reserved_size);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* pcpu_first_chunk ç”¨äºåç»­çš„åŠ¨æ€ per-cpu åˆ†é… */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      tmp_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> static_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ai-&gt;reserved_size;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      pcpu_first_chunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pcpu_alloc_first_chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tmp_addr, dyn_size);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* è¿™ä¸ªåœ°å€å…¶å®å°±æ˜¯å‰é¢ pcpu_fc_alloc å¾—åˆ°çš„é‚£ä¸ª ptrï¼Œæ˜¯ static percpu çš„èµ·å§‹åœ°å€ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      pcpu_base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base_addr;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* å‰é¢ï¼Œæˆ‘ä»¬ä¸º .data..percpu section åˆ›å»ºäº† N ä¸ªå‰¯æœ¬ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     å…¶ä¸­ç¬¬ 0 ä¸ªå‰¯æœ¬çš„åœ°å€å°±æ˜¯ pcpu_base_addrã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     æ‰€ä»¥ delta å°±æ˜¯ static percpu çš„æ–°ä½ç½®ä¸åŸå…ˆçš„ä½ç½®çš„åç§»é‡ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  delta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)pcpu_base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)__per_cpu_start;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* åˆå§‹åŒ– __per_cpu_offset æ•°ç»„å’Œ this_cpu_off percpu å˜é‡ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  for_each_possible_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cpu)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    per_cpu_offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cpu) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_unit_offsets[cpu];</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    per_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(this_cpu_off, cpu) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> per_cpu_offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cpu);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* åŠ¨æ€åˆ†é… percpu å˜é‡çš„ API */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">alloc_percpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pcpu_alloc_noprof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* æ‰¾åˆ°ä¸€ä¸ªä½•æ—¶ chunkï¼Œæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ª */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* ä» chunk ä¸­æ‰¾åˆ°å¯ç”¨çš„åŒºåŸŸï¼Œé€šè¿‡ bitmap æ‰¾çš„ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  pcpu_alloc_area</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* å¯¹äºè¯¥åŒºåŸŸå†…è¿˜æœªåˆ†é…å†…å­˜çš„åœ°æ–¹ï¼Œè¿›è¡Œå†…å­˜åˆ†é… */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  for_each_clear_bitrange_from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rs, re, chunk-&gt;populated, page_end)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    pcpu_populate_chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk, rs, re, pcpu_gfp);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      pcpu_alloc_pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* ä¸ºæ¯ä¸ª unit(ä¹Ÿå°±æ˜¯ cpu) åˆ†é… 0 é˜¶çš„é¡µé¢ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      pcpu_map_pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* ä¸ºæ¯ä¸ª unit è¿›è¡Œ vmap */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        __pcpu_map_pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pcpu_chunk_addr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk, cpu, page_start), ...)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* åˆ†é…å¥½å†…å­˜å¹¶æ˜ å°„åï¼Œå°† chunk-&gt;populated ä½å›¾ç½® 1  */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    pcpu_chunk_populated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk, rs, re);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>åœ¨å®Œæˆåˆå§‹åŒ–åï¼Œéšç€ç³»ç»Ÿè¿è¡Œï¼Œ<code>pcpu_first_chunk</code> å†…ç©ºé—²åŒºåŸŸé€æ¸è¢«åˆ†é…ï¼Œç›´åˆ° <code>alloc_percpu()</code> å‘ç°æ²¡æœ‰ç©ºé—²åŒºåŸŸæ—¶ï¼Œå°±ä¼šåˆ›å»ºæ–°çš„ <code>struct pcpu_chunk</code> å¹¶ä»å…¶ä¸­åˆ†é…ã€‚</p><h4 id="è¯´äº†è¿™ä¹ˆå¤š-é‚£-per-cpu-ptr-åˆ°åº•æ˜¯æ€ä¹ˆå¾—åˆ°å˜é‡çš„åœ°å€çš„" tabindex="-1">è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ <code>per_cpu_ptr()</code> åˆ°åº•æ˜¯æ€ä¹ˆå¾—åˆ°å˜é‡çš„åœ°å€çš„ï¼Ÿ <a class="header-anchor" href="#è¯´äº†è¿™ä¹ˆå¤š-é‚£-per-cpu-ptr-åˆ°åº•æ˜¯æ€ä¹ˆå¾—åˆ°å˜é‡çš„åœ°å€çš„" aria-label="Permalink to â€œè¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ per_cpu_ptr() åˆ°åº•æ˜¯æ€ä¹ˆå¾—åˆ°å˜é‡çš„åœ°å€çš„ï¼Ÿâ€">â€‹</a></h4><p>å…ˆæ˜ç™½è¿™å‡ ç‚¹ï¼š</p><ol><li>å¯¹äº static percpu å˜é‡ï¼Œunit0 çš„åŸºå€å°±æ˜¯ <code>pcpu_base_addr</code>ï¼Œä¹Ÿå°±æ˜¯ static percpu å˜é‡â€œçœŸæ­£â€çš„èµ·å§‹åœ°å€ã€‚</li><li>å¯¹äº dynamic percpu å˜é‡ï¼Œunit0 çš„åœ°å€å°±æ˜¯ <code>chunk-&gt;base_addr</code>ã€‚</li><li><code>pcpu_unit_offsets[N]</code> æ˜¯ unitN ç›¸å¯¹äº unit0 çš„åç§»ã€‚æ˜¾ç„¶ï¼Œ<code>pcpu_unit_offsets[0]</code> å€¼ä¸º 0ã€‚</li></ol><p>ç°åœ¨å¯ä»¥å¼„æ˜ç™½ <code>per_cpu_ptr()</code> å®äº†ï¼š</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">per_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr, cpu)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __per_cpu_offset[cpu]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_unit_offsets[cpu]</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* è§ setup_per_cpu_areas() */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __per_cpu_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_unit_offsets[cpu]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å¯¹äº static percpu å˜é‡ï¼Œå¯æ¨å¯¼å¾—ï¼š</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_unit_offsets[cpu] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __per_cpu_start</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> å˜é‡æ‰€åœ¨çš„unitçš„åŸºå€ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __per_cpu_start</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> å˜é‡æ‰€åœ¨çš„unitçš„åŸºå€ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> å˜é‡åœ¨unitå†…çš„åç§»</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>å¯¹äº dynamic percpu å˜é‡ï¼Œæ ¹æ® <code>pcpu_alloc_noprof()</code> å¯çŸ¥è¿”å›çš„ <code>ptr</code> æ˜¯ <code>__addr_to_pcpu_ptr(chunk-&gt;base_addr + off)</code>ï¼Œå¯æ¨å¯¼å¾—ï¼š</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> __addr_to_pcpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk-&gt;base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> å˜é‡åœ¨unitå†…çš„åç§») </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __per_cpu_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_unit_offsets[cpu]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk-&gt;base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> å˜é‡åœ¨unitå†…çš„åç§» </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __per_cpu_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __per_cpu_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_unit_offsets[cpu]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk-&gt;base_addr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pcpu_unit_offsets[cpu] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> å˜é‡åœ¨unitå†…çš„åç§»</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> å˜é‡æ‰€åœ¨çš„unitçš„åŸºå€ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> å˜é‡åœ¨unitå†…çš„åç§»</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æœ‰äº›äººåœ¨åšå®¢é‡Œæåˆ°ï¼Œé™æ€å’ŒåŠ¨æ€ percpu çš„è®¿é—®æ•ˆç‡ä¸ä¸€æ ·ï¼Œè¿™æ˜¯é”™è¯¯çš„ï¼Œéƒ½æ˜¯æŒ‡é’ˆ+åç§»é‡ï¼Œä¸å­˜åœ¨å•¥æ•ˆç‡å·®å¼‚ã€‚</p><h4 id="æ˜¯å¦‚ä½•æ”¯æŒ-cpu-hotplug-çš„" tabindex="-1">æ˜¯å¦‚ä½•æ”¯æŒ cpu hotplug çš„ï¼Ÿ <a class="header-anchor" href="#æ˜¯å¦‚ä½•æ”¯æŒ-cpu-hotplug-çš„" aria-label="Permalink to â€œæ˜¯å¦‚ä½•æ”¯æŒ cpu hotplug çš„ï¼Ÿâ€">â€‹</a></h4><p>ä½¿ç”¨ qemu å¯åŠ¨è™šæ‹Ÿæœºï¼ŒåŒ…å«å¦‚ä¸‹é€‰é¡¹ï¼Œ4 ä¸ª cpuï¼Œä½†æ˜¯æ”¯æŒæœ€å¤šçƒ­æ’æ‹”åˆ° 32 ä¸ªã€‚ å†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œè™½ç„¶åªå­˜åœ¨ 4 ä¸ª cpuï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œä¸ºäº†æ”¯æŒ cpu hotplugï¼Œnr_units æ˜¯ 32ï¼</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-smp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 4,sockets=2,dies=1,clusters=1,threads=1,maxcpus=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-numa</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node,nodeid=0,cpus=0-1,cpus=4-17,memdev=ram-node0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-numa</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node,nodeid=1,cpus=2-3,cpus=18-31,memdev=ram-node1</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ä½†è¿™å®é™…ä¸Šæµªè´¹äº†å†…å­˜ï¼Œ<code>pcpu_alloc_noprof()-&gt;pcpu_populate_chunk()-&gt;pcpu_alloc_pages()</code> é‡Œçš„ <code>for_each_possible_cpu() { alloc_pages_node() }</code> ä¸ºè¿˜æœªçƒ­æ’æ‹”çš„ cpu ä¹Ÿç”³è¯·äº†å†…å­˜ã€‚</p><p>åœ¨ç¤¾åŒºä¹Ÿæœ‰ç›¸å…³è®¨è®ºï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶ä¸ä¼šæµªè´¹å¤ªå¤šï¼Œè€Œä¸”æ²¡äººä¼šæŠŠ maxcpus è®¾ç½®çš„å¤ªå¤§ã€‚ <a href="https://lore.kernel.org/linux-mm/8E7F3D98-CB68-4418-8E0E-7287E8273DA9@vmware.com/" target="_blank" rel="noreferrer">Percpu allocator: CPU hotplug support - Alexey Makhalov</a></p><h2 id="todo" tabindex="-1">TODO <a class="header-anchor" href="#todo" aria-label="Permalink to â€œTODOâ€">â€‹</a></h2><ul class="contains-task-list"><li class="task-list-item"><input class="task-list-item-checkbox" disabled="" type="checkbox"> <code>pcpu_balance_workfn()</code> ç”¨äºé‡Šæ”¾ä¸€äº› chunk</li><li class="task-list-item"><input class="task-list-item-checkbox" disabled="" type="checkbox"> <code>percpu_alloc=page</code> cmdline <code>pcpu_page_first_chunk()</code> æ„Ÿè§‰ä¸ä¼šæœ‰ä»€ä¹ˆäººç”¨ï¼Œæ‡’å¾—çœ‹</li></ul><h2 id="å†å²" tabindex="-1">å†å² <a class="header-anchor" href="#å†å²" aria-label="Permalink to â€œå†å²â€">â€‹</a></h2><h3 id="patchset-x86-core-percpu-implement-dynamic-percpu-allocator-tejun-heo" tabindex="-1"><a href="https://lore.kernel.org/lkml/1234958676-27618-1-git-send-email-tj@kernel.org/" target="_blank" rel="noreferrer">[PATCHSET x86/core/percpu] implement dynamic percpu allocator - Tejun Heo</a> <a class="header-anchor" href="#patchset-x86-core-percpu-implement-dynamic-percpu-allocator-tejun-heo" aria-label="Permalink to â€œ[PATCHSET x86/core/percpu] implement dynamic percpu allocator - Tejun Heoâ€">â€‹</a></h3><h3 id="patchset-percpu-for-next-implement-and-use-sparse-embedding-first-chunk-allocator-tejun-heo" tabindex="-1"><a href="https://lore.kernel.org/all/1248171979-29166-1-git-send-email-tj@kernel.org/" target="_blank" rel="noreferrer">[PATCHSET percpu#for-next] implement and use sparse embedding first chunk allocator - Tejun Heo</a> <a class="header-anchor" href="#patchset-percpu-for-next-implement-and-use-sparse-embedding-first-chunk-allocator-tejun-heo" aria-label="Permalink to â€œ[PATCHSET percpu#for-next] implement and use sparse embedding first chunk allocator - Tejun Heoâ€">â€‹</a></h3>`,52)])])}const g=i(l,[["render",e]]);export{E as __pageData,g as default};
