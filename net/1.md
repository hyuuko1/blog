在 Linux 的源码中,网络设备驱动对应的逻辑位于 driver/net/ethernet,其中 Intel 系列网卡的驱动在 driver/net/ethernet/intel 目录下,协议栈模块代码位于 kerel 和 net 目录下。

## 初始化

## 收包流程

1. 中断处理函数

当 RingBuffer 满的时候,新来的数据包将被去弃。使用 iconfig 命令查看网卡的时候,可以看到里面有个 overruns,表示因为环形队列满被丢弃的包数。如果发现有丢包,可能需要通过 ethtool 命令来加大环形队列的长度。

2. net_rx_action
   1. 调用驱动注册的 NAPI poll 函数
      1. 取出数据
      2. napi_gro_receive 送往协议栈

网卡的 GRO 特性，可以简单理解成把相关的小包合并成一个大包，目的是减少传送给网络栈的包数，这有助于减少对 CPU 的使用量。

##

**同一链路**上的机器，要发送 IP 包时，就需要用 ARP 得到对方的 MAC 地址。

比如
如果要发到其他网段，就需要把包发到 192.168.0.1，首先需要知道网关的 mac 地址，得到了网关的 mac 地址才能填帧 header 的目的 MAC。
如果要发到本网段的，目的 MAC 就直接填目标机器的 MAC，也需要通过 ARP 来知道。
default via 192.168.0.1 dev wlp0s20f3 proto dhcp src 192.168.0.114 metric 600
192.168.0.0/24 dev wlp0s20f3 proto kernel scope link src 192.168.0.114 metric 600

##

根据以太网帧头部的类型编号：

- IPv4
- ARP
- IPv6
- SNMP over Ethernet
- PPPoE（实际上是二层？但是是基于以太网的）

可知，这些都是不同类型的 3 层协议。
