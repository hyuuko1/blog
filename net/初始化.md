## ksoftirqd 线程

`early_initcall(spawn_ksoftirqd);`

创建线程

```cpp
ret_from_fork_asm->ret_from_fork
  kernel_init->kernel_init_freeable->do_pre_smp_initcalls
    for (fn = __initcall_start; fn < __initcall0_start; fn++)
      do_one_initcall(initcall_from_entry(fn));
        //
        fn:spawn_ksoftirqd()
          smpboot_register_percpu_thread()
            for_each_online_cpu(cpu)
              __smpboot_create_thread()
```

线程执行

```cpp
ret_from_fork_asm->ret_from_fork
  kthread->smpboot_thread_fn
    run_ksoftirqd
```

## 网络设备子系统

net/core/dev.c

为 RX_SOFTIRQ 和 TX_SOFTIRQ 注册处理函数 net_rx_action 和 为 net_tx_action

`subsys_initcall(net_dev_init);`

```cpp
ret_from_fork_asm->ret_from_fork
  kernel_init->kernel_init_freeable->do_basic_setup->do_initcalls
    do_initcall_level->do_one_initcall
      //
      fn:net_dev_init()
        register_pernet_device(&loopback_net_ops)

        open_softirq(NET_TX_SOFTIRQ, net_tx_action);
        open_softirq(NET_RX_SOFTIRQ, net_rx_action);
```

##

subsys_initcall(proto_init);

## 协议栈（传输层和网络层）注册

net/ipv4/af_inet.c
`fs_initcall(inet_init);`

```cpp
ret_from_fork_asm->ret_from_fork
  kernel_init->kernel_init_freeable->do_basic_setup->do_initcalls
    do_initcall_level->do_one_initcall
      //
      fn:inet_init()
```

net/ipv6/af_inet6.c
`module_init(inet6_init);`

这两个里面注册了不同的 udp 和 tcp 协议。

内核实现了网络层的 IP 协议,也实现了传输层的 TCP 协议和 UDP 协议。

ARP 只适用于 ipv4，
ipv6 用的是 ICMPv6

## 邻居子系统

net/core/neighbour.c

`subsys_initcall(neigh_init);`

## 网卡驱动

注册 net_device_ops
注册 net_device
注册 ethtool_ops

注册 NAPI poll 函数 netif_napi_add

## 启动网卡

ifconfig ethO up

net_device_ops 中的 ndo_open 方法会被调用。

```cpp
entry_SYSCALL_64->do_syscall_64->do_syscall_x64->__x64_sys_ioctl->__se_sys_ioctl
  // 对任意一个 socket fd 进行 ioctl SIOCSIFFLAGS IFF_UP
  // https://man7.org/linux/man-pages/man7/netdevice.7.html
  __do_sys_ioctl->vfs_ioctl->sock_ioctl->sock_do_ioctl->inet_ioctl->devinet_ioctl
    dev_change_flags->__dev_change_flags->__dev_open->ndo_open:virtnet_open()
        try_fill_recv

```
