<!DOCTYPE html>
<html lang="zh-Hans" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GUP (Get User Page) | Blog</title>
    <meta name="description" content="Linux kernel å†…æ ¸ä»£ç åˆ†æï¼ŒåŸç†è¯¦è§£">
    <meta name="generator" content="VitePress v2.0.0-alpha.13">
    <link rel="preload stylesheet" href="/blog/assets/style.Cg8D8EfQ.css" as="style">
    <link rel="preload stylesheet" href="/blog/vp-icons.css" as="style">
    <script type="module" src="/blog/assets/chunks/metadata.e2231c71.js"></script>
    <script type="module" src="/blog/assets/app.DgFSTuZM.js"></script>
    <link rel="preload" href="/blog/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/blog/assets/chunks/theme.3WDp7bvS.js">
    <link rel="modulepreload" href="/blog/assets/chunks/framework.CdzZEkix.js">
    <link rel="modulepreload" href="/blog/assets/mm_gup.md.1Lp1A1Z9.lean.js">
    <link rel="icon" type="image/svg+xml" href="/blog/linux.svg">
    <link rel="icon" type="image/png" href="/blog/linux-32x32.png">
    <meta name="theme-color" content="#5f67ee">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:title" content="GUP (Get User Page) | Blog">
    <meta property="og:site_name" content="Linux kernel å†…æ ¸ä»£ç åˆ†æï¼ŒåŸç†è¯¦è§£">
    <meta property="og:url" content="https://hyuuko.vercel.app">
    <meta name="google-site-verification" content="OMML6xlbLb2Asitovo85pbOZGTvYoWaYWYW3ps7083s">
    <meta name="msvalidate.01" content="E3B108A75866D6C18B16BE35E14DE820">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-304c8b69><!--[--><!--]--><!--[--><span tabindex="-1" data-v-10d4d845></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-10d4d845>Skip to content</a><!--]--><!----><header class="VPNav" data-v-304c8b69 data-v-d5bf7c8e><div class="VPNavBar" data-v-d5bf7c8e data-v-8eab0e6d><div class="wrapper" data-v-8eab0e6d><div class="container" data-v-8eab0e6d><div class="title" data-v-8eab0e6d><div class="VPNavBarTitle has-sidebar" data-v-8eab0e6d data-v-d4488dd0><a class="title" href="/blog/" data-v-d4488dd0><!--[--><!--]--><!--[--><img class="VPImage logo" src="/blog/linux.svg" width="20" height="20" alt data-v-ab19afbb><!--]--><span data-v-d4488dd0>Blog</span><!--[--><!--]--></a></div></div><div class="content" data-v-8eab0e6d><div class="content-body" data-v-8eab0e6d><!--[--><!--]--><div class="VPNavBarSearch search" data-v-8eab0e6d><!--[--><!----><div id="local-search"><button type="button" aria-label="æœç´¢æ–‡æ¡£" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">æœç´¢æ–‡æ¡£</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-8eab0e6d data-v-020be4db><span id="main-nav-aria-label" class="visually-hidden" data-v-020be4db> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/blog/mm/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>å†…å­˜ç®¡ç†</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/net/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>ç½‘ç»œ</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/storage/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>å­˜å‚¨</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/process/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>è¿›ç¨‹</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/sched/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>è°ƒåº¦</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/irq/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>ä¸­æ–­</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/arch/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>ä½“ç³»ç»“æ„</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/debug/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>è°ƒè¯•</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/virtualization/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>è™šæ‹ŸåŒ–</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-020be4db data-v-d8fae6e2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-d8fae6e2><span class="text" data-v-d8fae6e2><!----><span data-v-d8fae6e2>æ‚é¡¹</span><span class="vpi-chevron-down text-icon" data-v-d8fae6e2></span></span></button><div class="menu" data-v-d8fae6e2><div class="VPMenu" data-v-d8fae6e2 data-v-fcd1d7a8><div class="items" data-v-fcd1d7a8><!--[--><!--[--><div class="VPMenuLink" data-v-fcd1d7a8 data-v-acfa8338><a class="VPLink link" href="/blog/other/index" data-v-acfa8338><!--[--><span data-v-acfa8338>å…¶ä»–</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-fcd1d7a8 data-v-acfa8338><a class="VPLink link" href="/blog/init/index" data-v-acfa8338><!--[--><span data-v-acfa8338>åˆå§‹åŒ–</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-fcd1d7a8 data-v-acfa8338><a class="VPLink link" href="/blog/pm/index" data-v-acfa8338><!--[--><span data-v-acfa8338>ç”µæºç®¡ç†</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-8eab0e6d data-v-3f90c1a5><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-3f90c1a5 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-8eab0e6d data-v-ef6192dc data-v-a1a7286e><!--[--><a class="VPSocialLink no-icon" href="https://github.com/hyuuko1/blog" aria-label="github" target="_blank" rel="me noopener" data-v-a1a7286e data-v-32d78712><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-8eab0e6d data-v-600b50c9 data-v-d8fae6e2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-d8fae6e2><span class="vpi-more-horizontal icon" data-v-d8fae6e2></span></button><div class="menu" data-v-d8fae6e2><div class="VPMenu" data-v-d8fae6e2 data-v-fcd1d7a8><!----><!--[--><!--[--><!----><div class="group" data-v-600b50c9><div class="item appearance" data-v-600b50c9><p class="label" data-v-600b50c9>ä¸»é¢˜</p><div class="appearance-action" data-v-600b50c9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-600b50c9 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-600b50c9><div class="item social-links" data-v-600b50c9><div class="VPSocialLinks social-links-list" data-v-600b50c9 data-v-a1a7286e><!--[--><a class="VPSocialLink no-icon" href="https://github.com/hyuuko1/blog" aria-label="github" target="_blank" rel="me noopener" data-v-a1a7286e data-v-32d78712><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-8eab0e6d data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-8eab0e6d><div class="divider-line" data-v-8eab0e6d></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-304c8b69 data-v-5ae341c6><div class="container" data-v-5ae341c6><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-5ae341c6><span class="vpi-align-left menu-icon" data-v-5ae341c6></span><span class="menu-text" data-v-5ae341c6>èœå•</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-5ae341c6 data-v-e28a51a6><button data-v-e28a51a6>å›åˆ°é¡¶éƒ¨</button><!----></div></div></div><aside class="VPSidebar" data-v-304c8b69 data-v-46b39de1><div class="curtain" data-v-46b39de1></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-46b39de1><span class="visually-hidden" id="sidebar-aria-label" data-v-46b39de1> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>å‰è¨€</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/update" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>æ›´æ–°è®¡åˆ’</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/gorman_book" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ UTLVMM (Linux 2.6)</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>æè¿°ç‰©ç†å†…å­˜</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/layout" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>å†…å­˜å¸ƒå±€</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/e820" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>e820</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/node" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>node</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/zone" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>zone</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/folio" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>struct page/folio è¯¦è§£</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/vmemmap" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>pfn_to_page() çš„åŸç†ï¼šmem_section ä¸ vmemmap</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>è™šæ‹Ÿå†…å­˜æ˜ å°„</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/rmap" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>rmap åå‘æ˜ å°„</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/vma" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>vma</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/mmap" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>mmap</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/vmap" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>vmap</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/kmap" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>kmap</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/pagefault" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>page fault</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/page_table" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ page table</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/ioremap" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ ioremap</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/fixmap" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ fixmap</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/highmem" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ highmem é«˜ç«¯å†…å­˜</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/cow" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ CoW (Copy on Write)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/uffd" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ UFFD (userfaultfd)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/shmem" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ share memory</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/tlb" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ tlb</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/dma_buf" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ dma-buf</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>å†…å­˜åˆ†é…</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/buddy" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>Buddy System: é¡µé¢åˆ†é…å™¨</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/vmalloc" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>vmalloc: ä¸è¿ç»­ç‰©ç†å†…å­˜åˆ†é…</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/percpu" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>per-cpu é™æ€å’ŒåŠ¨æ€åˆ†é…</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/oom" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>OOM (Out Of Memory)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/slub" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>SLUB å†…å­˜åˆ†é…å™¨</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/cma" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>CMA è¿ç»­å†…å­˜åˆ†é…å™¨</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/memblock" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ æ—©æœŸå†…å­˜åˆ†é…å™¨ memblock</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/gfp" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>GFP (Get Free Page)</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>å¤§é¡µ</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/hugetlb" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>HugeTLB æ ‡å‡†å¤§é¡µ</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/thp" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>THP (Transparent Huge Page) é€æ˜å¤§é¡µ</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/mthp" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>mTHP (Multi-size Transparent Huge Page)</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>å†…å­˜å›æ”¶</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/reclaim/reclaim" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>å†…å­˜å›æ”¶(åºŸå¼ƒ)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/reclaim/basic" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>å†…å­˜å›æ”¶åŸºç¡€</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/reclaim/lru" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>LRU</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/reclaim/mglru" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>MGLRU</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/reclaim/workingset" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>workingset</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/reclaim/swap" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>swap</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/mlock" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>mlock</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>å†…å­˜åç¢ç‰‡</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/anti-fragmentation" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ å†…å­˜åç¢ç‰‡</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/compaction" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ å†…å­˜è§„æ•´</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/page_migration" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>é¡µé¢è¿ç§»</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible has-active" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>å…¶ä»–</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/gup" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>GUP (Get User Page)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/pageflags" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>pageflags</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/madvise" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ madvise</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/ksm" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ KSM (Kernel Samepage Merging)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/hotplug" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ hotplug</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/virtio_mem" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ virtio mem</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/virtio_pmem" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ virtio pmem</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/virtio_balloon" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ virtio balloon</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>Non-Uniform Memory Access architecture</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/mm/mempolicy" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ Memory Policy å†…å­˜ç­–ç•¥</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a84b7c21><section class="VPSidebarItem level-0 collapsible" data-v-a84b7c21 data-v-6b36a2fd><div class="item" role="button" tabindex="0" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><h2 class="text" data-v-6b36a2fd>å†…å­˜ç®¡ç†ä¸æ–‡ä»¶ç³»ç»Ÿ</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-6b36a2fd><span class="vpi-chevron-right caret-icon" data-v-6b36a2fd></span></div></div><div class="items" data-v-6b36a2fd><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/storage/readahead" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ readahead é¢„è¯»</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/storage/pagecache" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ page cache</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/storage/page_writeback" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ page writeback</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/storage/tmpfs" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ tmpfs</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6b36a2fd data-v-6b36a2fd><div class="item" data-v-6b36a2fd><div class="indicator" data-v-6b36a2fd></div><a class="VPLink link link" href="/blog/storage/ramfs" data-v-6b36a2fd><!--[--><p class="text" data-v-6b36a2fd>ğŸš§ ramfs</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-304c8b69 data-v-2652e39a><div class="VPDoc has-sidebar has-aside" data-v-2652e39a data-v-d668f7cc><!--[--><!--]--><div class="container" data-v-d668f7cc><div class="aside" data-v-d668f7cc><div class="aside-curtain" data-v-d668f7cc></div><div class="aside-container" data-v-d668f7cc><div class="aside-content" data-v-d668f7cc><div class="VPDocAside" data-v-d668f7cc data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-c8b19031><div class="content" data-v-c8b19031><div class="outline-marker" data-v-c8b19031></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-c8b19031>ç›®å½•</div><ul class="VPDocOutlineItem root" data-v-c8b19031 data-v-63c57e50><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-d668f7cc><div class="content-container" data-v-d668f7cc><!--[--><!--]--><main class="main" data-v-d668f7cc><div style="position:relative;" class="vp-doc _blog_mm_gup external-link-icon-enabled" data-v-d668f7cc><div><h1 id="gup-get-user-page" tabindex="-1">GUP (Get User Page) <a class="header-anchor" href="#gup-get-user-page" aria-label="Permalink to â€œGUP (Get User Page)â€">â€‹</a></h1><ul><li><a href="https://docs.kernel.org/core-api/pin_user_pages.html" target="_blank" rel="noreferrer">pin_user_pages() and related calls â€” The Linux Kernel documentation</a></li><li><a href="https://cloud.tencent.com/developer/article/1681326" target="_blank" rel="noreferrer">å®‹å®åï¼šè®º Linux çš„é¡µè¿ç§»ï¼ˆPage Migrationï¼‰å®Œæ•´ç‰ˆ</a> GUP å’Œé¡µè¿ç§»æœ‰å…³ï¼Œè¿™é‡Œä¹Ÿæåˆ°äº† GUP</li><li><a href="https://lwn.net/Articles/787636/?utm_source=chatgpt.com" target="_blank" rel="noreferrer">get_user_pages(), pinned pages, and DAX [LWN.net]</a></li></ul><h2 id="gup-çŸ¥è¯†ç‚¹ä¸€è§ˆ" tabindex="-1">GUP çŸ¥è¯†ç‚¹ä¸€è§ˆ <a class="header-anchor" href="#gup-çŸ¥è¯†ç‚¹ä¸€è§ˆ" aria-label="Permalink to â€œGUP çŸ¥è¯†ç‚¹ä¸€è§ˆâ€">â€‹</a></h2><p>è¿™é‡Œåšä¸€ä¸‹ç®€è¦è®°å½•ï¼Œåé¢çš„æ®µè½å†è¯¦ç»†å‰–æ</p><p>æ ¸å¿ƒä½œç”¨ï¼šé€šè¿‡å¢åŠ é¡µé¢çš„å¼•ç”¨è®¡æ•° <code>page-&gt;_refcount</code>ï¼Œæ¥é˜»æ­¢å†…æ ¸å†…å­˜ç®¡ç†å­ç³»ç»Ÿå›æ”¶æˆ–ç§»åŠ¨è¿™ä¸ªé¡µé¢ã€‚ä¹Ÿå°±æ˜¯ï¼Œpin ä½ folioã€‚</p><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦é˜»æ­¢å›æ”¶å’Œç§»åŠ¨å‘¢ï¼Ÿåœºæ™¯ï¼š</p><ul><li>è®©ç”¨æˆ·ç©ºé—´å†…å­˜å®‰å…¨åœ°è¢«è®¾å¤‡ DMAã€‚ <ul><li>ä¸ºä»€ä¹ˆå†…æ ¸è‡ªèº«åˆ†é…çš„ buffer ç­‰å†…å­˜è¢«è®¾å¤‡ DMA å‰ï¼Œæ— éœ€ pin å‘¢ï¼Ÿå› ä¸ºè¿™äº›å†…å­˜æœ¬å°±ä¸ä¼šè¢«å›æ”¶æˆ–ç§»åŠ¨ã€‚</li><li>åœºæ™¯ <ul><li>MSG_ZEROCOPY <code>tcp_sendmsg_locked()-&gt;skb_zerocopy_iter_stream()-&gt;__zerocopy_sg_from_iter()-&gt;zerocopy_fill_skb_from_iter()-&gt;iov_iter_get_pages2()-&gt;__iov_iter_get_pages_alloc()-&gt;get_user_pages_fast()</code></li></ul></li></ul></li><li>è®©å†…æ ¸èƒ½å¤Ÿå®‰å…¨ã€æ­£ç¡®ã€é«˜æ•ˆåœ°ç›´æ¥è®¿é—®ç”¨æˆ·ç©ºé—´å†…å­˜ã€‚å‡½æ•°è°ƒç”¨åï¼Œç”¨æˆ·å†…å­˜å¯¹åº”çš„ struct page æŒ‡é’ˆè®°å½•åœ¨ pages æ•°ç»„å†…ï¼Œåœ¨ unpin ä¹‹å‰ï¼Œå†…æ ¸éƒ½å¯ä»¥é€šè¿‡ struct page å¾—åˆ°å¯¹åº”çš„ç›´æ¥æ˜ å°„åœ°å€ï¼Œå®‰å…¨é«˜æ•ˆåœ°è®¿é—®ã€‚</li></ul><p>GUP æ¶‰åŠåˆ°</p><ul><li>å¢åŠ é¢å¤–çš„å¼•ç”¨è®¡æ•°</li><li>ç¼ºé¡µå¤„ç†</li></ul><p>è¿˜æœ‰ä¸€äº›æ‚é¡¹ï¼Œæœ‰ç©ºå†™ä¸€ä¸‹</p><ul><li><code>xxx_fast()</code> ä¸éœ€è¦åŠ é”ã€‚</li><li>ä¸ huge pages å’Œ DAX ç›¸å…³çš„ï¼Œæš‚ä¸è®¨è®º</li></ul><h2 id="æ ¸å¿ƒæµç¨‹" tabindex="-1">æ ¸å¿ƒæµç¨‹ <a class="header-anchor" href="#æ ¸å¿ƒæµç¨‹" aria-label="Permalink to â€œæ ¸å¿ƒæµç¨‹â€">â€‹</a></h2><p>æœ€æ ¸å¿ƒçš„æµç¨‹åœ¨ <code>__get_user_pages_locked()-&gt;__get_user_pages()</code>ï¼Œæ–‡å­—å™è¿°ä¸‹</p><ol><li>locked å‚æ•°ç”¨äºæŒ‡ç¤ºï¼šè¿›å…¥æ­¤å‡½æ•°å‰ï¼Œæ˜¯å¦å·²ç» mmap_read_lock(mm) è·å–äº† mm-&gt;mmap_lock è¯»ä¿¡å·é‡ <ol><li>å¦‚æœä¸º 0ï¼Œè¡¨æ˜ caller è¦æ±‚æ­¤å‡½æ•°è·å–é”</li><li>å¦åˆ™ï¼Œè¡¨æ˜ caller å·²ç»è·å–é”äº†ã€‚æ­¤å¤„æ£€æŸ¥æ˜¯å¦çœŸçš„è·å–äº†ï¼Œæ²¡è·å–å°±ä¼š WARN</li></ol></li><li>å¦‚æœ FOLL_PINï¼Œä¼šè®¾ç½® mm-&gt;flags MMF_HAS_PINNEDã€‚ä½œç”¨ï¼š <ol class="contains-task-list"><li>åœ¨ folio_needs_cow_for_dma() ä¸­å¿«é€Ÿåˆ¤æ–­</li><li class="task-list-item"><input class="task-list-item-checkbox" disabled="" type="checkbox"> pte_is_pinned()</li></ol></li><li>å¾ªç¯ <code>__get_user_pages()</code></li></ol><h2 id="ç¼ºé¡µå¼‚å¸¸å¤„ç†" tabindex="-1">ç¼ºé¡µå¼‚å¸¸å¤„ç† <a class="header-anchor" href="#ç¼ºé¡µå¼‚å¸¸å¤„ç†" aria-label="Permalink to â€œç¼ºé¡µå¼‚å¸¸å¤„ç†â€">â€‹</a></h2><h3 id="ä¸ºä»€ä¹ˆä¼šæ¶‰åŠåˆ°-faultin-page-ç¼ºé¡µå¤„ç†" tabindex="-1">ä¸ºä»€ä¹ˆä¼šæ¶‰åŠåˆ° <code>faultin_page()</code> ç¼ºé¡µå¤„ç† <a class="header-anchor" href="#ä¸ºä»€ä¹ˆä¼šæ¶‰åŠåˆ°-faultin-page-ç¼ºé¡µå¤„ç†" aria-label="Permalink to â€œä¸ºä»€ä¹ˆä¼šæ¶‰åŠåˆ° faultin_page() ç¼ºé¡µå¤„ç†â€">â€‹</a></h3><p>GUP çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼šè·å–å¹¶å›ºå®šç”¨æˆ·è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†é¡µï¼Œä¾›å†…æ ¸æˆ–è®¾å¤‡é•¿æœŸè®¿é—®ã€‚ä½†ç”¨è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†é¡µå¯èƒ½å¹¶ä¸å­˜åœ¨äºå†…å­˜ä¸­ï¼š</p><ul><li>å°šæœªåˆ†é…</li><li>å·² swap out</li><li>æ–‡ä»¶æ˜ å°„ä½†æœªè¯»å…¥</li></ul><p>å› æ­¤ï¼Œè¦ä¸»åŠ¨æ¨¡æ‹Ÿç¼ºé¡µå¼‚å¸¸ï¼Œè¿›è¡Œå¤„ç†ã€‚</p><h3 id="ç¼ºé¡µå¤„ç†æ—¶-é‡åˆ°é˜»å¡æ—¶çš„å¤„ç†æµç¨‹" tabindex="-1">ç¼ºé¡µå¤„ç†æ—¶ï¼Œé‡åˆ°é˜»å¡æ—¶çš„å¤„ç†æµç¨‹ <a class="header-anchor" href="#ç¼ºé¡µå¤„ç†æ—¶-é‡åˆ°é˜»å¡æ—¶çš„å¤„ç†æµç¨‹" aria-label="Permalink to â€œç¼ºé¡µå¤„ç†æ—¶ï¼Œé‡åˆ°é˜»å¡æ—¶çš„å¤„ç†æµç¨‹â€">â€‹</a></h3><p>ç¼ºé¡µå¤„ç†è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé˜»å¡</p><p>TODO åç»­æŠŠè¿™ä¸ªè¡¥å……åˆ° <a href="./pagefault">pagefault</a></p><ul><li>å¦‚æœè®¾ç½®äº† <code>FOLL_UNLOCKABLE</code>ï¼Œä¼šå½±å“ handle_mm_fault() æ—¶çš„ fault_flags å‚æ•°ï¼š <ul><li>ä¼šå¸¦ä¸Š <code>FAULT_FLAG_ALLOW_RETRY</code>ï¼Œå…è®¸è¿”å› <code>VM_FAULT_RETRY</code>ï¼Œ</li><li>ä¼šå¸¦ä¸Š <code>FAULT_FLAG_KILLABLE</code>ï¼Œå…è®¸è¢« kill</li></ul></li><li>å¦‚æœè®¾ç½®äº† <code>FOLL_NOWAIT</code>ï¼Œä¼šå¸¦ä¸Š <code>FAULT_FLAG_RETRY_NOWAIT</code> ä½¿å¾—é‡åˆ°é˜»å¡ä¼šç›´æ¥å¤±è´¥</li></ul><p>è¿™é‡Œåªä¸¾ä¸¤ä¸ª fault çš„ä¾‹å­ï¼Œ</p><ol><li>filemap_fault()-&gt;lock_folio_maybe_drop_mmap()</li></ol><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lock_folio_maybe_drop_mmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /*  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">folio_trylock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(folio))</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* æˆåŠŸè¿”å› */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (vmf-&gt;flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FAULT_FLAG_RETRY_NOWAIT)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ retryï¼Œåˆ™ unlock mmap_lock ä½¿å¾—å…¶ä»–åœ°æ–¹å¯ä»¥è·å–è¿™é”ï¼Œè¿›è¡Œ ioï¼Ÿ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fpin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> maybe_unlock_mmap_for_io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /*  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (vmf-&gt;flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FAULT_FLAG_KILLABLE) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__folio_lock_killable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(folio)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fpin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    release_fault_lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(vmf);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* æ²¡æ‡‚è¿™é‡Œ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* è·å–é”ï¼Œé˜»å¡ç¡çœ  */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  __folio_lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(folio);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* æˆåŠŸè¿”å›ï¼Œä½†æ˜¯å·²ç»é‡Šæ”¾äº† mmap_lock å¹¶ä¸” fpin æŒ‡å‘äº† pinned fileï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     æ‰€ä»¥åœ¨ filemap_fault() é‡Œæ˜¯ä¼š folio_unlock() goto out_retry è¿”å› VM_FAULT_RETRY çš„ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ol start="2"><li>do_swap_page()-&gt;folio_lock_or_retry() ä¹Ÿå·®ä¸å¤š</li></ol><p>å¦‚æœé˜»å¡äº†ï¼Œä¼šé‡Šæ”¾ mmap_lockï¼Œç„¶åç­‰åˆ° folio unlock çš„æƒ…å†µä¸‹è¿”å› VM_FAULT_RETRYã€‚</p><h2 id="å¦‚ä½•é˜²æ­¢è¢«å›æ”¶çš„" tabindex="-1">å¦‚ä½•é˜²æ­¢è¢«å›æ”¶çš„ï¼Ÿ <a class="header-anchor" href="#å¦‚ä½•é˜²æ­¢è¢«å›æ”¶çš„" aria-label="Permalink to â€œå¦‚ä½•é˜²æ­¢è¢«å›æ”¶çš„ï¼Ÿâ€">â€‹</a></h2><p>åœ¨å†…å­˜å›æ”¶æ—¶ï¼Œåœ¨å®Œæˆ <code>shrink_folio_list()-&gt;try_to_unmap()</code> ç§»é™¤æ‰€æœ‰è¿›ç¨‹é¡µè¡¨æ˜ å°„ï¼Œå‡å°‘è¿™äº›å¸¦æ¥çš„ refcount åï¼Œ</p><ul><li>å¯¹äºåŒ¿åé¡µï¼Œ<code>shrink_folio_list()-&gt;folio_ref_freeze()</code> ä¼šè¿”å› false</li><li>å¯¹äºæ–‡ä»¶é¡µï¼Œ<code>shrink_folio_list()-&gt;__remove_mapping()-&gt;folio_ref_freeze()</code> ä¼šè¿”å› false</li></ul><h2 id="å¦‚ä½•-pin-ä½å†…å­˜ä¸è¢«ç§»åŠ¨çš„" tabindex="-1">å¦‚ä½• pin ä½å†…å­˜ä¸è¢«ç§»åŠ¨çš„ï¼Ÿ <a class="header-anchor" href="#å¦‚ä½•-pin-ä½å†…å­˜ä¸è¢«ç§»åŠ¨çš„" aria-label="Permalink to â€œå¦‚ä½• pin ä½å†…å­˜ä¸è¢«ç§»åŠ¨çš„ï¼Ÿâ€">â€‹</a></h2><p><code>get/pin_user_pages()</code> å‡½æ•°ï¼Œå½“ pages å‚æ•°ä¸ä¸º NULL æ—¶ï¼Œéƒ½ä¼š pin å†…å­˜ã€‚ å¦‚æœ pages å‚æ•°æ˜¯ NULLï¼Œåˆ™åªä¿è¯è§¦å‘ç¼ºé¡µå¤„ç†ï¼Œä¸ä¼šå» pin å†…å­˜ã€‚</p><p>å¦‚ä½•åšåˆ° pin å†…å­˜çš„ï¼Ÿ try_grab_folio() çš„ FOLL_GET/FOLL_PIN éƒ½ä¼šå¢åŠ é¢å¤–çš„å¼•ç”¨è®¡æ•°ã€‚</p><p>ä»¥å†…å­˜è§„æ•´æµç¨‹æ—¶çš„é¡µé¢è¿ç§»ä¸ºä¾‹ï¼Œæ£€æµ‹åˆ°å­˜åœ¨ unexpected referencesï¼Œå°±ä¼š return -EAGAIN ä¸è¿›è¡Œé¡µé¢è¿ç§»ã€‚</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">compact_zone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  migrate_pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">migrate_pages_batch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">migrate_folios_move</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">migrate_folio_move</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    move_to_new_folio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">migrate_folio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__migrate_folio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* detect unexpected references (e.g., GUP or other temporary references) */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      expected_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> folio_expected_ref_count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(src) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">folio_ref_count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(src) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> expected_count)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EAGAIN;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      folio_mc_copy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dst, src);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      __folio_migrate_mapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="foll-get-foll-pin-æœ‰ä½•åŒºåˆ«" tabindex="-1">FOLL_GET/FOLL_PIN æœ‰ä½•åŒºåˆ« <a class="header-anchor" href="#foll-get-foll-pin-æœ‰ä½•åŒºåˆ«" aria-label="Permalink to â€œFOLL_GET/FOLL_PIN æœ‰ä½•åŒºåˆ«â€">â€‹</a></h2><p>FOLL_PIN å’Œ FOLL_GET æ˜¯äº’æ–¥çš„ï¼Œä¸èƒ½åŒæ—¶ä½¿ç”¨ã€‚</p><p>ä¼šå½±å“ folio_maybe_dma_pinned() çš„ç»“æœã€‚</p><ul><li>å¯¹äº FOLL_PINï¼Œä¸€å®šè¿”å› trueï¼›</li><li>å¯¹äº FOLL_GETï¼Œåˆ™æ˜¯<strong>å¤§æ¦‚ç‡</strong>è¿”å› falseï¼Œè™½ç„¶å°æ¦‚ç‡è¿”å› trueï¼Œä½†å¯ä»¥å®¹å¿è¿™ç§å°é”™è¯¯ã€‚</li></ul><hr><p><code>__get_user_pages()</code> çš„æ³¨é‡Šï¼Œ</p><p>è¿”å›æˆåŠŸ pin çš„ page æ•°é‡ï¼Œæˆ–è€…é”™è¯¯ã€‚ è°ƒç”¨æ—¶å¿…é¡»æŒæœ‰ mmap_lockã€‚ å¦‚æœæœ‰ FOLL_UNLOCKABLE ä½†æ˜¯æ²¡æœ‰ FOLL_NOWAITï¼Œé‚£ä¹ˆ mmap_lock ä¹Ÿè®¸ä¼šè¢«é‡Šæ”¾ï¼Œæ­¤æ—¶ locked ä¼šè¢«ç½® 0</p><p>éå†è¿›ç¨‹çš„é¡µè¡¨ï¼Œå¹¶ä¸ºæ¯ä¸ªç”¨æˆ·åœ°å€æ­¤æ—¶å¯¹åº”çš„ page å¢åŠ å¼•ç”¨è®¡æ•°ã€‚ æ³¨æ„ï¼Œè¯¥å‡½æ•°ä¸èƒ½é¿å…è¿™ç§æƒ…å†µï¼š åœ¨æ­¤å‡½æ•°è¿”å›æ—¶ï¼Œå¯èƒ½ç”¨æˆ·çš„å…¶ä»–çº¿ç¨‹å°± unmap äº†ï¼Œå¯¼è‡´ç”¨æˆ·æ²¡æœ‰æ˜ å°„è¯¥ pageã€‚</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__get_user_pages_locked</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__get_user_pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> follow_page_mask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    follow_page_pte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vm_normal_page</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(vma, address, pte);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      folio </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> page_folio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(page);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      try_grab_folio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(folio, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, flags);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* å¦‚æœè¿”å›çš„ page æ˜¯ NULLï¼Œå°±éœ€è¦ faultin_page()ï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     å¦‚æœæˆåŠŸ faultin_page() äº†ï¼Œå°± retry é‡æ–° follow_xxx å¾—åˆ° page */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  faultin_page</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="foll-longterm" tabindex="-1">FOLL_LONGTERM <a class="header-anchor" href="#foll-longterm" aria-label="Permalink to â€œFOLL_LONGTERMâ€">â€‹</a></h2><p>FOLL_LONGTERMï¼Œå…¶æ ¸å¿ƒä½œç”¨æ˜¯ä¸ºäº†é˜²æ­¢é•¿æœŸ pin æ—¶ï¼Œä¸€ç›´ä¸èƒ½ç§»åŠ¨ï¼Œå¯èƒ½é€ æˆç¢ç‰‡åŒ–ã€‚</p><p>åªæœ‰åœ¨ç”¨äº† FOLL_PIN æ—¶ï¼Œæ‰å…è®¸ä½¿ç”¨ FOLL_LONGTERM</p><p>æ ¹æ®æˆ‘çœ‹çš„ä»£ç ï¼Œä¼ å…¥ FOLL_LONGTERM å¹¶æ²¡æœ‰å¢åŠ é¡µçš„å›ºå®šè®¡æ•°ï¼Œè€Œæ˜¯è¿›è¡Œäº† memalloc_pin_save() å’Œ check_and_migrate_movable_pages()ï¼Œç¡®ä¿è¢« pin çš„é¡µé¢çš„ migratetype éƒ½æ˜¯ MIGRATE_UNMOVABLE çš„ï¼Œå¹¶ä¸”ä¸åœ¨ ZONE_MOVABLE å†…ã€‚ ç›¸å…³çš„å‡½æ•°æœ‰ï¼š</p><ol><li>collect_longterm_unpinnable_folios() æ”¶é›†ä¸å¯é•¿æœŸ pin çš„ folios</li><li>folio_is_longterm_pinnable() åˆ¤æ–­è¯¥ folio æ˜¯å¦æ˜¯å¯ä»¥é•¿æœŸ pin çš„</li><li>migrate_longterm_unpinnable_folios() å°†ä¸å¯é•¿æœŸ pin çš„ foliosï¼Œå…ˆè¿›è¡Œ unpinï¼Œç„¶åå† migrate_pages()å°† folio è¿ç§»ï¼Œè¿ç§»çš„ target ç”± alloc_migration_target()åˆ†é…</li></ol><p>æ‰€ä»¥ï¼Œä½•æ—¶åº”ä½¿ç”¨ FOLL_LONGTERM ? æˆ‘è®¤ä¸ºæ˜¯å½“ç”¨æˆ·è®¤ä¸º pages ä¼šè¢«é•¿æœŸå›ºå®šä½æ—¶ï¼Œéœ€è¦ä½¿ç”¨ FOLL_LONGTERM ä½œä¸ºä¸€ä¸ªæç¤ºï¼Œè®©å†…æ ¸ä¿è¯é¡µé¢çš„ migratetype éƒ½æ˜¯ MIGRATE_UNMOVABLE çš„ï¼Œå¹¶ä¸”ä¸åœ¨ ZONE_MOVABLE å†…ã€‚ æˆ‘çš„ç†ç”±ï¼šè¿™æ˜¯ä¸ºäº†é˜²æ­¢é•¿æœŸçš„é¡µé¢å›ºå®šå¯¼è‡´é•¿æœŸçš„å†…å­˜ç¢ç‰‡åŒ–ã€‚</p><p>vfio å’Œ vhost-vdpa è°ƒç”¨ pin_user_pages æ—¶ï¼Œéƒ½ç”¨äº†è¿™ä¸ª flagï¼Œ å› ä¸ºæ˜¯è™šæ‹Ÿæœºçš„å†…å­˜ï¼Œè‚¯å®šæ˜¯ä¼š pin å¾ˆä¹…çš„ã€‚</p><h2 id="foll-unlockable" tabindex="-1">FOLL_UNLOCKABLE <a class="header-anchor" href="#foll-unlockable" aria-label="Permalink to â€œFOLL_UNLOCKABLEâ€">â€‹</a></h2><p>å…³äº FOLL_UNLOCKABLEï¼Œå…è®¸ gup çš„è¿‡ç¨‹ä¸­åœ¨ faultin_page() é‡Œå› ä¸€äº›åŸå› é‡Šæ”¾ mmap_lockã€‚</p><ol><li>ä½•æ—¶è®¾ç½®çš„ï¼Ÿå½“ç”¨æˆ·è°ƒç”¨çš„æ˜¯ <code>pin_user_pages_unlocked()</code> æ—¶</li><li>å¦‚ä½•å½±å“ handle_mm_fault() çš„ï¼Ÿæ ¹æ® faultin_page() çš„æ³¨é‡Šï¼Œå¦‚æœæœ‰ FOLL_UNLOCKABLE ä½†æ˜¯æ²¡æœ‰ FOLL_NOWAITã€‚å°±ä¼šä½¿å¾— faultin_page() é‡Œå½“ folio_trylock() å¤±è´¥æ—¶ï¼ˆä½•ç§æƒ…å†µä¸‹ä¼š folio è¢« lock äº†å‘¢ï¼Ÿæ–‡ä»¶é¡µå†™å›ï¼Ÿï¼‰ï¼Œé‡Šæ”¾ mmap_lock å‡å°‘äº‰ç”¨ï¼Œå¹¶è¿”å› VM_FAULT_RETRY æˆ– VM_FAULT_COMPLETEDã€‚å¦‚æœçœŸé‡Šæ”¾äº†ï¼ŒæŠŠ locked æ”¹ä¸º 0ã€‚ å…·ä½“é‡Šæ”¾çš„ä»£ç ä½ç½®ï¼š<code>__folio_lock_or_retry()/maybe_unlock_mmap_for_io()/__folio_lock_or_retry()/lock_folio_maybe_drop_mmap()</code>ã€‚</li></ol><h2 id="pg-anon-exclusive" tabindex="-1">PG_anon_exclusive <a class="header-anchor" href="#pg-anon-exclusive" aria-label="Permalink to â€œPG_anon_exclusiveâ€">â€‹</a></h2><ol><li>PG_anon_exclusive æ²¡ææ‡‚ã€‚do_wp_page()-&gt;wp_can_reuse_anon_folio() é‡Œï¼Œå¦‚æœ folio_ref_count(folio) ä¸æ˜¯ 1ï¼Œé‚£å°± return falseï¼Ÿ ä¸ºä»€ä¹ˆè¿™æ ·åˆ¤æ–­ï¼Ÿå¦‚æœ gup äº†ï¼Œå°±ä¸èƒ½ reuse å—ã€‚ éš¾é“ä¸åº”è¯¥æ˜¯åˆ¤æ–­ mapcountï¼Œå½“ç¡®è®¤åªæœ‰ä¸€ä¸ª mapcount æ—¶ï¼Œå°± reuse å—ï¼Ÿ</li></ol><p><code>__folio_try_share_anon_rmap()</code> é‡Œ PageAnonExclusive å’Œ GUP æœ‰ä½•å…³ç³»ï¼Ÿ</p><h2 id="mlock" tabindex="-1">mlock() <a class="header-anchor" href="#mlock" aria-label="Permalink to â€œmlock()â€">â€‹</a></h2><ol><li>mlock çš„ä½œç”¨ï¼šé˜²æ­¢å†…å­˜è¢«äº¤æ¢å‡ºå»</li><li>mlock() çš„ä»£ç æµç¨‹ï¼š <ol><li>ä¼šå¯¹æŒ‡å®šçš„åœ°å€åŒºé—´çš„ vma è¿›è¡Œ splitï¼Œç„¶åå¯¹è¿™ä¸ª vma è®¾ç½® VM_LOCKED flagï¼Œ</li><li>è°ƒç”¨ gup APIï¼Œ <ol><li>ä½†æ˜¯ pages å‚æ•°æ˜¯ NULLï¼Œå› æ­¤ä¸ä¼šé¢å¤–å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼š pin å†…å­˜ã€‚</li><li>åœ¨ gup çš„ faultin_page() æµç¨‹ä¸­ï¼Œä¼šåœ¨ folio_add_lru_vma() æ—¶ folio_set_mlocked() è®¾ç½® PG_mlocked å¹¶æ”¾è¿› mlock_fbatch</li></ol></li><li>åç»­æŸä¸€æ—¶åˆ»åœ¨ lru_add() æ—¶ä¼š folio_evictable() åˆ¤æ–­ PG_mlocked å¾—çŸ¥æ˜¯ä¸å¯äº¤æ¢çš„ï¼Œæ‰€ä»¥ä¼š folio_set_unevictable(folio); ç–‘é—®ï¼šPG_mlocked å’Œ PG_unevictable æœ‰ä½•åŒºåˆ«ï¼Ÿæˆ‘çš„ç†è§£æ˜¯ï¼šPG_mlocked ä¸€å®šæ˜¯ PG_unevictable çš„ï¼Œä½†åä¹‹åˆ™ä¸å¯¹ã€‚ å› ä¸ºå¯¹äºæ‰€åœ¨ struct address_space æœ‰ AS_UNEVICTABLE flag çš„ folio è€Œè¨€ï¼Œè¯¥ folio æ˜¯ PG_unevictable çš„ã€‚</li></ol></li></ol><p>æ³¨æ„ï¼Œ<code>populate_vma_page_range()</code> å¹¶æœªä¼ å…¥ FOLL_GET æˆ– FOLL_PIN å‚æ•°ã€‚</p></div></div></main><footer class="VPDocFooter" data-v-d668f7cc data-v-1bcd8184><!--[--><!--]--><div class="edit-info" data-v-1bcd8184><div class="edit-link" data-v-1bcd8184><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/hyuuko1/blog/edit/main/mm/gup.md" target="_blank" rel="noreferrer" data-v-1bcd8184><!--[--><span class="vpi-square-pen edit-link-icon" data-v-1bcd8184></span> Edit this page<!--]--></a></div><div class="last-updated" data-v-1bcd8184><p class="VPLastUpdated" data-v-1bcd8184 data-v-73dafb42>æœ€åæ›´æ–°äº: <time datetime="2025-11-23T15:44:07.000Z" data-v-73dafb42></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-1bcd8184><span class="visually-hidden" id="doc-footer-aria-label" data-v-1bcd8184>Pager</span><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link prev" href="/blog/mm/page_migration" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>ä¸Šä¸€é¡µ</span><span class="title" data-v-1bcd8184>é¡µé¢è¿ç§»</span><!--]--></a></div><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link next" href="/blog/mm/pageflags" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>ä¸‹ä¸€é¡µ</span><span class="title" data-v-1bcd8184>pageflags</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-304c8b69 data-v-5b9946f5><div class="container" data-v-5b9946f5><p class="message" data-v-5b9946f5>Licensed under MIT</p><p class="copyright" data-v-5b9946f5>Copyright Â© 2024-2025 HYUUKO</p></div></footer><!--[--><!--]--></div></div>
    
    
  </body>
</html>