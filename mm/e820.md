# e820

- [e820 ä»ç¡¬ä»¶è·å–å†…å­˜åˆ†å¸ƒ | Kernel Exploring](https://richardweiyang-2.gitbook.io/kernel-exploring/nei-cun-guan-li/00-memory_a_bottom_up_view/01-e820_retrieve_memory_from_hw)
- ğŸŒŸ [E820 å†…å­˜ç®¡ç†å™¨](http://www.biscuitos.cn/blog/MMU-E820/)
- [E820 on seaBIOS](http://www.biscuitos.cn/blog/MMU-seaBIOS_E820/)
- [E820 on Qemu/KVM](http://www.biscuitos.cn/blog/MMU-QEMU-KVM_E820/)
- [Detecting Memory (x86) - OSDev Wiki](<https://wiki.osdev.org/Detecting_Memory_(x86)>)
- ğŸŒŸã€ŠQEMU/KVM æºç è§£æä¸åº”ç”¨ã€‹
  - 3.2 fw_cfg è®¾å¤‡ä»‹ç»
  - 3.4 SeaBIOS åˆ†æ

## QEMU fw_cfg

[sebios.md](/bios/seabios.md#qemu-fw_cfg)

QEMU/KVM ä½œä¸ºè™šæ‹ŸåŒ–æ ¸å¿ƒç»„å»ºï¼Œå…¶å¯ä»¥ç”¨äºæ¨¡æ‹Ÿ X86 è¿è¡Œç¯å¢ƒï¼Œå› æ­¤å…¶å…·å¤‡æ„å»º X86 å¹³å°ç¡¬ä»¶ä¿¡æ¯çš„èƒ½åŠ›ï¼ŒQEMU/KVM åŒæ ·æä¾›äº†åˆ›å»º E820 çš„æœºåˆ¶ï¼Œç”¨äºä¸º seaBIOS æ¨¡æ‹Ÿ E820 ç›¸å…³çš„ç¡¬ä»¶ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬äº† BIOS çš„ CMOS å†…å­˜ï¼Œhw_cfg å›ºä»¶ä¿¡æ¯ç­‰ã€‚

## seabios

[sebios.md](/bios/seabios.md)

BIOS POST (Power On Self Test) ä¸Šç‚¹è‡ªæ£€ä¹‹åï¼Œä¼šä» CMOS ä¸­è·å¾—å†…å­˜ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ç”¨äºæ„å»º BIOS çš„ BDA/EBDA ä¿¡æ¯ï¼Œä»¥ä¾¿ BIOS æ„å»ºè‡ªå·±çš„ E820 è¡¨ï¼ŒBIOS æ„å»ºçš„ E820 è¡¨æ„å»ºå®Œæ¯•ä¹‹åä¼šå°† E820 è¡¨é‡Œçš„å†…å­˜åŒºåŸŸä¸ BIOS IVT çš„ 0x15/E820 ä¸­æ–­ä¾‹ç¨‹è¿›è¡Œç»‘å®šï¼Œå½“å†…æ ¸åˆå§‹åŒ–æ—¶é€šè¿‡ä¸ BIOS IVT è¿›è¡Œäº¤äº’ï¼ŒBIOS å°† E820 è¡¨ä¼ é€’ç»™äº†å†…æ ¸ã€‚BIOS åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¹Ÿä¼šé¢„ç•™ä¸€äº›å†…å­˜åŒºåŸŸï¼Œè¿™äº›å†…å­˜åŒºåŸŸä¹Ÿä¼šä¸€åŒä¼ é€’ç»™å†…æ ¸ã€‚

```cpp
reset_vector->entry_post->dopost->maininit->interface_init
  qemu_cfg_init
    qemu_cfg_e820
      /* é€šè¿‡ qemu çš„ fw_cfg æ¥å£ï¼Œè·å– e820 table  */
      qemu_cfg_read_entry
      e820_add
```

seabios åœ¨ IVT é‡Œæä¾›äº†å¾ˆå¤šä¸­æ–­å…¥å£ã€‚

åœ¨ X86 æ¶æ„ Linux å†…æ ¸å‘å±•çš„è¿‡ç¨‹ä¸­ï¼Œç‰©ç†å†…å­˜æ”¯æŒçš„é•¿åº¦ä» 16MB å‘å±•åˆ° 64MBã€4GB å†åˆ°ä»Šå¤©æ”¯æŒ 64-bit çš„åœ°å€æ€»çº¿ï¼ŒBIOS åœ¨ä¸åŒçš„å†å²é˜¶æ®µæä¾›äº†ä¸åŒçš„ä¸­æ–­è°ƒç”¨ï¼Œ ä»¥æ»¡è¶³å†…æ ¸ä» BIOS ä¸­è·å¾—å†…å­˜åŒºåŸŸç›¸å…³çš„ä¿¡æ¯ã€‚
linux å‘èµ· int 0x15 ä¸­æ–­ï¼Œé€šè¿‡ BIOS ä¸­æ–­ä¾‹ç¨‹æ¢æµ‹ç‰©ç†å†…å­˜

```cpp
handle_15
handle_15e8
handle_15e820
```

## è¿›å…¥ vmlinux å‰ï¼ˆå®æ¨¡å¼ï¼‰

linux kernel åœ¨å®æ¨¡å¼è¿›è¡Œæœ€æ—©æœŸçš„åˆå§‹åŒ–ï¼Œé€šè¿‡ BIOS æä¾›çš„ IVT è¡¨åˆ†åˆ«ä» 0x15/0xE820ã€0x15/0xE801 ä»¥åŠ 0x15/0x88 ä¸­è·å¾—ç‰©ç†å†…å­˜ä¿¡æ¯ï¼Œå¹¶å°†ä¿¡æ¯å­˜å‚¨åœ¨ boot_params æ•°æ®ç»“æ„é‡Œé¢ã€‚ä¹‹åè¿›å…¥ä¿æŠ¤æ¨¡å¼ã€‚

```cpp
/* arch/x86/boot/main.c è¢«ç¼–è¯‘è¿› setup.elf äº†
   æ­¤æ—¶åœ¨å®æ¨¡å¼
*/
main
  detect_memory
    detect_memory_e820();
      /* é€šè¿‡ BIOS INT 0x15/E820 è°ƒç”¨è·å¾—ç³»ç»Ÿå†…å­˜å¸ƒå±€ä¿¡æ¯ */
      ireg.ax  = 0xe820;
      intcall(0x15, &ireg, &oreg);
      boot_params.e820_entries = count;
    detect_memory_e801();
    detect_memory_88();
```

æœ‰ä¸¤ä¸ªåœ°æ–¹å®šä¹‰äº† boot_params å˜é‡ï¼Œåˆ†åˆ«æ˜¯ setup.bin å’Œ vmlinux.bin é‡Œï¼ˆè¿™ä¸¤ä¸ªä¼šå¹¶æˆ bzImageï¼‰ã€‚
æ˜¯ setup.bin é‡Œçš„ boot_params å…ˆåˆå§‹åŒ–ï¼Œç„¶åä¼šæŠŠ boot_params ä¼ ç»™ vmlinuxï¼š

```cpp
/* setup.bin é‡Œ */
go_to_protected_mode
  /* æŠŠ arch/x86/boot/main.c é‡Œçš„ boot_params çš„åœ°å€ä¼ è¿‡å»äº†ï¼ˆç¬¬äºŒä¸ªå‚æ•°ï¼‰ */
  protected_mode_jump
    /* ç„¶åè¿›å…¥ä¿æŠ¤æ¨¡å¼è·³è½¬åˆ° setup.bin çš„ startup_64 !
    https://docs.hust.openatom.club/linux-insides-zh/booting/linux-bootstrap-4 */

startup_64
  /* æŠŠ arch/x86/boot/main.c é‡Œçš„ boot_params çš„åœ°å€ä¼ åˆ°äº†è¿™ä¸ªå‡½æ•° */
  __startup_64
  common_startup_64
    early_setup_idt
    initial_code ä¹Ÿå³ x86_64_start_kernel
      copy_bootdata
        /* æŠŠ arch/x86/boot/main.c é‡Œçš„ boot_params æ‹·è´åˆ° arch/x86/kernel/setup.c
           é‡Œçš„ boot_params */
        /* å¦‚æœæ˜¯ CONFIG_PVHï¼Œåˆ™æ˜¯æ‹·è´äº† pvh_bootparams  */
        memcpy(&boot_params, real_mode_data, sizeof(boot_params));
      x86_64_start_reservations->start_kernel
```

å¦‚æœä¸ç”¨ bzImage å¯åŠ¨ï¼ˆCONFIG_PVHï¼‰ï¼Œè€Œæ˜¯ç›´æ¥ç”¨ vmlinux å¯åŠ¨ï¼Œé‚£åˆ™æ˜¯åœ¨ init_pvh_bootparams é‡Œåˆå§‹åŒ–çš„ï¼Ÿ

## è¿›å…¥ vmlinux åï¼ˆä¿æŠ¤æ¨¡å¼ï¼‰

å†…æ ¸åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå®æ—¶æ¨¡å¼ä¸­ä» BIOS ä¸­è·å¾—å¹¶æ„å»º E820 è¡¨ï¼Œç„¶åç»“åˆ CMDLINE å‚æ•°å’Œ boot_paras å‚æ•°æ„å»ºå†…æ ¸è‡ªèº«çš„ E820 è¡¨ï¼Œå¹¶åŸºäºè¯¥è¡¨æ„å»ºç³»ç»Ÿçš„ IORESOURCE ä¿¡æ¯å’Œå›ºä»¶ä¿¡æ¯ï¼Œæœ€ååŸºäº E820 è¡¨ä¸­å¯ç”¨å†…å­˜åŒºåŸŸä¿¡æ¯æ„å»º BootMEM æˆ–è€… MEMBLOCK å†…å­˜åˆ†é…å™¨ã€‚

æ„å»º e820_tableã€e820_table_kexec å’Œ e820_table_firmware ä¸‰ä¸ªè¡¨ï¼Œå¹¶å°† e820_table æŒ‰ä¸€å®šçš„é¡ºåºè¿›è¡Œæ’åºã€‚å¤„ç†å®Œè¡¨ä¹‹åï¼Œ å†…æ ¸è®¡ç®—å‡º max_pfn/max_low_pfn/high_memory ä¸‰ä¸ªå˜é‡çš„å€¼ï¼Œæ¥ç€å†…æ ¸å°† e820_table çš„å¯ç”¨å†…å­˜åŒºåŸŸæ·»åŠ åˆ° MEMBLOCK åˆ†é…å™¨ï¼ŒMEMBLOCK åˆ†é…å™¨ä»¥è¿™äº›ä¿¡æ¯ä¸ºåŸºç¡€æ„å»ºå†…æ ¸ ç¬¬ä¸€ä¸ªå†…å­˜åˆ†é…å™¨ã€‚å†…æ ¸æ¥ç€å°† e820_table ä¸­çš„é¢„ç•™åŒºåŸŸæ’å…¥åˆ° iomem_resource è¿›è¡Œ ç®¡ç†ï¼Œå¹¶å°† e820_table_firmware åŠ å…¥ç³»ç»Ÿå›ºä»¶å±‚è¿›è¡Œç®¡ç†ã€‚

å†…æ ¸æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œä¸ºä¹‹åçš„ MEMBLOCK å†…å­˜ç®¡ç†å™¨çš„åˆå§‹åŒ–æä¾›äº†åŸºç¡€ã€‚

æ³¨æ„ï¼Œæ­¤æ—¶å†…æ ¸ç”¨çš„ boot_params æ˜¯ arch/x86/kernel/setup.c é‡Œå®šä¹‰çš„ï¼Œè€Œé arch/x86/boot/main.c é‡Œå®šä¹‰çš„é‚£ä¸ª

```cpp
start_kernel->setup_arch
  e820__memory_setup();
    /* æ ¹æ® boot_params è®°å½•çš„ e820 ä¿¡æ¯ï¼Œæ„å»º e820_table å¹¶æ’åº */
    e820__memory_setup_default()
    /* å†æ‹·è´æˆä¸¤ä¸ªæ–°çš„è¡¨ e820_table_kexec å’Œ e820_table_firmware */
    memcpy(e820_table_kexec, e820_table, sizeof(*e820_table_kexec));
    memcpy(e820_table_firmware, e820_table, sizeof(*e820_table_firmware));
    /* æ­¤æ—¶æ‰“å°çš„æ˜¯åŸå§‹ BIOS E820 ä¿¡æ¯ */
    e820__print_table()
  /* boot_params.e820_table åªèƒ½å®¹çº³ 128 ä¸ªï¼Œå¤šäºçš„é€šè¿‡ boot_params.hdr.setup_data ä¼ é€’ï¼Œ
     ä¼šæ›´æ–° e820_table */
  parse_setup_data();
    e820__memory_setup_extended()
  /* è§£æç”¨ early_param å®šä¹‰è¿‡çš„å‚æ•°ï¼Œæ¯”å¦‚ mem= å’Œ memmap= å¯¹ e820_table åšä¸€äº›è°ƒæ•´ */
  parse_early_param();
    /* å°† e820_table å¤§äº mem=size çš„åŒºåŸŸç§»é™¤ */
    parse_memopt()
      e820__range_remove(mem_size, ULLONG_MAX - mem_size, E820_TYPE_RAM, 1);
    /* æ·»åŠ æˆ–ä¿®æ”¹ e820_table å†…å­˜åŒºåŸŸä¿¡æ¯ */
    parse_memmap_opt()
  /* å°† boot_params.hdr.setup_data å†…å­˜åŒºåŸŸè¿›è¡Œä¿ç•™ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åé¢å¯èƒ½è¿˜ä¼šç”¨åˆ°è¿™äº› setup_data
     æ¯”å¦‚ pci_device_add->pcibios_device_add */
  e820__reserve_setup_data();
  /* æ›´æ–° mem= è°ƒæ•´è¿‡åçš„ e820_table */
  e820__finish_early_params();
  /* ç”±äº BIOS å¤æ‚æ€§æˆ–æ˜¯ CMDLINE ä¸­åŒ…å«äº† â€œmemmap=exactmapâ€ æˆ– â€œmemmap=xxM$yyMâ€
     å¯¼è‡´å†…æ ¸æœ¬èº«å ç”¨çš„å†…å­˜åŒºåŸŸä¸æ˜¯ E820_TYPE_RAMï¼Œå°±éœ€è¦å°†å†…æ ¸æœ¬èº«å ç”¨çš„åŒºåŸŸæ ‡è®°ä¸º E820_TYPE_RAM */
  e820_add_kernel_range();
  /* max_pfn æ˜¯æœ€å¤§ç‰©ç†é¡µå¸§å·ï¼Œmax_low_pfn æ˜¯ 4GB å†…æœ€å¤§çš„ç‰©ç†é¡µå¸§å· */
  ...

  /* åŸºäº e820_table çš„ E820_TYPE_RAM ç±»å‹çš„åŒºåŸŸï¼Œæ„å»º memblock å†…å­˜åˆ†é…å™¨ */
  e820__memblock_setup();
    for memblock_add(entry->addr, entry->size);
  /* ä» memblock åˆ†é…å™¨ä¸­ä¸º mptable åˆ†é… 4KB ç‰©ç†å†…å­˜ï¼Œå¹¶åœ¨ e820_table_kexec ä¸­åšé¢„ç•™ï¼Œ
     ç›¸å…³ cmdline æœ‰ alloc_mptable update_mptable */
  e820__memblock_alloc_reserved_mpc_new();
  /* å°† e820_table ä¸­é¢„ç•™åŒºåŸŸå†…å­˜æ’å…¥åˆ° iomem_resource èµ„æºæ ‘ä¸‹ï¼Œä»¥ä¾¿ç»´æŠ¤ï¼Œ
     è¿˜åœ¨ /sys/firmware/memmap é‡ŒåŠ äº†äº› */
  e820__reserve_resources();
    /* E820_TYPE_RESERVED_KERN å’Œ E820_TYPE_RAM å±äº System RAMï¼Œå…¶ä»–éƒ½æ˜¯ IO å†…å­˜ */
    res->flags = e820_type_to_iomem_type(entry);
    /* TODO IORESOURCE_BUSY æ˜¯æŒ‡ä»€ä¹ˆï¼Ÿæ˜¯æŒ‡è¿™ä¸ªèµ„æºå·²è¢«å ç”¨ï¼Œé©±åŠ¨ä¸èƒ½ä½¿ç”¨è¿™ä¸ªèµ„æºï¼Ÿ
       æ¯”å¦‚ï¼Œè¦ä¸º BAR ç©ºé—´åˆ†é…ä¸€æ®µåœ°å€åŒºåŸŸï¼Œé‚£å°±ä¸èƒ½ç”³è¯· IORESOURCE_BUSY çš„ï¼Ÿ*/
    if do_mark_busy()
      res->flags |= IORESOURCE_BUSY;
      insert_resource(&iomem_resource, res); /* æ’å…¥åˆ° iomem_resource ç®¡ç† */
    firmware_map_add_early() /* /sys/firmware/memmap */

/* kernel_init çº¿ç¨‹ */
kernel_init
  free_initmem
    /* æ¸…é™¤ initdata ä¹‹å‰ï¼Œé‡æ–°ä¸º e820_table åˆ†é…å†…å­˜ */
    e820__reallocate_tables
      n = kmemdup(e820_table, size, GFP_KERNEL);
      e820_table = n;

```

TODO e820_table_kexec å’Œ e820_table_firmware

## /sys/firmware/memmap

drivers/firmware/memmap.c

```bash
~ # ls /sys/firmware/memmap/
0  1  2  3  4  5  6  7  8
~ # cat /sys/firmware/memmap/0/start
0x0
~ # cat /sys/firmware/memmap/0/end
0x9fbff
~ # cat /sys/firmware/memmap/0/type
System RAM
```

## `struct biosregs`

struct biosregs æ•°æ®ç»“æ„ç”¨äºç»´æŠ¤ä¸€å¥—å¯„å­˜å™¨ç»„ï¼Œä»¥ä¾¿ç”¨äº BIOS è°ƒç”¨æ—¶å€™äº¤æ¢å¯„å­˜å™¨ã€‚ struct biosregs æ•°æ®ç»“æ„å†…éƒ¨ä½¿ç”¨ä¸€ä¸ª union è”åˆä½“åŒ…å«äº†ä¸‰å¥—å¯„å­˜å™¨ã€‚åˆ†åˆ«å¯¹åº”ä¿æŠ¤æ¨¡å¼ã€å®æ¨¡å¼ã€å…¼å®¹ 8086 æ¨¡å¼ã€‚

## cmdline `mem=` `memmap=`

åœ¨åˆå§‹åŒ–æ¥ä¸‹æ¥çš„å†…å­˜åˆ†é…å™¨ä¹‹å‰ï¼Œå†…æ ¸å¯ä»¥æä¾›ä¸€äº›æ‰‹æ®µæ¥ä¿®æ”¹ E820 Table è¡¨æ¥æ§åˆ¶æœªæ¥ç³»ç»Ÿçš„å†… å­˜å¸ƒå±€ï¼Œè¿™ç§ä¿®æ”¹æ¯”è¾ƒå¸¸è§çš„å°±æ˜¯ç»™ç³»ç»Ÿ CMDLINE æœºåˆ¶æä¾›é€‰é¡¹ï¼Œå®ç°æŸæ®µåŒºåŸŸçš„é¢„ç•™ï¼Œæˆ–è€…æ§åˆ¶ç³»ç»Ÿå¯ç”¨ç‰©ç†å†…å­˜çš„é•¿åº¦ç­‰åŠŸèƒ½ã€‚

E820 å†…å­˜ç®¡ç†å™¨æä¾›äº† `memmap=` å’Œ `mem=` é€‰é¡¹ï¼Œç”¨äºç”¨æˆ·æ·»åŠ æˆ–ä¿®æ”¹ E820 å†…å­˜åŒºåŸŸã€‚é€šè¿‡è¿™äº›é€‰é¡¹ï¼Œç”¨æˆ·å¯ä»¥ç®€å•çš„æ·»åŠ ä¸€å— â€œç³»ç»Ÿé¢„ç•™åŒºåŸŸâ€ã€ â€œACPI Data åŒºåŸŸâ€ã€â€ç³»ç»Ÿä¿æŠ¤åŒºåŸŸâ€ï¼Œæˆ–è€…å¯ä»¥ä¿®æ”¹ e820_table ä¸­æŸæ®µå†…å­˜åŒºåŸŸçš„ç±»å‹ã€‚ è¿™äº› cmdline é€‰é¡¹è¿˜å¯ä»¥ä¿®æ”¹ç³»ç»Ÿæœ€å¤§å¯ç”¨ç‰©ç†å†…å­˜æˆ–è€…ç³»ç»Ÿå¯ä»¥ä½¿ç”¨çš„ç‰©ç†å†…å­˜èŒƒå›´ã€‚

```cpp
/* arch/x86/kernel/e820.c */
early_param("mem", parse_memopt);
early_param("memmap", parse_memmap_opt);
```

<details>

<summary>Documentation/admin-guide/kernel-parameters.txt</summary>

è¿™é‡Œçš„ nn æ˜¯æŒ‡ Sizeï¼Œss åˆ™æ˜¯æŒ‡ Address ï¼Ÿ

```txt
  mem=nn[KMG]  [KNL,BOOT,EARLY] Force usage of a specific amount
      of memory Amount of memory to be used in cases
      as follows:

      1 for test;
      2 when the kernel is not able to see the whole system memory;
      3 memory that lies after 'mem=' boundary is excluded from
       the hypervisor, then assigned to KVM guests.
      4 to limit the memory available for kdump kernel.

      [ARC,MICROBLAZE] - the limit applies only to low memory,
      high memory is not affected.

      [ARM64] - only limits memory covered by the linear
      mapping. The NOMAP regions are not affected.

      [X86] Work as limiting max address. Use together
      with memmap= to avoid physical address space collisions.
      Without memmap= PCI devices could be placed at addresses
      belonging to unused RAM.

      Note that this only takes effects during boot time since
      in above case 3, memory may need be hot added after boot
      if system memory of hypervisor is not sufficient.

  memmap=exactmap  [KNL,X86,EARLY] Enable setting of an exact
      E820 memory map, as specified by the user.
      Such memmap=exactmap lines can be constructed based on
      BIOS output or other requirements. See the memmap=nn@ss
      option description.

  memmap=nn[KMG]@ss[KMG]
      [KNL, X86,MIPS,XTENSA,EARLY] Force usage of a specific region of memory.
      Region of memory to be used is from ss to ss+nn.
      If @ss[KMG] is omitted, it is equivalent to mem=nn[KMG],
      which limits max address to nn[KMG].
      Multiple different regions can be specified,
      comma delimited.
      Example:
        memmap=100M@2G,100M#3G,1G!1024G

  memmap=nn[KMG]#ss[KMG]
      [KNL,ACPI,EARLY] Mark specific memory as ACPI data.
      Region of memory to be marked is from ss to ss+nn.

  memmap=nn[KMG]$ss[KMG]
      [KNL,ACPI,EARLY] Mark specific memory as reserved.
      Region of memory to be reserved is from ss to ss+nn.
      Example: Exclude memory from 0x18690000-0x1869ffff
               memmap=64K$0x18690000
               or
               memmap=0x10000$0x18690000
      Some bootloaders may need an escape character before '$',
      like Grub2, otherwise '$' and the following number
      will be eaten.

  memmap=nn[KMG]!ss[KMG,EARLY]
      [KNL,X86] Mark specific memory as protected.
      Region of memory to be used, from ss to ss+nn.
      The memory region may be marked as e820 type 12 (0xc)
      and is NVDIMM or ADR memory.

  memmap=<size>%<offset>-<oldtype>+<newtype>
      [KNL,ACPI,EARLY] Convert memory within the specified region
      from <oldtype> to <newtype>. If "-<oldtype>" is left
      out, the whole region will be marked as <newtype>,
      even if previously unavailable. If "+<newtype>" is left
      out, matching memory will be removed. Types are
      specified as e820 types, e.g., 1 = RAM, 2 = reserved,
      3 = ACPI, 12 = PRAM.
```

</details>

`mem=nn[KMG]` å‚æ•°ç”¨äºæŒ‡æ˜ç³»ç»Ÿæœ€å¤§å¯ç”¨ç‰©ç†å†…å­˜çš„é•¿åº¦ï¼Œå³ç³»ç»Ÿå¯ç”¨ç‰©ç†å†…å­˜èŒƒå›´æ˜¯ â€œ0-nnâ€, è¶…è¿‡è¿™ä¸€é•¿åº¦çš„ç‰©ç†å†…å­˜ç³»ç»Ÿå°†ä¸å¯è§ã€‚

`memmap=` å¯ä»¥ç”¨æ¥ï¼š

- å¼ºåˆ¶ä½¿ç”¨æŸæ®µå†…å­˜ `memmap=nn@ss`
- é¢„ç•™ä¸€æ®µ ACPI data åŒºåŸŸ `memmap=nn#ss`
- é¢„ç•™ä¸€æ®µç‰©ç†å†…å­˜ `memmap=nn$ss`
- é¢„ç•™ä¸€æ®µä¿æŠ¤åŒºåŸŸ `memmap=nn!ss` ä¸€èˆ¬ç»™ NVDIMM å’Œ ADR å†…å­˜ä½¿ç”¨
- ä¿®æ”¹ä¸€æ®µå†…å­˜åŒºåŸŸçš„ç±»å‹ `memmap=<size>%<offset>-<oldtype>+<newtype>`
  type è§ enum e820_type

ä¸€èˆ¬ â€œmem=â€ å’Œ â€œmemmap=â€ é…åˆä½¿ç”¨ï¼Œä»¥æ­¤é¿å…ç‰©ç†ç©ºé—´å†²çªã€‚å¦‚æœè®¾ç½®äº†æœ€å¤§ç‰©ç†å¯ç”¨å†…å­˜ä¹‹åï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ â€œmemmap=â€ è¿›è¡Œ â€œACPIâ€ åŒºåŸŸçš„è®¾ç½®ï¼Œé‚£ä¹ˆ â€œACPIâ€ åŒºåŸŸå°†è®¾ç½®ä¸ºä¸å¯ç”¨çš„ RAM åŒºåŸŸã€‚
TODO ã€Œâ€œACPIâ€ åŒºåŸŸå°†è®¾ç½®ä¸ºä¸å¯ç”¨çš„ RAM åŒºåŸŸã€æ€ä¹ˆç†è§£ï¼Ÿ

å¯åŠ¨ 8G è™šæ‹Ÿæœºï¼Œä½†æ˜¯å¸¦ `mem=6G memmap=1M$0x20000000,1M!0x20100000`å‚æ•°ï¼Œ

```log
[    0.000000] BIOS-provided physical RAM map:
[    0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable
[    0.000000] BIOS-e820: [mem 0x000000000009fc00-0x00000000000fffff] reserved
# å·®ä¸å¤š 2GB
[    0.000000] BIOS-e820: [mem 0x0000000000100000-0x000000007ffdffff] usable
[    0.000000] BIOS-e820: [mem 0x000000007ffe0000-0x000000007fffffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000b0000000-0x00000000bfffffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000fed1c000-0x00000000fed1ffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000feffc000-0x00000000feffffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved
# 4GB-10GB ä¹Ÿå°±æ˜¯ 6GB å¤§å°çš„åŒºåŸŸ
[    0.000000] BIOS-e820: [mem 0x0000000100000000-0x000000027fffffff] usable


# e820__finish_early_params å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ mem= æˆ– memmap= å‚æ•°ï¼Œæ˜¯æ²¡æœ‰è¿™ä¸€æ®µæ¶ˆæ¯çš„ï¼š
[    0.000000] user-defined physical RAM map:
[    0.000000] user: [mem 0x0000000000000000-0x000000000009fbff] usable
[    0.000000] user: [mem 0x000000000009fc00-0x00000000000fffff] reserved
[    0.000000] user: [mem 0x0000000000100000-0x000000001fffffff] usable
# 1M$0x20000000 é¢„ç•™çš„ç‰©ç†å†…å­˜
[    0.000000] user: [mem 0x0000000020000000-0x00000000200fffff] reserved
# 1M!0x20100000 é¢„ç•™çš„ä¿æŠ¤åŒºåŸŸ
[    0.000000] user: [mem 0x0000000020100000-0x00000000201fffff] persistent (type 12)
[    0.000000] user: [mem 0x0000000020200000-0x000000007ffdffff] usable
[    0.000000] user: [mem 0x000000007ffe0000-0x000000007fffffff] reserved
[    0.000000] user: [mem 0x00000000b0000000-0x00000000bfffffff] reserved
[    0.000000] user: [mem 0x00000000fed1c000-0x00000000fed1ffff] reserved
[    0.000000] user: [mem 0x00000000feffc000-0x00000000feffffff] reserved
[    0.000000] user: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved
# å¯ä»¥çœ‹åˆ°è¿™é‡Œç›¸æ¯”ä¸ e820 tableï¼Œå˜æˆäº† 4GB-6GBï¼Œä¹Ÿå°±æ˜¯ 2GB å¤§å°çš„åŒºåŸŸ
# è¯´æ˜ mem=6G è®©ç‰©ç†åœ°å€ 6G ä»¥ä¸Šçš„éƒ½ä¸å¯è§äº†ï¼
[    0.000000] user: [mem 0x0000000100000000-0x000000017fffffff] usable


~ # cat /proc/iomem
00000000-00000fff : Reserved
00001000-0009fbff : System RAM
0009fc00-000fffff : Reserved
  000a0000-000bffff : PCI Bus 0000:00
  000c0000-000c7fff : Video ROM
  000f0000-000fffff : System ROM
00100000-1fffffff : System RAM
  01000000-023fffff : Kernel code
  02400000-0354afff : Kernel rodata
  03600000-0396b63f : Kernel data
  042bc000-047fffff : Kernel bss
#
20000000-200fffff : Reserved
#
20100000-201fffff : Persistent Memory (legacy)
20200000-7ffdffff : System RAM
7ffe0000-7fffffff : Reserved
# 2G ~ 4G
80000000-afffffff : PCI Bus 0000:00 # è¿™éƒ¨åˆ†æ²¡åœ¨ e820 table é‡Œå‡ºç°
b0000000-bfffffff : PCI ECAM 0000 [bus 00-ff]
  b0000000-bfffffff : Reserved
    b0000000-bfffffff : pnp 00:04
c0000000-febfffff : PCI Bus 0000:00 # è¿™éƒ¨åˆ†æ²¡åœ¨ e820 table é‡Œå‡ºç°
fec00000-fec003ff : IOAPIC 0
fed00000-fed003ff : HPET 0
  fed00000-fed003ff : PNP0103:00
fed1c000-fed1ffff : Reserved
  fed1f410-fed1f414 : iTCO_wdt.0.auto
feffc000-feffffff : Reserved
fffc0000-ffffffff : Reserved
# 4G ~ 6G
100000000-17fffffff : System RAM
# 6G ~ 10G æ²¡æœ‰å‡ºç°
# 10G ~ ...
280000000-a7fffffff : PCI Bus 0000:00 # è¿™éƒ¨åˆ†æ²¡åœ¨ e820 table é‡Œå‡ºç°
```
