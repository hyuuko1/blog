<!DOCTYPE html>
<html lang="zh-Hans" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kexec | Blog</title>
    <meta name="description" content="Linux kernel å†…æ ¸ä»£ç åˆ†æï¼ŒåŸç†è¯¦è§£">
    <meta name="generator" content="VitePress v2.0.0-alpha.13">
    <link rel="preload stylesheet" href="/blog/assets/style.Cg8D8EfQ.css" as="style">
    <link rel="preload stylesheet" href="/blog/vp-icons.css" as="style">
    <script type="module" src="/blog/assets/chunks/metadata.e2231c71.js"></script>
    <script type="module" src="/blog/assets/app.DgFSTuZM.js"></script>
    <link rel="preload" href="/blog/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/blog/assets/chunks/theme.3WDp7bvS.js">
    <link rel="modulepreload" href="/blog/assets/chunks/framework.CdzZEkix.js">
    <link rel="modulepreload" href="/blog/assets/booting_kexec.md.C1XetJ46.lean.js">
    <link rel="icon" type="image/svg+xml" href="/blog/linux.svg">
    <link rel="icon" type="image/png" href="/blog/linux-32x32.png">
    <meta name="theme-color" content="#5f67ee">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:title" content="kexec | Blog">
    <meta property="og:site_name" content="Linux kernel å†…æ ¸ä»£ç åˆ†æï¼ŒåŸç†è¯¦è§£">
    <meta property="og:url" content="https://hyuuko.vercel.app">
    <meta name="google-site-verification" content="OMML6xlbLb2Asitovo85pbOZGTvYoWaYWYW3ps7083s">
    <meta name="msvalidate.01" content="E3B108A75866D6C18B16BE35E14DE820">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-304c8b69><!--[--><!--]--><!--[--><span tabindex="-1" data-v-10d4d845></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-10d4d845>Skip to content</a><!--]--><!----><header class="VPNav" data-v-304c8b69 data-v-d5bf7c8e><div class="VPNavBar" data-v-d5bf7c8e data-v-8eab0e6d><div class="wrapper" data-v-8eab0e6d><div class="container" data-v-8eab0e6d><div class="title" data-v-8eab0e6d><div class="VPNavBarTitle" data-v-8eab0e6d data-v-d4488dd0><a class="title" href="/blog/" data-v-d4488dd0><!--[--><!--]--><!--[--><img class="VPImage logo" src="/blog/linux.svg" width="20" height="20" alt data-v-ab19afbb><!--]--><span data-v-d4488dd0>Blog</span><!--[--><!--]--></a></div></div><div class="content" data-v-8eab0e6d><div class="content-body" data-v-8eab0e6d><!--[--><!--]--><div class="VPNavBarSearch search" data-v-8eab0e6d><!--[--><!----><div id="local-search"><button type="button" aria-label="æœç´¢æ–‡æ¡£" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">æœç´¢æ–‡æ¡£</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-8eab0e6d data-v-020be4db><span id="main-nav-aria-label" class="visually-hidden" data-v-020be4db> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/mm/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>å†…å­˜ç®¡ç†</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/net/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>ç½‘ç»œ</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/storage/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>å­˜å‚¨</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/process/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>è¿›ç¨‹</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/sched/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>è°ƒåº¦</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/irq/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>ä¸­æ–­</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/arch/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>ä½“ç³»ç»“æ„</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/debug/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>è°ƒè¯•</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/virtualization/index" tabindex="0" data-v-020be4db data-v-81dba28a><!--[--><span data-v-81dba28a>è™šæ‹ŸåŒ–</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-020be4db data-v-d8fae6e2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-d8fae6e2><span class="text" data-v-d8fae6e2><!----><span data-v-d8fae6e2>æ‚é¡¹</span><span class="vpi-chevron-down text-icon" data-v-d8fae6e2></span></span></button><div class="menu" data-v-d8fae6e2><div class="VPMenu" data-v-d8fae6e2 data-v-fcd1d7a8><div class="items" data-v-fcd1d7a8><!--[--><!--[--><div class="VPMenuLink" data-v-fcd1d7a8 data-v-acfa8338><a class="VPLink link" href="/blog/other/index" data-v-acfa8338><!--[--><span data-v-acfa8338>å…¶ä»–</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-fcd1d7a8 data-v-acfa8338><a class="VPLink link" href="/blog/init/index" data-v-acfa8338><!--[--><span data-v-acfa8338>åˆå§‹åŒ–</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-fcd1d7a8 data-v-acfa8338><a class="VPLink link" href="/blog/pm/index" data-v-acfa8338><!--[--><span data-v-acfa8338>ç”µæºç®¡ç†</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-8eab0e6d data-v-3f90c1a5><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-3f90c1a5 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-8eab0e6d data-v-ef6192dc data-v-a1a7286e><!--[--><a class="VPSocialLink no-icon" href="https://github.com/hyuuko1/blog" aria-label="github" target="_blank" rel="me noopener" data-v-a1a7286e data-v-32d78712><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-8eab0e6d data-v-600b50c9 data-v-d8fae6e2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-d8fae6e2><span class="vpi-more-horizontal icon" data-v-d8fae6e2></span></button><div class="menu" data-v-d8fae6e2><div class="VPMenu" data-v-d8fae6e2 data-v-fcd1d7a8><!----><!--[--><!--[--><!----><div class="group" data-v-600b50c9><div class="item appearance" data-v-600b50c9><p class="label" data-v-600b50c9>ä¸»é¢˜</p><div class="appearance-action" data-v-600b50c9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-600b50c9 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-600b50c9><div class="item social-links" data-v-600b50c9><div class="VPSocialLinks social-links-list" data-v-600b50c9 data-v-a1a7286e><!--[--><a class="VPSocialLink no-icon" href="https://github.com/hyuuko1/blog" aria-label="github" target="_blank" rel="me noopener" data-v-a1a7286e data-v-32d78712><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-8eab0e6d data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-8eab0e6d><div class="divider-line" data-v-8eab0e6d></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-304c8b69 data-v-5ae341c6><div class="container" data-v-5ae341c6><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-5ae341c6 data-v-e28a51a6><button data-v-e28a51a6>å›åˆ°é¡¶éƒ¨</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-304c8b69 data-v-2652e39a><div class="VPDoc has-aside" data-v-2652e39a data-v-d668f7cc><!--[--><!--]--><div class="container" data-v-d668f7cc><div class="aside" data-v-d668f7cc><div class="aside-curtain" data-v-d668f7cc></div><div class="aside-container" data-v-d668f7cc><div class="aside-content" data-v-d668f7cc><div class="VPDocAside" data-v-d668f7cc data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-c8b19031><div class="content" data-v-c8b19031><div class="outline-marker" data-v-c8b19031></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-c8b19031>ç›®å½•</div><ul class="VPDocOutlineItem root" data-v-c8b19031 data-v-63c57e50><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-d668f7cc><div class="content-container" data-v-d668f7cc><!--[--><!--]--><main class="main" data-v-d668f7cc><div style="position:relative;" class="vp-doc _blog_booting_kexec external-link-icon-enabled" data-v-d668f7cc><div><h1 id="kexec" tabindex="-1">kexec <a class="header-anchor" href="#kexec" aria-label="Permalink to â€œkexecâ€">â€‹</a></h1><p>ä¸»è¦çš„åº”ç”¨åœºæ™¯ï¼š</p><ol><li>kdump (kexec on panic)</li><li>äº‘æœåŠ¡å™¨å‚å•†ç”¨è¿™ä¸ªåšå†…æ ¸çƒ­å‡çº§ã€‚ç”¨æˆ·æ€çš„å¯èƒ½è¦ CRIUã€‚ è¿˜æœ‰ Kexec HandOver (KHO)ã€åŒ OS çƒ­å‡çº§ç­‰æ–¹æ¡ˆã€‚</li></ol><h2 id="å‚è€ƒ" tabindex="-1">å‚è€ƒ <a class="header-anchor" href="#å‚è€ƒ" aria-label="Permalink to â€œå‚è€ƒâ€">â€‹</a></h2><ul><li><a href="https://docs.kernel.org/admin-guide/kdump/kdump.html" target="_blank" rel="noreferrer">Kdump - The kexec-based Crash Dumping Solution â€” The Linux Kernel documentation</a></li><li>ğŸŒŸ<a href="https://www.cnblogs.com/lianyihong/p/17911774.html" target="_blank" rel="noreferrer">ã€å†…æ ¸ã€‘kernel çƒ­å‡çº§-1ï¼škexec æœºåˆ¶ - _hong - åšå®¢å›­</a></li><li><a href="https://zhuanlan.zhihu.com/p/104292358" target="_blank" rel="noreferrer">3.3.2 å†…æ ¸æ€è°ƒæµ‹å·¥å…·ï¼škdump&amp;crashâ€”â€”kdump - çŸ¥ä¹</a></li><li><a href="https://zhuanlan.zhihu.com/p/104384020" target="_blank" rel="noreferrer">3.3.3 å†…æ ¸æ€è°ƒæµ‹å·¥å…·ï¼škdump&amp;crashâ€”â€”crash è§£æ - çŸ¥ä¹</a></li><li><a href="https://mp.weixin.qq.com/s/o89Z75IQgah75eW0_qHBtw" target="_blank" rel="noreferrer">Linux Kdump æœºåˆ¶è¯¦è§£</a></li><li><a href="https://wiki.archlinux.org/title/Kexec" target="_blank" rel="noreferrer">Kexec - ArchWiki</a></li><li><a href="https://wiki.archlinux.org/title/Kdump" target="_blank" rel="noreferrer">Kdump - ArchWiki</a></li><li><a href="https://github.com/yifengyou/crash" target="_blank" rel="noreferrer">yifengyou/crash: å†…æ ¸ crash åˆ†æ</a></li><li>ğŸŒŸ<a href="https://github.com/freelancer-leon/notes/blob/master/kernel/kexec.md" target="_blank" rel="noreferrer">https://github.com/freelancer-leon/notes/blob/master/kernel/kexec.md</a></li><li>ğŸŒŸ<a href="https://github.com/freelancer-leon/notes/blob/master/kernel/kexec_x86.md" target="_blank" rel="noreferrer">https://github.com/freelancer-leon/notes/blob/master/kernel/kexec_x86.md</a></li><li>ğŸŒŸ<a href="https://github.com/freelancer-leon/notes/blob/master/kernel/kdump.md" target="_blank" rel="noreferrer">https://github.com/freelancer-leon/notes/blob/master/kernel/kdump.md</a></li><li><a href="https://www.thegoodpenguin.co.uk/blog/booting-linux-from-linux-with-kexec/" target="_blank" rel="noreferrer">Booting Linux from Linux with kexec â€“ The Good Penguin</a></li><li>ğŸŒŸ<a href="https://eastrivervillage.com/kexec-tools-with-the-hidden-purgatory/" target="_blank" rel="noreferrer">kexec - A travel to the purgatory</a></li><li>ğŸŒŸ<a href="https://blog.csdn.net/OurBMC/article/details/143425496" target="_blank" rel="noreferrer">ç©è½¬ OurBMC ç¬¬åäºŒæœŸï¼škdump åŸç†åˆ†æï¼ˆä¸‹ï¼‰</a></li></ul><h2 id="ç”¨æˆ·æ€å·¥å…·-kexec-tools" tabindex="-1">ç”¨æˆ·æ€å·¥å…· kexec-tools <a class="header-anchor" href="#ç”¨æˆ·æ€å·¥å…·-kexec-tools" aria-label="Permalink to â€œç”¨æˆ·æ€å·¥å…· kexec-toolsâ€">â€‹</a></h2><ul><li><a href="https://github.com/horms/kexec-tools" target="_blank" rel="noreferrer">https://github.com/horms/kexec-tools</a></li></ul><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -l å’Œ -p éƒ½ä¼šé€šè¿‡ kexec_load() / kexec_file_load() ç³»ç»Ÿè°ƒç”¨æ¥åŠ è½½å†…æ ¸ï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä½†æ˜¯åŠ è½½çš„å†…æ ¸çš„ç”¨é€”ä¸ä¸€æ ·ï¼Œ-p åŠ è½½çš„æ˜¯åœ¨ panic æ—¶æ‰§è¡Œçš„ crash kernel</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kexec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/vmlinux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --append=root=/dev/hda1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --initrd=/boot/initrd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kexec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/vmlinux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --append=root=/dev/hda1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --initrd=/boot/initrd</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kexec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* kexec/kexec.c */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> OPT_LOAD:</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* -l */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    has_opt_load </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_load </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_exec </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_shutdown </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> OPT_PANIC:</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* -p */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_load </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_exec </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_shutdown </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_sync </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    kexec_file_flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KEXEC_FILE_ON_CRASH;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* ä¼ ç»™ kexec_file_load() çš„å‚æ•° */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    kexec_flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KEXEC_ON_CRASH;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		/* ä¼ ç»™ kexec_load() çš„å‚æ•° */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> OPT_EXEC:</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* -e */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_load </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_shutdown </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_sync </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_ifdown </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    do_exec </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="å†…æ ¸åŠ è½½-kexec-load-kexec-file-load-ç³»ç»Ÿè°ƒç”¨" tabindex="-1">å†…æ ¸åŠ è½½ï¼škexec_load() / kexec_file_load() ç³»ç»Ÿè°ƒç”¨ <a class="header-anchor" href="#å†…æ ¸åŠ è½½-kexec-load-kexec-file-load-ç³»ç»Ÿè°ƒç”¨" aria-label="Permalink to â€œå†…æ ¸åŠ è½½ï¼škexec_load() / kexec_file_load() ç³»ç»Ÿè°ƒç”¨â€">â€‹</a></h2><p>kexec_file_load() åœ¨å†…æ ¸å†…è§£ææ–°å†…æ ¸ï¼Œä¸åƒ kexec_load() é‚£æ ·éœ€è¦å…ˆåœ¨ç”¨æˆ·æ€è§£ææ–°å†…æ ¸ã€‚</p><p>kexec åœ¨å†…æ ¸åŠ è½½é˜¶æ®µï¼Œäºå†…å­˜ä¸­åˆ›å»ºäº†ä¸€å¼  æ§åˆ¶è¡¨ control_code_pageï¼Œç”¨äºå­˜æ”¾é‡å®šå‘æ–°å†…æ ¸åœ°å€çš„æ§åˆ¶ä»£ç ã€‚è¿™æ®µæ§åˆ¶ä»£ç åä¸º</p><p>Kexec ä¼šå°†ç”¨æˆ·ä¼ é€’çš„å†…æ ¸ï¼Œinitrd ç­‰ä¿¡æ¯å­˜å‚¨åœ¨ kexec_info ä¸­çš„ segment ä¸­ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šä»£ç éƒ½æ˜¯åœ¨å¤„ç†è¿™éƒ¨åˆ†å†…å®¹ã€‚</p><p>æµç¨‹ç®€è¿°ï¼š</p><ol><li>vmalloc ç”³è¯·ä¸¤å—å†…å­˜ï¼Œæ”¾ç½®é€šè¿‡ç”¨æˆ·æ€ä¼ è¿‡æ¥çš„ fd è¯»å–çš„ linux/initrd image</li><li>kzalloc ç”³è¯·å†…å­˜ï¼Œæ”¾ç½® boot_params + cmdline + setup_data + efi_setup_data ç­‰å†…å®¹</li><li>å°†è¿™ 3 å—å†…å­˜åœ°å€ç”¨ <code>kexec_add_buffer()</code> å‡½æ•°è®°å½•å¥½ <code>ksegment-&gt;kbuf</code>ï¼Œå¹¶ä» iomem_resource åˆ†é…å¥½æœ€ç»ˆæ‹·è´åˆ°çš„è¿ç»­å†…å­˜ <code>ksegment-&gt;mem</code>ã€‚</li><li>...</li></ol><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kimage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* æŒ‡å‘ä¸€ä¸ª kimage_entry_t æ•°ç»„ */</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	kimage_entry_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> head;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* æŒ‡å‘æ•°ç»„æœ«å°¾çš„é‚£ä¸ª entry */</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        kimage_entry_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">entry;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kexec_segment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> segment[KEXEC_SEGMENT_MAX];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* ç”¨æˆ·æ€ä¼ è¿‡æ¥çš„å†…æ ¸ã€initrdæ–‡ä»¶å†…å®¹ï¼Œå’Œå‘½ä»¤è¡Œ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kernel_buf;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kernel_buf_len;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">initrd_buf;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> initrd_buf_len;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cmdline_buf;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cmdline_buf_len;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* ç”¨äºå‡½æ•°è°ƒç”¨æ—¶ä¼ é€’å‚æ•°ã€‚ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kexec_buf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kimage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">image;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* åˆ†é…çš„å†…å­˜ã€‚æ–°å†…æ ¸çš„å†…å®¹æœ€ç»ˆä¼šæ‹·è´åˆ°è¿™é‡Œ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buffer;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bufsz;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* void *buffer çš„å¤§å° */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mem;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> memsz;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* åŠ ä¸Š bss åçš„å¤§å° */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buf_align;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buf_min;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* buffer åœ°å€èŒƒå›´ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buf_max;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> top_down;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		/* åˆ†é…çš„æ–¹å‘ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kexec_segment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	union</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buf;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kbuf;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	};</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bufsz;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mem;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> memsz;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SYSCALL_DEFINE5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(kexec_file_load, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kernel_fd, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> initrd_fd,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cmdline_len, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cmdline_ptr,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flags)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (image_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KEXEC_TYPE_CRASH)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dest_image </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kexec_crash_image;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (kexec_crash_image)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        arch_kexec_unprotect_crashkres</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dest_image </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kexec_image;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* é‡Šæ”¾ä¸Šä¸€æ¬¡åŠ è½½çš„ crash kernel */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KEXEC_FILE_ON_CRASH)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    kimage_free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">xchg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kexec_crash_image, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* è¯»å–å†…æ ¸å’Œ initrdï¼Œåˆ†é…å¹¶åˆå§‹åŒ– struct kimage */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kimage_file_alloc_init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">image, kernel_fd, initrd_fd, cmdline_ptr, cmdline_len, flags);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kimage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">image </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> do_kimage_alloc_init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (kexec_on_panic)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      image-&gt;control_page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> crashk_res.start;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    kimage_file_prepare_segments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, kernel_fd, initrd_fd, cmdline_ptr, cmdline_len, flags);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* è¯»å–å†…æ ¸æ–‡ä»¶å†…å®¹åˆ°å†…æ ¸ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      kernel_read_file_from_fd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(kernel_fd, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">image-&gt;kernel_buf)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* å¯¹æ–°å†…æ ¸çš„ setup_header åšä¸€äº›æ ¡éªŒ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      arch_kexec_kernel_image_probe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bzImage64_probe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* è¯»å– initrd æ–‡ä»¶å†…å®¹åˆ°å†…æ ¸ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      kernel_read_file_from_fd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(initrd_fd, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">image-&gt;initrd_buf)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* æ‹·è´æ¥è‡ªç”¨æˆ·æ€çš„å†…æ ¸å¯åŠ¨å‚æ•° */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      image-&gt;cmdline_buf </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> memdup_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cmdline_ptr, cmdline_len);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /*  */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      image-&gt;image_loader_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kexec_image_load_default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bzImage64_load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* åœ¨ crash dump çš„æƒ…å†µä¸‹ï¼Œä¼šè¿½åŠ  elfcorehdr=&lt;addr&gt; å¯åŠ¨å‚æ•°ï¼Œæ£€æŸ¥æ˜¯å¦æ”¾å¾—ä¸‹ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           XXX è¿™é‡Œæ˜¯å¦æ”¾ä¸ª image-&gt;type == KEXEC_TYPE_CRASH &amp;&amp; æ¯”è¾ƒå¥½ï¼Ÿ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (cmdline_len </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAX_ELFCOREHDR_STR_LEN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> header-&gt;cmdline_size) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ERR_PTR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EINVAL);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* TODO å¦‚æœæ˜¯ crash kernelï¼Œæ²¡çœ‹æ‡‚ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (image-&gt;type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KEXEC_TYPE_CRASH) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">crash_load_segments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* åŠ è½½ purgatory */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        kexec_load_purgatory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pbuf);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* åˆ†é…å†…å­˜ï¼Œç”¨äºæ”¾ç½® struct boot_params + cmdline + efi memmap +</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        struct setup_data + struct efi_setup_data + struct setup_data + rng seed</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        ç„¶åæ‹·è´ setup header åˆ° boot_params ä¸­ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        params </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kzalloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(kbuf.bufsz, GFP_KERNEL);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        memcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">params-&gt;hdr, (kernel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> setup_hdr_offset), setup_header_size);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        kbuf.buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> params;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        kexec_add_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kbuf);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* æŠŠè¿™å—å†…å­˜è®°å½•åˆ° kexec_segment æ•°ç»„ä¸­ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        kbuf.buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kernel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kern16_size;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        kexec_add_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kbuf);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* æŠŠ kernel è¿™å—å†…å­˜åŒºåŸŸè®°å½•åˆ° kexec_segment æ•°ç»„ä¸­ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        kbuf.buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> initrd;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        kexec_add_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kbuf);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* æŠŠ initrd è¿™å—å†…å­˜åŒºåŸŸè®°å½•åˆ° kexec_segment æ•°ç»„ä¸­ */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* åœ¨ boot_params çš„ setup header é‡Œè®¾ç½®å¥½ initrd çš„åœ°å€ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        setup_initrd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(params, initrd_load_addr, initrd_len);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* è®¾ç½®å¥½å‘½ä»¤è¡Œï¼Œå¹¶åœ¨ boot_params çš„ setup header é‡Œè®¾ç½®å¥½å‘½ä»¤è¡Œåœ°å€ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        setup_cmdline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* è®¾ç½®å¥½è¿›å…¥ purgatory æ—¶çš„å¯„å­˜å™¨ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* è®¾ç½®å¥½ boot_params é‡Œçš„ä¸€äº›å†…å®¹ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        setup_boot_parameters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* åˆ†é… loader specific data */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        kzalloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(struct bzimage64_data), GFP_KERNEL);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* åˆ†é… control_code_page */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    image-&gt;control_code_page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kimage_alloc_control_pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_order</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(KEXEC_CONTROL_PAGE_SIZE));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* å¦‚æœæ˜¯ crash kernel åˆ™ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    image-&gt;swap_page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kimage_alloc_control_pages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  machine_kexec_prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* åˆå§‹åŒ–æ’ç­‰æ˜ å°„é¡µè¡¨ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    init_pgtable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__pa</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(control_page));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* å¤åˆ¶ç”¨äºé‡å®šå‘æ–°å†…æ ¸åœ°å€çš„æ§åˆ¶ä»£ç åˆ° control_code_page */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">control_page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> page_address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image-&gt;control_code_page);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    __memcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(control_page, __relocate_kernel_start, reloc_end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reloc_start);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* éå† kexec_segment æ•°ç»„ï¼Œåˆ†é…é¡µé¢ï¼Œå¹¶æ‹·è´ï¼Œé¡µé¢ä¼šè®°å½•åœ¨ kimage_entry_t æ•°ç»„é‡Œã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  XXX æ²¡ææ‡‚æ‹·è´æ—¶ä¸ºä»€ä¹ˆè¦ä¸´æ—¶ kmap ä¸€ä¸‹ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image-&gt;nr_segments; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    kimage_load_segment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">image-&gt;segment[i]);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kimage_terminate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kexec_post_load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, flags);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* é‡Šæ”¾å†…å­˜ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kimage_file_post_load_cleanup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* æœ€ç»ˆå®Œæˆä¿®æ”¹ï¼Œä¸ºå•¥è¦ç”¨ xchgï¼Ÿä¸æ˜¯å·²ç»æœ‰é”ä¿æŠ¤äº†å— */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  image </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> xchg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dest_image, image);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  arch_kexec_protect_crashkres</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kexec_unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* é‡Šæ”¾ä¸Šä¸€æ¬¡åŠ è½½çš„ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kimage_free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br></div></div><p>ä¸€äº›å‡½æ•°</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* å°†ä¸€ä¸ª buffer æ·»åŠ åˆ° struct kimage çš„ struct kexec_segment segment[KEXEC_SEGMENT_MAX]; æ•°ç»„å†…ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * è¿˜ä¼šä» iomem_resource åˆ’åˆ†ä¸€ä¸ªå†…å­˜åŒºåŸŸ kbuf-&gt;mem</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> //XXX å¦‚ä½•ç¡®ä¿å’Œå½“å‰å†…æ ¸ä»£ç æ®µä¹‹ç±»çš„ä¸é‡åˆçš„ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kexec_add_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kexec_buf</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">kbuf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* æˆ‘çŒœæ˜¯è¿™æ ·çš„ï¼šå› ä¸ºæˆ‘ä»¬å¤§æ¦‚ç‡æ²¡æ³•ç”³è¯·åˆ°ä¸€å—é‚£ä¹ˆå¤§çš„ç©ºé—²è¿ç»­å†…å­˜ï¼Œæ‰€ä»¥å…ˆåˆ’åˆ†ä¸€å—ï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * åˆ†é…é¡µé¢ï¼ŒæŠŠé¡µé¢ä¿¡æ¯è®°å½•åœ¨ image-&gt;head æ•°ç»„é‡Œï¼Œå¹¶æŠŠæ–°å†…æ ¸æ‹·è´åˆ°é¡µé¢é‡Œã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *ï¼ˆå¦‚æœé¡µé¢æ°å¥½å°±åœ¨é‚£å—ç©ºé—²è¿ç»­å†…å­˜é‡Œï¼Œé‚£è¿˜ä¼šè®°å½•åœ¨ image-&gt;dest_pages é“¾è¡¨é‡Œï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * åˆ° machine_kexec()-&gt;relocate_kernel_ptr() æ—¶ï¼Œæ‰æŠŠè¿™äº›é¡µé¢çš„å†…å®¹æ‹·è´åˆ°è¿™å—è¿ç»­çš„å†…å­˜ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * è€Œ crash kernel ä¸ç”¨è¿™æ ·åšï¼šæˆ‘ä»¬å·²ç»ä¸º crash kernel é¢„ç•™äº†è¿ç»­å†…å­˜ï¼Œå¯ä»¥åœ¨ç°åœ¨å°±ç›´æ¥æ‹·è´è¿‡å»ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kimage_load_normal_segment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kimage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kexec_segment</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">segment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="å†…æ ¸æ‰§è¡Œ-reboot-linux-reboot-cmd-kexec-ç³»ç»Ÿè°ƒç”¨" tabindex="-1">å†…æ ¸æ‰§è¡Œï¼šreboot(LINUX_REBOOT_CMD_KEXEC) ç³»ç»Ÿè°ƒç”¨ <a class="header-anchor" href="#å†…æ ¸æ‰§è¡Œ-reboot-linux-reboot-cmd-kexec-ç³»ç»Ÿè°ƒç”¨" aria-label="Permalink to â€œå†…æ ¸æ‰§è¡Œï¼šreboot(LINUX_REBOOT_CMD_KEXEC) ç³»ç»Ÿè°ƒç”¨â€">â€‹</a></h2><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SYSCALL_DEFINE4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reboot, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, magic1, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, magic2, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, cmd, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, arg)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kernel_kexec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    kexec_in_progress </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    kexec_in_progress </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    kernel_restart_prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;kexec reboot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    migrate_to_reboot_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    syscore_shutdown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    cpu_hotplug_enable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    pr_notice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Starting new kernel</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    machine_shutdown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    kmsg_dump</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(KMSG_DUMP_SHUTDOWN);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    machine_kexec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(kexec_image);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      local_irq_disable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      control_page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> page_address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image-&gt;control_code_page);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      reloc_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)__relocate_kernel_start;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      relocate_kernel_ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> control_page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)relocate_kernel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reloc_start;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      load_segments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* å°† ds,es ç­‰å¯„å­˜å™¨éƒ½ç½® 0 */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      relocate_kernel_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)image-&gt;head,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">			   virt_to_phys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(control_page),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			   image-&gt;start,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			   image-&gt;preserve_context,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			   host_mem_enc_active);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="relocate-kernel" tabindex="-1">relocate_kernel <a class="header-anchor" href="#relocate-kernel" aria-label="Permalink to â€œrelocate_kernelâ€">â€‹</a></h3><div class="language-asm line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">asm</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* arch/x86/kernel/relocate_kernel_64.S */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SYM_CODE_START_NOALIGN(relocate_kernel)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  movq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	kexec_pa_table_page(%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), %</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">r9</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  movq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">r9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, %</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cr3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* åˆ‡æ¢åˆ°æ’ç­‰æ˜ å°„é¡µè¡¨ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  addq	$identity_mapped - </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, %</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rsi</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  subq	$__relocate_kernel_start - </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, %</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rsi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  jmp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	*%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rsi</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		/* å¾—åˆ° identity_mapped ç¬¦å·çš„æ’ç­‰æ˜ å°„åœ°å€å¹¶è·³è½¬ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SYM_CODE_START_LOCAL_NOALIGN(identity_mapped)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	swap_pages</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SYM_CODE_START_LOCAL_NOALIGN(swap_pages)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* æ­¤æ—¶ rdi æ˜¯ kimage-&gt;headï¼ŒæŒ‡å‘é¡µé¢ entry æ•°ç»„ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * ä¸‹é¢çš„ä»£ç æˆ‘å°±ä¸ç»†è®²äº†ï¼Œæƒ³ä» enty æ•°ç»„å¾—åˆ° source pageï¼ŒæŠŠå†…å®¹æ‹·è´åˆ° swap pageï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * å†æŠŠ destination page æ‹·è´åˆ° source pageï¼Œå†æŠŠ swap page æ‹·è´åˆ° destination pageã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * è¿™æ ·å°±å®Œæˆäº† source page å’Œ destination page çš„äº¤æ¢ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>IND_INDIRECTION ç±»å‹ä»£è¡¨è¿™ä¸ªæŒ‡å‘ä¸€ä¸ªé¡µé¢ï¼Œé¡µé¢é‡Œæ‰æ˜¯çœŸæ­£çš„ entryã€‚</li><li>IND_SOURCE æ˜¯åœ¨ <code>kimage_load_normal_segment()</code> é‡Œåˆ†é…çš„å•ä¸ªé¡µé¢ï¼ŒåŒ…å«äº†æ–°å†…æ ¸ç­‰å†…å®¹ã€‚</li><li>IND_DESTINATION æ˜¯åœ¨ <code>kexec_add_buffer</code> æ—¶ï¼Œä» iomem_resource åˆ’åˆ†çš„è¿ç»­å†…å­˜é‡Œçš„é¡µé¢ã€‚</li></ul><p>XXX ä¸ºä»€ä¹ˆè¦äº¤æ¢ IND_SOURCE å’Œ IND_DESTINATIONï¼Œéš¾é“ä¸æ˜¯æŠŠ IND_SOURCE æ‹·è´åˆ° IND_DESTINATION å°±è¡Œå—ï¼Ÿ æ²¡å¤ªçœ‹æ‡‚ï¼Œæœ‰ç©ºå†ç»†çœ‹ã€‚</p><h3 id="purgatory" tabindex="-1">purgatory <a class="header-anchor" href="#purgatory" aria-label="Permalink to â€œpurgatoryâ€">â€‹</a></h3><p>Purgatory æ˜¯ Linux kexec çƒ­é‡å¯æœºåˆ¶ä¸­ä¸€ä¸ªè‡³å…³é‡è¦çš„å®‰å…¨ç»„ä»¶ã€‚å®ƒåœ¨æ—§å†…æ ¸åœæ­¢è¿è¡Œåã€æ–°å†…æ ¸å¼€å§‹æ‰§è¡Œå‰çš„çŸ­æš‚é—´éš™è¿è¡Œï¼Œè´Ÿè´£ç¡®ä¿æ‰€æœ‰ CPU å¤„äºå®‰å…¨çŠ¶æ€ã€æ‰§è¡Œæœ€ä½é™åº¦çš„ç¡¬ä»¶æ¸…ç†ï¼Œå¹¶ï¼ˆå¯é€‰ä½†å¼ºçƒˆæ¨èï¼‰éªŒè¯æ–°å†…æ ¸æ˜ åƒåœ¨å†…å­˜ä¸­çš„å®Œæ•´æ€§ï¼Œé˜²æ­¢åŠ è½½åæŸåå¯¼è‡´å¯åŠ¨å¤±è´¥æˆ–ç³»ç»Ÿå´©æºƒã€‚å®ƒå°±åƒä¸€ä¸ªå°½èŒçš„å®ˆé—¨äººï¼Œä¸ºæ–°å†…æ ¸çš„é¡ºåˆ©å¯åŠ¨æ‰«æ¸…éšœç¢å¹¶è¿›è¡Œæœ€åçš„å®‰å…¨æ£€æŸ¥ã€‚</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">â¯</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> out/x86_64/arch/x86/purgatory/purgatory.ro</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">out/x86_64/arch/x86/purgatory/purgatory.ro:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ELF</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 64-bit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LSB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> relocatable,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> x86-64,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (SYSV), not</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">â¯</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> readelf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -h</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> out/x86_64/arch/x86/purgatory/purgatory.ro</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ELF</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Header:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Magic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   7f</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 45</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 4c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 46</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 02</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 01</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 01</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 00</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Class:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                             ELF64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Data:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                              2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;s complement, little endian</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Version:                           1 (current)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  OS/ABI:                            UNIX - System V</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ABI Version:                       0</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Type:                              REL (Relocatable file)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Machine:                           Advanced Micro Devices X86-64</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Version:                           0x1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Entry point address:               0x2a0</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Start of program headers:          0 (bytes into file)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Start of section headers:          19392 (bytes into file)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Flags:                             0x0</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Size of this header:               64 (bytes)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Size of program headers:           0 (bytes)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Number of program headers:         0</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Size of section headers:           64 (bytes)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Number of section headers:         18</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Section header string table index: 16</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>purgatory æ˜¯ä¸€ä¸ª bootloaderï¼Œåœ¨ç‰¹å®šä½“ç³»æ¶æ„ä¸Šç¼–è¯‘ kexec æ—¶ï¼Œpurgatory ä¼šä»ç›¸åº”ç‰¹å®šä½“ç³»çš„æºç ç”Ÿæˆã€‚å®ƒæ˜¯ä¸€ä¸ª ELF æ ¼å¼çš„ relocatable æ–‡ä»¶</p><p>ç¼–è¯‘å†…æ ¸åï¼Œå¯ä»¥åœ¨ä¸€äº› .cmd æ–‡ä»¶é‡Œçœ‹åˆ°æ˜¯å¦‚ä½•ç¼–è¯‘å‡º purgatory.roã€kexec-purgatory.o ç­‰æ–‡ä»¶çš„</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">savedcmd_arch/x86/purgatory/purgatory.ro</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ld.lld</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> elf_x86_64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --compress-debug-sections=zlib</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> noexecstack</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> purgatory_start</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nodefaultlib</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arch/x86/purgatory/purgatory.o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arch/x86/purgatory/stack.o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arch/x86/purgatory/setup-x86_64.o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arch/x86/purgatory/sha256.o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arch/x86/purgatory/entry64.o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arch/x86/purgatory/string.o</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arch/x86/purgatory/purgatory.ro</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>ç¼–è¯‘å¥½çš„ purgatory.ro è¢« .incbin åˆ° kexec-purgatory.S é‡Œï¼Œ</p><div class="language-asm line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">asm</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* arch/x86/purgatory/kexec-purgatory.S */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">section .rodata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, &quot;a&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	.align	</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kexec_purgatory:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	.globl	kexec_purgatory</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">incbin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	&quot;arch/x86/purgatory/purgatory.ro&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Lkexec_purgatory_end:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	.align	</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kexec_purgatory_size:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	.globl	kexec_purgatory_size</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	.quad	.Lkexec_purgatory_end - kexec_purgatory</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>kexec_load_purgatory() åŠ è½½ purgatory å¹¶é‡å®šä½ã€‚</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kexec_load_purgatory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kimage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kexec_buf</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">kbuf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* purgatory æ˜¯ elf æ ¼å¼çš„ï¼Œé¦–éƒ¨å°±æ˜¯ elf header */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  pi-&gt;ehdr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Elf_Ehdr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)kexec_purgatory;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* éå† section headersï¼Œå¿½ç•¥ä¸ä¼šè¢«åŠ è½½å†…å­˜é‡Œçš„ SHF_ALLOCï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * SHT_NOBITS ç±»å‹çš„æ˜¯ bss sectionï¼Œè®¡å…¥ bss_szï¼Œå…¶ä»–çš„è®¡å…¥ kbuf-&gt;bufsz</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * vzalloc åˆ†é… kbuf-&gt;bufsz å¤§å°çš„å†…å­˜ã€‚å†…å­˜åœ°å€ pi-&gt;purgatory_bufã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * è®°å½•è¿› kexec_segment æ•°ç»„å†…ã€‚*/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kexec_purgatory_setup_kbuf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pi, kbuf);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* åˆ†é…å†…å­˜ï¼Œæ‹·è´ section headersï¼ˆæ‹·è´æ˜¯å› ä¸ºè¦è¿›è¡Œä¿®æ”¹ï¼Œè€Œåªè¯»çš„ä¸èƒ½ä¿®æ”¹ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * æ‹·è´ section å†…å®¹åˆ° pi-&gt;purgatory_buf */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kexec_purgatory_setup_sechdrs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pi, kbuf);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* ä¿®æ”¹ .rela.text ç­‰ sections ä¸­çš„é‡å®šä½æ¡ç›® */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kexec_apply_relocations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    arch_kexec_apply_relocations_add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>æ¨èé˜…è¯»ï¼š<a href="https://csstormq.github.io/blog/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%AF%87%E4%B9%8B%E9%93%BE%E6%8E%A5%EF%BC%885%EF%BC%89%EF%BC%9A%E9%87%8D%E5%AE%9A%E4%BD%8D" target="_blank" rel="noreferrer">è®¡ç®—æœºç³»ç»Ÿç¯‡ä¹‹é“¾æ¥ï¼ˆ5ï¼‰ï¼šé™æ€é“¾æ¥ï¼ˆä¸‹ï¼‰â€”â€”é‡å®šä½</a></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">â¯</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> readelf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> out/x86_64/arch/x86/purgatory/purgatory.ro</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Relocation</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Relocation</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> section</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.rela.text&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> at</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> offset</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x32e8</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> contains</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 98</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> entries:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Relocation</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> section</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.rela__patchable_function_entries&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> at</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> offset</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x3c18</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> contains</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 22</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> entries:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Relocation</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> section</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.rela.rodata&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> at</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> offset</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x3e48</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> contains</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> entries:</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="arch-x86-kernel-relocate-kernel-64-s" tabindex="-1">arch/x86/kernel/relocate_kernel_64.S <a class="header-anchor" href="#arch-x86-kernel-relocate-kernel-64-s" aria-label="Permalink to â€œarch/x86/kernel/relocate_kernel_64.Sâ€">â€‹</a></h3><h3 id="control-page" tabindex="-1">control page <a class="header-anchor" href="#control-page" aria-label="Permalink to â€œcontrol pageâ€">â€‹</a></h3><p>8KBï¼Œç¬¬ä¸€ä¸ª 4KB æ˜¯é¡µè¡¨ï¼Œç¬¬äºŒä¸ª 4KB ä¸­çš„å‰ 2KB æ˜¯ä»£ç ï¼Œå 2KB æ˜¯æ ˆã€‚</p><div class="language-cpp line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="kexec-on-panic" tabindex="-1">kexec on panic <a class="header-anchor" href="#kexec-on-panic" aria-label="Permalink to â€œkexec on panicâ€">â€‹</a></h2><p>crash kernel</p><h2 id="å…¶ä»–" tabindex="-1">å…¶ä»– <a class="header-anchor" href="#å…¶ä»–" aria-label="Permalink to â€œå…¶ä»–â€">â€‹</a></h2><ul><li>CONFIG_CRASH_HOTPLUG</li><li><a href="https://docs.kernel.org/next/kho/index.html" target="_blank" rel="noreferrer">Kexec Handover Subsystem â€” The Linux Kernel documentation</a><a href="https://www.phoronix.com/news/Kexec-HandOver-KHO-Linux-MM" target="_blank" rel="noreferrer">https://www.phoronix.com/news/Kexec-HandOver-KHO-Linux-MM</a><a href="https://www.phoronix.com/news/Google-Live-Update-Orchestrator" target="_blank" rel="noreferrer">https://www.phoronix.com/news/Google-Live-Update-Orchestrator</a><a href="https://lore.kernel.org/lkml/20250320024011.2995837-1-pasha.tatashin@soleen.com/" target="_blank" rel="noreferrer">https://lore.kernel.org/lkml/20250320024011.2995837-1-pasha.tatashin@soleen.com/</a><a href="https://lore.kernel.org/all/20250320015551.2157511-1-changyuanl@google.com/" target="_blank" rel="noreferrer">https://lore.kernel.org/all/20250320015551.2157511-1-changyuanl@google.com/</a> Kexec HandOverï¼ˆKHOï¼‰æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå…è®¸ Linux åœ¨ kexec è¿‡ç¨‹ä¸­ä¿ç•™çŠ¶æ€â€”â€”åŒ…æ‹¬ä»»æ„å±æ€§ä»¥åŠå†…å­˜ä½ç½®ã€‚ çœ‹èµ·æ¥æŒºç‰›çš„ï¼Œ <ul><li><a href="https://lpc.events/event/18/contributions/1732/attachments/1471/3116/lpc24-kexec-acpi_v3.pdf" target="_blank" rel="noreferrer">https://lpc.events/event/18/contributions/1732/attachments/1471/3116/lpc24-kexec-acpi_v3.pdf</a> å­—èŠ‚ STE å›¢é˜Ÿçš„å·¥ä½œï¼Œ</li><li><a href="https://lwn.net/Articles/924933/" target="_blank" rel="noreferrer">https://lwn.net/Articles/924933/</a> Parallel CPU bringup for x86_64</li><li><a href="https://lpc.events/event/17/contributions/1512/" target="_blank" rel="noreferrer">https://lpc.events/event/17/contributions/1512/</a><a href="https://lpc.events/event/17/contributions/1512/attachments/1256/2544/Fast%20Kernel%20Boot.pdf" target="_blank" rel="noreferrer">https://lpc.events/event/17/contributions/1512/attachments/1256/2544/Fast Kernel Boot.pdf</a></li><li><a href="https://kvmforum2022.sched.com/event/15jLX" target="_blank" rel="noreferrer">https://kvmforum2022.sched.com/event/15jLX</a> VF ä¸åœ</li></ul></li><li><a href="https://lwn.net/Articles/895453/" target="_blank" rel="noreferrer">Preserving guest memory across kexec [LWN.net]</a></li><li><a href="https://wangcong.org/2025-02-09-persistent-memory-in-linux-kexec.html" target="_blank" rel="noreferrer">https://wangcong.org/2025-02-09-persistent-memory-in-linux-kexec.html</a></li><li><a href="https://github.com/oscomp/proj135-seamless-kernel-upgrade" target="_blank" rel="noreferrer">https://github.com/oscomp/proj135-seamless-kernel-upgrade</a> æ²¡æƒ³åˆ°å­—èŠ‚ä¹Ÿæƒ³æåŒ OS çš„çƒ­å‡çº§ <a href="https://github.com/SmallPond/twinkernel" target="_blank" rel="noreferrer">https://github.com/SmallPond/twinkernel</a></li><li><a href="http://www.popcornlinux.org/" target="_blank" rel="noreferrer">http://www.popcornlinux.org/</a> çœ‹èµ·æ¥è´¼ nb å•Š</li><li><a href="https://github.com/kexecboot/kexecboot/wiki" target="_blank" rel="noreferrer">https://github.com/kexecboot/kexecboot/wiki</a></li><li><a href="https://iliana.fyi/blog/kexec-systemd-boot-kernel-image/" target="_blank" rel="noreferrer">https://iliana.fyi/blog/kexec-systemd-boot-kernel-image/</a></li><li><a href="https://lore.kernel.org/lkml/20220725083904.56552-1-huangjie.albert@bytedance.com/" target="_blank" rel="noreferrer">[PATCH 0/4] faster kexec reboot - Albert Huang</a> ä¸å‹ç¼© image</li><li><a href="https://archive.fosdem.org/2022/schedule/event/security_seamless_kernel/attachments/slides/5061/export/events/attachments/security_seamless_kernel/slides/5061/Seamless_Kernel_Update.pdf" target="_blank" rel="noreferrer">Seamless_Kernel_Update.pdf</a> CRIU checkpoint/restore apps</li><li><a href="https://lwn.net/ml/linux-kernel/20200814055239.47348-1-sangyan@huawei.com/" target="_blank" rel="noreferrer">[PATCH 1/2] kexec: Add quick kexec support for kernel [LWN.net]</a></li></ul><h2 id="å­¦åˆ°çš„ä¸€äº›-æ²¡æ—¶é—´æ€»ç»“-å…ˆåœ¨è¿™é‡Œè®°ä¸€ä¸‹" tabindex="-1">å­¦åˆ°çš„ä¸€äº›ï¼Œæ²¡æ—¶é—´æ€»ç»“ï¼Œå…ˆåœ¨è¿™é‡Œè®°ä¸€ä¸‹ <a class="header-anchor" href="#å­¦åˆ°çš„ä¸€äº›-æ²¡æ—¶é—´æ€»ç»“-å…ˆåœ¨è¿™é‡Œè®°ä¸€ä¸‹" aria-label="Permalink to â€œå­¦åˆ°çš„ä¸€äº›ï¼Œæ²¡æ—¶é—´æ€»ç»“ï¼Œå…ˆåœ¨è¿™é‡Œè®°ä¸€ä¸‹â€">â€‹</a></h2><ul><li>kexec -l å¹¶ä¸ä¼šåˆ†é…ä¸€æ•´å—è¿ç»­çš„å†…å­˜ï¼Œè€Œæ˜¯ç”³è¯·è®¸å¤šå•ä¸ª pageï¼Œå°†å†…æ ¸å’Œ initrd æ‹·è´è¿›å»ï¼Œå¹¶åˆ’åˆ†ä¸€å—å¤§çš„è¿ç»­ç‰©ç†å†…å­˜ï¼ˆä¸æ˜¯åˆ†é…ï¼Œæ˜¯åˆ’åˆ†ï¼Œè¿™å—è¿ç»­å¤§å†…å­˜æ­¤æ—¶æ˜¯æ­£åœ¨è¢«å½“å‰ OS ä½¿ç”¨ç€çš„ï¼‰ï¼Œåœ¨ kexec -e æ—¶ï¼Œä¼šå°†å†…æ ¸å’Œ initrd ä»è®¸å¤šä¸è¿ç»­çš„å•ä¸ªé¡µé¢ï¼Œæ‹·è´åˆ°è¯¥è¿ç»­å¤§å†…å­˜ã€‚ç„¶åæ‰§è¡Œè¯¥è¿ç»­å¤§å†…å­˜é‡Œçš„ä»£ç ã€‚</li><li>kdump.service ç­‰ç”¨æˆ·æ€çš„ kdump æœåŠ¡ï¼Œå…¶åŸç†å°±æ˜¯ kexec -pï¼Œæ²¡åšå•¥ç‰¹æ®Šçš„äº‹æƒ…ï¼Œå‘½ä»¤è¡Œå‚æ•°é‡Œä¸€èˆ¬ä¼šç¦ç”¨è®¸å¤šç‰¹æ€§ï¼Œæ¯”å¦‚ iommu ä¹‹ç±»ã€‚ kexec -p ä¾èµ–äºå†…æ ¸å·²ç»ç”¨ crashkernel é¢„ç•™äº†ä¸€å—è¿ç»­å†…å­˜ï¼ˆä¼š memblock_reserveï¼‰ï¼Œè¿™ä¸ªå†…å­˜å¯ä»¥ grep Crash /proc/iomem çœ‹åˆ°ã€‚ cat /proc/iomem çœ‹çš„æ˜¯å†…æ ¸çš„ iomem_resourceï¼ˆè¿™æ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼‰ï¼ŒCrash kernel å¯¹åº”çš„æ˜¯ crashk_resã€‚ å½“æ— æ³•ä» &lt;4G åˆ†é… crashkernel æ—¶ï¼Œä¼šç”¨åˆ° crashk_low_resã€‚</li><li>crash è¦è¯»åŸå…ˆ OS çš„å†…å­˜ï¼Œå¹¶ç”Ÿæˆ vmcoreï¼Œé‚£ crash æ˜¯å¦‚ä½•ç¡®ä¿åœ¨å¯åŠ¨æ—¶ä¸ä¼šè¸©åˆ°åŸå…ˆ OS çš„å†…å­˜çš„ï¼Ÿ ç­”ï¼šcrash çš„ e820 table æ˜¯ kexec -p æ—¶å®šåˆ¶çš„ã€‚ crash_setup_memmap_entries() ä¼šä» crashk_res ä¸­å»é™¤æ‰ elf header çš„éƒ¨åˆ†åï¼Œä½œä¸º E820_TYPE_RAMã€‚ æ³¨æ„ï¼Œä½ 1M ä¹Ÿä¼šè¢«ä½œä¸º E820_TYPE_RAMã€‚</li></ul></div></div></main><footer class="VPDocFooter" data-v-d668f7cc data-v-1bcd8184><!--[--><!--]--><div class="edit-info" data-v-1bcd8184><div class="edit-link" data-v-1bcd8184><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/hyuuko1/blog/edit/main/booting/kexec.md" target="_blank" rel="noreferrer" data-v-1bcd8184><!--[--><span class="vpi-square-pen edit-link-icon" data-v-1bcd8184></span> Edit this page<!--]--></a></div><div class="last-updated" data-v-1bcd8184><p class="VPLastUpdated" data-v-1bcd8184 data-v-73dafb42>æœ€åæ›´æ–°äº: <time datetime="2025-11-23T15:44:07.000Z" data-v-73dafb42></time></p></div></div><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter" data-v-304c8b69 data-v-5b9946f5><div class="container" data-v-5b9946f5><p class="message" data-v-5b9946f5>Licensed under MIT</p><p class="copyright" data-v-5b9946f5>Copyright Â© 2024-2025 HYUUKO</p></div></footer><!--[--><!--]--></div></div>
    
    
  </body>
</html>