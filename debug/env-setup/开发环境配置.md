##

- ğŸŒŸ https://github.com/FlorentRevest/linux-kernel-vscode
- [ä½¿ç”¨ QEMU è°ƒè¯•å†…æ ¸](http://www.owalle.com/2018/12/24/qemu-debug/)
  åé¢ä¹Ÿä»‹ç»äº†ç”¨ vscode
- [Linux kernel debug on macOS æ­å»ºå¯è§†åŒ–å†…æ ¸ debug ç¯å¢ƒ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/399857241)

## compile_commands.json

ç”¨ LLVM=1 ç¼–è¯‘ã€é“¾æ¥æ›´å¿«ï¼Œè€Œä¸”ç”Ÿæˆçš„ compile_commands.json ä¸éœ€è¦æ”¹ç¼–è¯‘é€‰é¡¹ã€‚

```bash
# å¯¹äºè¾ƒæ—§çš„å†…æ ¸ï¼Œä½¿ç”¨ intercept-build ç”Ÿæˆ compile_commands.json
# å…¶å®æŠŠæ–°å†…æ ¸çš„ scripts/clang-tools/gen_compile_commands.py å¤åˆ¶è¿‡æ¥ä¹Ÿèƒ½ç”¨å§
pip3 install scan-build
intercept-build make

# å¯¹äºè¾ƒæ–°çš„å†…æ ¸ï¼š

$ make O=out/x86_64 compile_commands.json -j16
# ä¸ºæŸä¸ªå†…éƒ¨æ¨¡å—ï¼Œåœ¨ out/x86_64/xx/xx ä¸‹ç”Ÿæˆ compile_commands.json
$ make O=out/x86_64 M=drivers/vdpa compile_commands.json
# ä¸ºæŸä¸ªå¤–éƒ¨æ¨¡å—ï¼Œåœ¨ /root/code/linux/xx/xx ä¸‹ç”Ÿæˆ compile_commands.json
$ make -C /usr/lib/modules/$(uname -r)/build M=/root/code/linux/drivers/vdpa compile_commands.json

# ç”±äºå¦‚æœæˆ‘ä»¬ä¿®æ”¹è¿‡æ–‡ä»¶ï¼Œmake å°±ä¼šé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œæ‰€ä»¥æˆ‘æ›´å»ºè®®ï¼š
$ cd out/x86_64
$ ../../scripts/clang-tools/gen_compile_commands.py


# ä¸ºäº†è®©clangdä¸æŠ¥é”™ï¼Œå¯ä»¥æŠŠ -m -f -W å¼€å¤´çš„é€‰é¡¹éƒ½åˆ æ‰ã€‚
# \S æŒ‡å•ä¸ªéç©ºå­—ç¬¦
$ sed -i "s/ -[mfW]\S*//g" out/x86_64/compile_commands.json

# åŠ ä¸Š .gdb_index sectionï¼Œè¿™æ · gdb è§¦å‘æ–­ç‚¹æ›´å¿«
$ gdb-add-index out/x86_64/vmlinux
# çœ‹ä¸€ä¸‹æœ‰æ— 
$ readelf -S out/x86_64/vmlinux | grep gdb_index
  [47] .gdb_index        PROGBITS         0000000000000000  0cb2faed


# è®© vscode keep track of æ‰€æœ‰ä»£ç æ–‡ä»¶
$ sudo bash -c 'echo "fs.inotify.max_user_watches=524288" >> /etc/sysctl.conf'
$ sudo sysctl -p
```

## .vscode/settings.json

```json
{
  "editor.formatOnSave": false,
  "editor.formatOnSaveMode": "modifications",
  "editor.trimAutoWhitespace": false,
  "editor.formatOnType": false,
  "files.trimFinalNewlines": false,
  "files.trimTrailingWhitespace": false,
  //   "editor.detectIndentation": false,
  "editor.tabSize": 8,
  "editor.insertSpaces": false,

  // éšè—ä¸€äº›æ–‡ä»¶
  "files.exclude": {
    "arch/{arm64,arm,ia64,loongarch,riscv,alpha,arc,c6x,csky,h8300,hexagon,m68k,microblaze,mips,nds32,nios2,openrisc,parisc,powerpc,s390,sh,sparc,um,xtensa}": true,
    "fs/{9p,bfs,configfs,ecryptfs,hugetlbfs,kernfs,nilfs2,openpromfs,qnx6,unicode,adfs,cramfs,efivarfs,gfs2,iomap,lockd,nls,orangefs,quota,sysv,vboxsf,affs,cachefiles,crypto,efs,f2fs,hfs,isofs,notify,overlayfs,tracefs,verity,afs,ceph,debugfs,erofs,hfsplus,jbd2,nfs,ntfs,reiserfs,ubifs,xfs,autofs,cifs,devpts,exfat,freevxfs,hostfs,jffs2,nfs_common,ocfs2,pstore,romfs,udf,zonefs,befs,coda,dlm,exportfs,fscache,hpfs,jfs,omfs,qnx4,squashfs,ufs}": true
    // "**/.cache": true
  },

  //
  "todo-tree.general.tags": [
    "BUG",
    "HACK",
    "FIXME",
    "TODO",
    "XXX",
    "- [ ]",
    "NOTE",
    "DKW", // Don't Know Why
    "MNOTE", // My Note
    "MTODO", // My TODO
    "MBUG" // Maybe BUG
  ],

  "restructuredtext.languageServer.disabled": true,
  "restructuredtext.linter.disabled": true,
  "restructuredtext.preview.sphinx.disabled": true,

  "clangd.arguments": [
    /* compile_commands.json æ‰€åœ¨ç›®å½• */
    "--compile-commands-dir=out/x86_64" /* out/aarch64 */,
    "--all-scopes-completion",
    /* åœ¨åå°è¿›è¡Œç´¢å¼•ï¼Œå¹¶æŒä¹…åŒ–åœ¨ç£ç›˜ä¸Šçš„ .cache ç›®å½• */
    "--background-index",
    "--background-index-priority=normal",
    "--clang-tidy",
    /* ä»£ç è¡¥å…¨ï¼šå¯¹ç›¸ä¼¼çš„æ¡ç›®è¿›è¡Œåˆå¹¶ */
    "--completion-style=bundled",
    /* æ²¡æœ‰ .clang-format æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨çš„é£æ ¼ */
    "--fallback-style=Google",
    /* å‡½æ•°è¡¥å…¨æ—¶ï¼Œåœ¨å‚æ•°ä½ç½®åŠ å ä½ç¬¦ */
    "--function-arg-placeholders",
    /* æ”¯æŒæ·»åŠ å¤´æ–‡ä»¶ */
    "--header-insertion=iwyu",
    /* è¾“å…¥å»ºè®®ä¸­ï¼Œå·²åŒ…å«å¤´æ–‡ä»¶çš„é¡¹ä¸è¿˜æœªåŒ…å«å¤´æ–‡ä»¶çš„é¡¹ä¼šä»¥åœ†ç‚¹åŠ ä»¥åŒºåˆ† */
    "--header-insertion-decorators",
    /* ä¸é™åˆ¶ clangd çš„è¿”å›ç»“æœæ•°é‡ã€‚é»˜è®¤æ˜¯ 100 */
    "--limit-results=0",
    "--limit-references=0",
    "--rename-file-limit=0",
    /* åœ¨å†…å­˜ä¸­å­˜å‚¨ PCHsï¼Œæ€§èƒ½æ›´å¥½ */
    "--pch-storage=memory",
    /* ä» YAML æ–‡ä»¶ä¸­è¯»å–ç”¨æˆ·é…ç½® */
    "--enable-config"
    // "--log=info",
    // "--pretty",
    // "-j=16",
  ],

  "todo-tree.tree.scanMode": "workspace only"
}
```

## ~/.config/clangd/config.yaml

```yaml
# https://clangd.llvm.org/config

# https://clang.llvm.org/docs/ClangCommandLineReference.html
# https://gcc.gnu.org/onlinedocs/gcc/Option-Index.html

Diagnostics:
  ClangTidy:
    Remove:
      # é¿å… Suspicious usage of 'sizeof(A*)'; pointer to aggregate
      - bugprone-sizeof-expression
  # æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„ include
  UnusedIncludes: Strict
```

## vscode linux kernel è°ƒè¯•æ–¹æ³•

`.vscode/launch.json`

```json
{
  // ä½¿ç”¨ IntelliSense äº†è§£ç›¸å…³å±æ€§ã€‚
  // æ‚¬åœä»¥æŸ¥çœ‹ç°æœ‰å±æ€§çš„æè¿°ã€‚
  // æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®: https://go.microsoft.com/fwlink/?linkid=830387
  "version": "0.2.0",
  "configurations": [
    {
      "name": "gdb",
      "type": "cppdbg",
      "request": "launch",
      "cwd": "${workspaceFolder}",
      "program": "${workspaceFolder}/out/x86_64/vmlinux",
      "stopAtEntry": true,
      "externalConsole": false,
      "internalConsoleOptions": "neverOpen",
      "MIMode": "gdb",
      "miDebuggerPath": "/usr/bin/gdb",
      "miDebuggerServerAddress": "localhost:1234",
      // https://www.ece.villanova.edu/VECR/doc/gdb/Mode-Options.html
      // -n ä¸æ‰§è¡Œä»»ä½• .gdbinit ï¼Ÿ
      "miDebuggerArgs": "-q",
      // https://sourceware.org/gdb/current/onlinedocs/gdb.html/GDB_002fMI.html
      "logging": { "engineLogging": true },
      "setupCommands": [
        {
          "description": "ä¸º gdb å¯ç”¨æ•´é½æ‰“å°",
          "text": "-enable-pretty-printing",
          "ignoreFailures": false
        },
        {
          "description": "å°†åæ±‡ç¼–é£æ ¼è®¾ç½®ä¸º Intel",
          "text": "-gdb-set disassembly-flavor intel",
          "ignoreFailures": false
        },
        {
          "description": "Enable autoloading of Linux GDB scripts",
          "text": "add-auto-load-safe-path ${workspaceFolder}/scripts/gdb",
          "ignoreFailures": true
        },
        {
          "description": "Format Locals as HEX by default",
          "text": "set output-radix 16",
          "ignoreFailures": true
        },
        /* æœ‰äº›ç‰ˆæœ¬çš„ vmlinux é‡Œçš„ debuginfo é‡Œçš„ source mapping å¯èƒ½æœ‰äº›é—®é¢˜ï¼Ÿ
           æºæ–‡ä»¶åœ°å€å˜æˆäº† out/x86_64/init/main.c è¿™é‡Œè¦åšä¸€ä¸‹æ›¿æ¢ */
        {
          "description": "è®¾ç½®åœ°å€æ›¿æ¢",
          "text": "set substitute-path out/x86_64 ${workspaceFolder}",
          "ignoreFailures": true
        }
      ],

      "postRemoteConnectCommands": [
        {
          "description": "Hardware breakpoint at start",
          "text": "-break-insert -t -h -f start_kernel",
          "ignoreFailures": false
        }
      ],

      // å…³äºç¡¬ä»¶æ–­ç‚¹ï¼Œè§ https://sourceware.org/gdb/current/onlinedocs/gdb.html/Set-Breaks.html
      "hardwareBreakpoints": {
        "require": false
      }
    }
  ]
}
```

è®¾ç½®å¿«æ·é”® ctrl f6
`@command:workbench.debug.viewlet.action.toggleBreakpointsActivatedAction`

1. è°ƒè¯•å‰ï¼Œå…ˆæŒ‰ Ctrl F6 é˜²æ­¢æ¿€æ´»æ–­ç‚¹ã€‚
2. æŒ‰ä¸‹ F5 å¼€å§‹è°ƒè¯•ã€‚æ­¤æ—¶ postRemoteConnectCommands ä¼šåœ¨ start_kernel å¤„æ‰“ç¡¬ä»¶æ–­ç‚¹
3. è¿è¡Œåˆ° start_kernel åï¼Œæ­¤æ—¶é¡µè¡¨å·²ç»å»ºç«‹èµ·æ¥äº†ï¼Œå†æŒ‰ Ctrl F6 æŠŠæˆ‘ä»¬è®¾ç½®çš„æ–­ç‚¹æ‰“ä¸Šã€‚
   è¿™æ˜¯å› ä¸ºæ‰“è½¯ä»¶æ–­ç‚¹çš„åŸç†æ˜¯æ›¿æ¢æŒ‡ä»¤ï¼Œå¦‚æœé¡µè¡¨è¿˜æœªå»ºç«‹ï¼Œé‚£ä¹ˆå°±æ”¹ä¸äº†æŒ‡ä»¤ï¼Œæ‰€ä»¥å»ºè®®åœ¨åˆ° start_kernel åå†æ¿€æ´»æ–­ç‚¹ã€‚

## ç”¨ gdb è°ƒè¯•

## .vscode/c_cpp_properties.json

å¦‚æœä½ ç¦ç”¨äº† clangdï¼Œè€Œä¸”è®¾ç½®äº† `"C_Cpp.intelliSenseEngine": "default"` é‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨ C/C++ æ’ä»¶æä¾›çš„ LSP ï¼Ÿæ€§èƒ½å¾ˆå·®ï¼Œä¸å»ºè®®ç”¨ã€‚

```json
{
  "configurations": [
    {
      "name": "Linux",
      "cStandard": "c11",
      "intelliSenseMode": "gcc-x64",
      "compileCommands": "${workspaceFolder}/out/x86_64/compile_commands.json"
    }
  ],
  "version": 4
}
```

##
